class PUploader extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.files=new Map,this.fieldSchema=null,this.draggedElement=null,this.draggedOverElement=null,this.XHRConstructor=null,this.eventBus=null,this.logger=null,this._render()}connectedCallback(){this._setupEventListeners(),this._loadFieldDefinitions(),this._loadExistingFiles(),setTimeout(()=>{this._validateFiles()},0)}disconnectedCallback(){this.abortController&&this.abortController.abort()}static get observedAttributes(){return["max-files","upload-action","update-action","delete-action","sequence-action","accept-types","max-file-size","allow-edit","allow-sort"]}get config(){const e=(e,t)=>this.getAttribute(e)||t,t=(e,t)=>parseInt(this.getAttribute(e))||t,a=e=>"false"!==this.getAttribute(e);return{maxFiles:t("max-files",5),uploadAction:e("upload-action","/upload"),updateAction:e("update-action","/update"),deleteAction:e("delete-action","/delete"),sequenceAction:e("sequence-action","/sequence"),inputName:e("input-name","files"),acceptTypes:e("accept-types","*/*"),maxFileSize:t("max-file-size",10485760),allowEdit:a("allow-edit"),allowSort:a("allow-sort")}}setXHR(e){this.XHRConstructor=e}setEventBus(e){this.eventBus=e}setLogger(e){this.logger=e}_getXHRConstructor(){return null===this.XHRConstructor&&(this.XHRConstructor=window.MockXHR||XMLHttpRequest),this.XHRConstructor}_loadFieldDefinitions(){const e=this.querySelector('p-uploader-fields[slot="field-definitions"]');if(!e)return this.logger,void(this.fieldSchema=this._getDefaultFields());const t=e.querySelectorAll("p-uploader-field");this.fieldSchema=new Map,t.forEach(e=>{const t=e.getAttribute("key"),a=e.getAttribute("label"),r=e.getAttribute("type")||"text",i=e.hasAttribute("required"),l=e.getAttribute("maxlength");t?this.fieldSchema.set(t,{key:t,label:a||t,type:r,required:i,maxlength:l?parseInt(l):null,element:e}):this.logger})}_validateFiles(){this.querySelectorAll("p-uploader-file").forEach(e=>{const t=e.querySelectorAll("p-uploader-data"),a=new Map;t.forEach(e=>{const t=e.getAttribute("key"),r=e.textContent.trim();if(!this.fieldSchema.has(t))return void this.logger;const i=this.fieldSchema.get(t);if(i.required&&!r&&this.logger,i.maxlength&&r.length>i.maxlength&&this.logger,"url"===i.type&&r)try{new URL(r)}catch{this.logger}a.set(t,r)}),this.fieldSchema.forEach((e,t)=>{e.required&&!a.has(t)&&this.logger}),e._fieldData=a,e._fieldSchema=this.fieldSchema,e._render&&e._render()})}_getDefaultFields(){return new Map([["title",{key:"title",label:"Title",type:"text",required:!1}],["caption",{key:"caption",label:"Caption",type:"textarea",required:!1}],["link",{key:"link",label:"Link",type:"url",required:!1}]])}getFieldSchema(){return this.fieldSchema}_render(){const e=this.getAttribute("accept-types")||"*/*";this.shadowRoot.innerHTML=`\n      <style>:host{border:2px solid #000;display:block;font-family:inherit;padding:.375rem;position:relative}.uploader__files{display:grid;gap:.375rem;margin-bottom:.375rem}.uploader__selector{background:#f8fafc;border:2px solid #cbd5e1;cursor:pointer;padding:2rem;text-align:center;transition:all .2s}.uploader__selector:hover{background:#f1f5f9;border-color:#94a3b8}.uploader__selector.dragover{background:#eff6ff;border-color:#3b82f6}.uploader__fileinput{display:none}.uploader__label{cursor:pointer;font-size:1rem}::slotted(p-uploader-file){display:block}::slotted(p-uploader-fields){display:none}</style>\n\n      <slot name="field-definitions"></slot>\n\n      <div class="uploader__files">\n        <slot></slot>\n      </div>\n\n      <div class="uploader__selector" part="selector">\n        <input type="file" multiple accept="${e}" class="uploader__fileinput" id="file-input">\n        <label class="uploader__label" for="file-input">\n          + Add files by selecting or dragging here\n        </label>\n      </div>\n    `}_setupEventListeners(){this.abortController=new AbortController;const e=this.abortController.signal,t=this.shadowRoot.querySelector(".uploader__fileinput"),a=this.shadowRoot.querySelector(".uploader__selector");t.addEventListener("change",e=>this._handleFileSelect(e),{signal:e}),a.addEventListener("dragover",e=>{if(this.draggedElement)return e.preventDefault(),void e.stopPropagation();e.preventDefault(),a.classList.add("dragover")},{signal:e}),a.addEventListener("dragleave",e=>{this.draggedElement||(e.preventDefault(),a.classList.remove("dragover"))},{signal:e}),a.addEventListener("drop",e=>{if(this.draggedElement)return e.preventDefault(),void e.stopPropagation();e.preventDefault(),a.classList.remove("dragover"),this._handleFileDrop(e)},{signal:e}),this.config.allowSort&&(this.addEventListener("dragover",e=>{this.draggedElement&&(e.preventDefault(),e.dataTransfer.dropEffect="move")},{signal:e}),this.addEventListener("dragstart",e=>this._handleDragStart(e),{signal:e}),this.addEventListener("dragend",e=>this._handleDragEnd(e),{signal:e}),this.addEventListener("dragenter",e=>this._handleDragEnter(e),{signal:e}),this.addEventListener("dragleave",e=>this._handleDragLeave(e),{signal:e}),this.addEventListener("drop",e=>this._handleDrop(e),{signal:e})),this.addEventListener("file:delete",e=>{const t=e.detail.fileId;t&&this.files.has(t)&&this.files.delete(t)},{signal:e})}_loadExistingFiles(){const e=this.querySelectorAll("p-uploader-file");e.forEach((t,a)=>{const r=t.getAttribute("file-id");r&&(this.files.set(r,{id:r,element:t,state:"uploaded",order:a}),this.config.allowSort&&e.length>1&&t.setAttribute("draggable","true"))})}_handleFileSelect(e){this._processFiles(Array.from(e.target.files)),e.target.value=""}_handleFileDrop(e){e.dataTransfer?.files?.length&&this._processFiles(Array.from(e.dataTransfer.files))}_processFiles(e){const t=this.querySelectorAll("p-uploader-file").length,a=this.config.maxFiles-t;if(a<=0)return void alert(`Maximum ${this.config.maxFiles} files allowed`);const r=e.slice(0,a);e.length>a&&alert(`Only ${a} more file${1===a?"":"s"} can be added (${this.config.maxFiles} max)`),r.forEach(e=>{this._uploadFile(e)})}async _uploadFile(e){const t=function(e="elem"){return`${e}-${Date.now()}-${Math.random().toString(36).slice(2,9)}`}("file"),a={id:t,file:e,state:"uploading",progress:0};this.files.set(t,a);const r=document.createElement("p-uploader-file");if(r.setAttribute("file-id",t),r.setAttribute("filename",e.name),r.setAttribute("state","uploading"),r.setAttribute("allow-edit",this.config.allowEdit),r._fieldSchema=this.fieldSchema,r._fieldData=new Map,a.element=r,this.appendChild(r),e.type.startsWith("image/"))try{const t=await this._createThumbnail(e,240,240);r.setAttribute("preview",t)}catch(e){this.logger}this._performUpload(a)}_performUpload(e){const t=new FormData;t.append("file",e.file);const a=new(this._getXHRConstructor());a.upload.addEventListener("progress",t=>{if(t.lengthComputable){const a=t.loaded/t.total*100;e.progress=a,e.element.setAttribute("progress",Math.round(a))}}),a.addEventListener("load",()=>{if(200===a.status)try{const t=JSON.parse(a.responseText);this._handleUploadSuccess(e,t)}catch(t){this._handleUploadError(e,"Invalid server response")}else this._handleUploadError(e,a.responseText||"Upload failed")}),a.addEventListener("error",()=>{this._handleUploadError(e,"Network error")}),a.open("POST",this.config.uploadAction),a.send(t)}_handleUploadSuccess(e,t){e.state="uploaded",e.serverData=t,e.element.setAttribute("state","uploaded"),t.preview&&e.element.setAttribute("preview",t.preview),t.id&&e.element.setAttribute("file-id",t.id),this._updateDraggableState(),this.dispatchEvent(new CustomEvent("upload:success",{detail:{fileId:e.id,response:t},bubbles:!0}))}_handleUploadError(e,t){e.state="error",e.error=t,e.element.setAttribute("state","error"),e.element.setAttribute("error",t),this.dispatchEvent(new CustomEvent("upload:error",{detail:{fileId:e.id,error:t},bubbles:!0}))}_updateDraggableState(){if(!this.config.allowSort)return;const e=this.querySelectorAll("p-uploader-file"),t=e.length>1;e.forEach(e=>{const a=e.getAttribute("data-current-panel")||"info";t&&!("info"!==a)?e.setAttribute("draggable","true"):e.removeAttribute("draggable")})}_handleDragStart(e){const t=e.target.closest("p-uploader-file");if(t&&t.hasAttribute("draggable")){this.draggedElement=t,e.dataTransfer.effectAllowed="move",this.originalFileOrder=Array.from(this.querySelectorAll("p-uploader-file"));try{document.selection?document.selection.empty():window.getSelection().removeAllRanges()}catch(e){}setTimeout(()=>{this.draggedElement&&t.setAttribute("dragging","")},0)}}_handleDragEnd(e){if(!this.draggedElement)return;this.draggedElement.removeAttribute("dragging");this.querySelectorAll("p-uploader-file").forEach(e=>e.removeAttribute("drag-over")),this.draggedElement=null,this.draggedOverElement=null}_handleDragEnter(e){if(!this.draggedElement)return;const t=e.target.closest("p-uploader-file");if(!t||t===this.draggedElement)return;if(t===this.draggedOverElement)return;this.draggedOverElement&&this.draggedOverElement.removeAttribute("drag-over"),t.setAttribute("drag-over",""),this.draggedOverElement=t;const a=Array.from(this.querySelectorAll("p-uploader-file")),r=a.indexOf(this.draggedElement),i=a.indexOf(t);-1!==i&&(i>r?t.parentNode.insertBefore(this.draggedElement,t.nextSibling):t.parentNode.insertBefore(this.draggedElement,t))}_handleDragLeave(e){if(!this.draggedElement)return;const t=e.target.closest("p-uploader-file");t&&(t!==this.draggedOverElement||t.contains(e.relatedTarget)||(t.removeAttribute("drag-over"),this.draggedOverElement=null))}_handleDrop(e){this.draggedElement&&(e.preventDefault(),e.stopPropagation(),this._updateSequence())}async _updateSequence(){const e=Array.from(this.querySelectorAll("p-uploader-file")).map(e=>e.getAttribute("file-id")).filter(e=>null!==e);try{const t=await fetch(this.config.sequenceAction,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sequence:e})});if(t.ok)this.originalFileOrder=null,this.dispatchEvent(new CustomEvent("sequence:update",{detail:{sequence:e},bubbles:!0}));else{this.originalFileOrder&&this._revertSequence();await t.text();this.logger}}catch(e){this.originalFileOrder&&this._revertSequence(),this.logger}}_revertSequence(){if(!this.originalFileOrder)return;const e=document.createDocumentFragment();this.originalFileOrder.forEach(t=>{t.parentNode&&t.parentNode.removeChild(t),e.appendChild(t)});const t=this.shadowRoot.querySelector(".uploader__selector");this.insertBefore(e,t),this.originalFileOrder=null}async _createThumbnail(e,t,a){return new Promise((r,i)=>{const l=new FileReader;l.onload=l=>{const o=new Image;o.onload=()=>{const i=Math.min(t/o.width,a/o.height,1),l=o.width*i,n=o.height*i,s=document.createElement("canvas");s.width=l,s.height=n,s.getContext("2d").drawImage(o,0,0,l,n),r(s.toDataURL(e.type||"image/jpeg",.9))},o.onerror=()=>i(new Error("Failed to load image")),o.src=l.target.result},l.onerror=()=>i(new Error("Failed to read file")),l.readAsDataURL(e)})}}class PUploaderFile extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this._fieldSchema=null,this._fieldData=new Map,this._render()}static get observedAttributes(){return["state","progress","preview","error","filename","allow-edit","data-current-panel"]}attributeChangedCallback(e,t,a){t!==a&&("data-current-panel"===e?this._updatePanelVisibility(a):"state"===e?this._updateState(a):"preview"===e?this._updatePreview(a):"progress"===e?this._updateProgress(a):this._render())}_render(){const e=this.getAttribute("state")||"uploaded",t=parseInt(this.getAttribute("progress"))||0,a=this.getAttribute("preview")||"",r=this.getAttribute("error")||"",i=this.getAttribute("filename")||"",l="false"!==this.getAttribute("allow-edit"),o=this.getAttribute("data-current-panel")||"info";this.querySelector("p-uploader-data")&&!this._fieldData.size&&this._loadFieldData(),this.shadowRoot.innerHTML=`\n      <style>*,:after,:before{box-sizing:border-box}:host{background:#fff;border:2px solid #000;display:block;font-family:inherit;padding:.375rem;position:relative;transition:border-color .2s ease-out,background-color .2s ease-out}:host([dragging]){opacity:.5;transition:none}:host([drag-over]){background:#eff6ff;border-color:#3b82f6;transform:translateY(-4px)}:host([draggable=true]){cursor:grab;user-select:none;-webkit-user-select:none}:host([draggable=true]:active){cursor:grabbing}button,input,textarea{font-family:inherit}.uploader__overlay{align-items:center;background:hsla(0,0%,100%,.95);display:flex;inset:0;justify-content:center;opacity:0;padding:0 .375rem 0 6.75rem;pointer-events:none;position:absolute;transition:opacity .375s cubic-bezier(.5,0,0,1);z-index:10}.uploader__overlay--show{opacity:1;pointer-events:auto}.uploader__progress{height:.5rem;width:100%}.uploader__container{display:flex;gap:.375rem;position:relative}.uploader__preview{flex-shrink:0;height:6rem;pointer-events:none;user-select:none;width:6rem}.uploader__preview img{height:100%;object-fit:cover;width:100%}.uploader__content{flex:1;min-width:0;overflow:hidden;position:relative}.uploader__content,.uploader__panel{display:flex;flex-direction:column;height:6rem}.uploader__panel{background:#fff;left:0;pointer-events:auto;position:absolute;right:0;top:0;transform:translateY(-100%);transition:transform .375s cubic-bezier(.5,0,0,1);will-change:transform}.uploader__panel--show{transform:translateY(0)}.uploader__panel[data-panel=info]{transform:translateY(100%)}.uploader__panel[data-panel=info].uploader__panel--activated{transform:translateY(-100%)}.uploader__panel[data-panel=info].uploader__panel--show{transform:translateY(0)}.uploader__panel[data-panel=delete],.uploader__panel[data-panel^=edit-]{transform:translateY(100%)}.uploader__panel[data-panel=delete].uploader__panel--show,.uploader__panel[data-panel^=edit-].uploader__panel--show{transform:translateY(0)}.uploader__alert,.uploader__body{align-items:center;display:flex;flex:1;flex-direction:row;min-height:6rem;position:relative}.uploader__alert{justify-content:space-between}.uploader__fields{display:flex;flex-direction:column}.uploader__filename,.uploader__heading{align-items:center;display:flex;font-size:.75rem;font-weight:600;height:1.125rem;line-height:1.125rem;margin:0 0 .5rem;padding-right:2rem}.uploader__filename{font-family:monospace}.uploader__field{align-items:center;display:flex;gap:.375rem;height:1.25rem;justify-content:flex-start;margin:0;padding-bottom:.1875rem;padding-top:.1875rem}.uploader__delete-icon{background-color:#fff;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24'%3E%3Cpath fill='none' d='M0 0h24v24H0V0z'/%3E%3Cpath fill='red' d='M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zm2.46-7.12 1.41-1.41L12 12.59l2.12-2.12 1.41 1.41L13.41 14l2.12 2.12-1.41 1.41L12 15.41l-2.12 2.12-1.41-1.41L10.59 14l-2.13-2.12zM15.5 4l-1-1h-5l-1 1H5v2h14V4z'/%3E%3Cpath fill='none' d='M0 0h24v24H0z'/%3E%3C/svg%3E");background-position:50%;background-repeat:no-repeat;background-size:contain;border:none;cursor:pointer;height:1.25rem;opacity:.6;padding:0;pointer-events:auto;position:absolute;right:0;top:0;transition:opacity .2s;width:1.25rem}.uploader__delete-icon:hover{opacity:1}.uploader__actions{display:flex;gap:.375rem;justify-content:flex-end;padding-left:.375rem}.uploader__btn{background:#fff;border:1px solid #cbd5e1;cursor:pointer;flex-shrink:0;font-size:.75rem;padding:.375rem .75rem;pointer-events:auto;transition:all .2s}.uploader__btn:hover{background:#f1f5f9}.uploader__btn--secondary{background:transparent;border-color:currentColor}.uploader__btn--delete{border-color:#dc2626;color:#dc2626}.uploader__btn--delete:hover{background:#fee2e2}.uploader__btn--primary{background:#3b82f6;border-color:#3b82f6;color:#fff}.uploader__btn--primary:hover{background:#2563eb}.uploader__input,.uploader__textarea{border:1px solid #cbd5e1;flex:1 0 auto;font-family:inherit;font-size:.75rem;height:100%;margin:0;outline:0 none;padding:.375rem;pointer-events:auto}.uploader__textarea{min-height:60px;resize:vertical}.field__label{flex:0 0 4rem;font-weight:600}.field__label,.field__value{font-size:.75rem;opacity:rgba(0,0,0,.5)}.field__value{flex:0 1 auto;height:1.25rem;line-height:1.25rem;overflow:hidden;text-overflow:ellipsis;word-break:break-word}.field__value--editable{cursor:pointer}.field__value--editable:hover{opacity:1;text-decoration:underline}.field__edit{background-color:#fff;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24'%3E%3Cpath d='M3 17.25V21h3.75L17.81 9.94l-3.75-3.75zM20.71 7.04a.996.996 0 0 0 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75z'/%3E%3Cpath fill='none' d='M0 0h24v24H0z'/%3E%3C/svg%3E");background-position:50%;background-repeat:no-repeat;background-size:contain;border:none;cursor:pointer;flex-shrink:0;height:1.25rem;opacity:.6;padding:0;pointer-events:auto;transition:opacity .2s;width:1.25rem}.field__edit:hover{opacity:1}.error-message{background:#fee2e2;color:#dc2626;font-size:.75rem;padding:.5rem}slot{display:none}\n      .uploader__preview {\n        display: ${a?"block":"none"};\n      }\n      </style>\n\n      <slot></slot>\n\n      <div class="uploader__overlay ${"uploading"===e?"uploader__overlay--show":""}">\n        <progress class="uploader__progress" max="100" value="${t}"></progress>\n      </div>\n\n      <div class="uploader__container">\n        <picture class="uploader__preview">\n          <img src="${a||""}" alt="${i}">\n        </picture>\n\n        <div class="uploader__content">\n          <div data-panel="error" class="uploader__panel ${"error"===o||"error"===e?"uploader__panel--show":""}" role="alert" aria-live="assertive">\n            <div class="uploader__alert">\n              <div class="error-message">${r}</div>\n              <div class="uploader__actions">\n                ${"error"===e?'<button class="uploader__btn uploader__btn--delete" data-action="confirm-delete" aria-label="Remove file">Remove</button>':'<button class="uploader__btn uploader__btn--secondary" data-action="cancel" aria-label="Cancel">Cancel</button>'}\n              </div>\n            </div>\n          </div>\n\n          <div data-panel="info" class="uploader__panel ${"info"===o&&"uploaded"===e?"uploader__panel--show":""}" role="region" aria-label="File information for ${i}">\n            <div class="uploader__body">\n              ${l?'<button class="uploader__delete-icon" data-action="show-delete" title="Delete file" aria-label="Delete file"></button>':""}\n              <div class="uploader__fields">\n                <h1 class="uploader__filename">${i}</h1>\n                ${"uploaded"===e?this._renderFields(l):""}\n              </div>\n            </div>\n          </div>\n\n          ${"uploaded"===e?this._renderEditPanels():""}\n\n          <div data-panel="delete" class="uploader__panel ${"delete"===o?"uploader__panel--show":""}" role="dialog" aria-labelledby="delete-heading-${i}">\n            <div class="uploader__alert">\n              <h2 id="delete-heading-${i}" class="uploader__heading">Delete this file?</h2>\n              <div class="uploader__actions">\n                <button class="uploader__btn uploader__btn--delete" data-action="confirm-delete" aria-label="Confirm delete">Delete</button>\n                <button class="uploader__btn uploader__btn--secondary" data-action="cancel" aria-label="Cancel delete">Cancel</button>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    `,this._setupFileEventListeners()}_loadFieldData(){this.querySelectorAll("p-uploader-data").forEach(e=>{const t=e.getAttribute("key"),a=e.textContent.trim();t&&this._fieldData.set(t,a)})}_renderFields(e){if(!this._fieldSchema||0===this._fieldSchema.size)return"";let t="";return this._fieldSchema.forEach((a,r)=>{const i=this._fieldData.get(r)||"";t+=`\n        <div class="uploader__field">\n          <label class="field__label">${a.label}</label>\n          <span class="field__value ${e?"field__value--editable":""}" ${e?`data-action="edit-field" data-field="${r}"`:""}>${i||"<em>-</em>"}</span>\n          ${e?`<button class="field__edit" data-action="edit-field" data-field="${r}" title="Edit ${a.label}"></button>`:""}\n        </div>\n      `}),t}_renderEditPanels(){if(!this._fieldSchema||0===this._fieldSchema.size)return"";const e=this.getAttribute("data-current-panel")||"info";let t="";return this._fieldSchema.forEach((a,r)=>{const i=this._fieldData.get(r)||"";t+=`\n        <div data-panel="edit-${r}" class="uploader__panel ${e===`edit-${r}`?"uploader__panel--show":""}" role="dialog" aria-label="Edit ${a.label}">\n          <div class="uploader__body">\n            ${"textarea"===a.type?`<textarea class="uploader__textarea" name="${r}" placeholder="${a.label}" rows="3" aria-label="${a.label}">${i}</textarea>`:`<input type="${a.type}" class="uploader__input" name="${r}" placeholder="${a.label}" value="${i}" aria-label="${a.label}">`}\n            <div class="uploader__actions">\n              <button class="uploader__btn uploader__btn--primary" data-action="confirm-edit" data-field="${r}" aria-label="Save ${a.label}">Save</button>\n              <button class="uploader__btn uploader__btn--secondary" data-action="cancel" aria-label="Cancel editing">Cancel</button>\n            </div>\n          </div>\n        </div>\n      `}),t}_updatePanelVisibility(e){const t=this.shadowRoot.querySelectorAll(".uploader__panel"),a=this.shadowRoot.querySelector('.uploader__panel[data-panel="info"]');t.forEach(t=>{const r=t.getAttribute("data-panel");r===e||"error"===r&&"error"===this.getAttribute("state")||"info"===r&&"info"===e&&"uploaded"===this.getAttribute("state")?(t.classList.add("uploader__panel--show"),"info"===r&&a&&a.classList.add("uploader__panel--activated")):t.classList.remove("uploader__panel--show")})}_updateState(e){const t=this.shadowRoot.querySelector(".uploader__overlay");"uploading"===e?t&&t.classList.add("uploader__overlay--show"):"uploaded"===e?(t&&t.classList.remove("uploader__overlay--show"),this._renderInfoPanelFields(),setTimeout(()=>{this.setAttribute("data-current-panel","info")},375)):"error"===e&&(t&&t.classList.remove("uploader__overlay--show"),this.setAttribute("data-current-panel","error"))}_updatePreview(e){const t=this.shadowRoot.querySelector(".uploader__preview");if(t)if(e){t.style.display="block";const a=t.querySelector("img");a&&(a.src=e)}else t.style.display="none"}_updateProgress(e){const t=this.shadowRoot.querySelector(".uploader__progress");t&&(t.value=parseInt(e)||0)}_updateFieldDisplay(e,t){const a=this.shadowRoot.querySelector('.uploader__panel[data-panel="info"]');if(a){const r=a.querySelector(`[data-field="${e}"].field__value`);r&&(r.innerHTML=t||"<em>-</em>")}}_renderInfoPanelFields(){if(!this._fieldSchema||0===this._fieldSchema.size)return;const e="false"!==this.getAttribute("allow-edit"),t=this.shadowRoot.querySelector('.uploader__panel[data-panel="info"]'),a=t?.querySelector(".uploader__fields");if(!a)return;const r=this._renderFields(e),i=a.querySelector(".uploader__filename");if(i){a.querySelectorAll(".uploader__field").forEach(e=>e.remove()),i.insertAdjacentHTML("afterend",r)}this._renderEditPanelsIfNeeded()}_renderEditPanelsIfNeeded(){if(!this._fieldSchema||0===this._fieldSchema.size)return;if(this.shadowRoot.querySelector('.uploader__panel[data-panel^="edit-"]'))return;const e=this.shadowRoot.querySelector('.uploader__panel[data-panel="delete"]');if(!e)return;const t=this._renderEditPanels();e.insertAdjacentHTML("beforebegin",t)}_setupFileEventListeners(){this.shadowRoot.removeEventListener("click",this._clickHandler),this._escapeKeyHandler&&this.removeEventListener("keydown",this._escapeKeyHandler),this._enterKeyHandler&&this.shadowRoot.removeEventListener("keydown",this._enterKeyHandler),this._clickHandler=e=>{const t=e.target.dataset.action;if(!t)return;const a={"edit-field":()=>this._setPanel(`edit-${e.target.dataset.field}`),"show-delete":()=>this._setPanel("delete"),cancel:()=>this._setPanel("info"),"confirm-edit":()=>this._handleConfirmEdit(e.target.dataset.field),"confirm-delete":()=>this._handleConfirmDelete()};a[t]?.()},this._escapeKeyHandler=e=>{const t=this.getAttribute("data-current-panel")||"info";"Escape"===e.key&&"info"!==t&&"error"!==t&&(e.preventDefault(),this._setPanel("info"))},this._enterKeyHandler=e=>{const t=this.getAttribute("data-current-panel")||"info";if("Enter"===e.key&&"INPUT"===e.target.tagName&&t.startsWith("edit-")){e.preventDefault();const a=t.replace("edit-","");this._handleConfirmEdit(a)}},this.shadowRoot.addEventListener("click",this._clickHandler),this.addEventListener("keydown",this._escapeKeyHandler),this.shadowRoot.addEventListener("keydown",this._enterKeyHandler)}_setPanel(e){this.setAttribute("data-current-panel",e),this._notifyDraggableStateChange(),"info"!==e&&"error"!==e?(this.setAttribute("tabindex","-1"),this.focus()):this.removeAttribute("tabindex"),e.startsWith("edit-")&&setTimeout(()=>{const t=e.replace("edit-",""),a=this.shadowRoot.querySelector(`[name="${t}"]`);a&&(a.focus(),"INPUT"===a.tagName&&a.select())},400)}_notifyDraggableStateChange(){const e=this.closest("p-uploader");e&&e._updateDraggableState&&e._updateDraggableState()}async _handleConfirmEdit(e){const t=this.shadowRoot.querySelector(`[name="${e}"]`);if(t){const a=t.value,r=this._fieldData.get(e)||"";this._fieldData.set(e,a);let i=this.querySelector(`p-uploader-data[key="${e}"]`);i||(i=document.createElement("p-uploader-data"),i.setAttribute("key",e),this.appendChild(i));const l=i.textContent;i.textContent=a;const o=this.closest("p-uploader");if(o&&o.config.updateAction)try{const t=await fetch(o.config.updateAction,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:this.getAttribute("file-id"),field:e,value:a})});if(t.ok)this._updateFieldDisplay(e,a),this.dispatchEvent(new CustomEvent("file:update",{detail:{fileId:this.getAttribute("file-id"),field:e,value:a},bubbles:!0,composed:!0})),this.setAttribute("data-current-panel","info"),this._notifyDraggableStateChange();else{this._fieldData.set(e,r),i.textContent=l;const a=await t.text();o.logger&&o.logger.error("Failed to update field:",a),this.setAttribute("error",`Update failed: ${a||"Server error"}`),this.setAttribute("data-current-panel","error")}}catch(t){this._fieldData.set(e,r),i.textContent=l,o.logger&&o.logger.error("Failed to update field:",t),this.setAttribute("error",`Update failed: ${t.message||"Network error"}`),this.setAttribute("data-current-panel","error")}else this.setAttribute("data-current-panel","info"),this._notifyDraggableStateChange()}}async _handleConfirmDelete(){const e=this.closest("p-uploader"),t=this.getAttribute("file-id"),a=this.getAttribute("state");if("error"!==a&&"uploading"!==a)if(e&&e.config.deleteAction)try{const a=await fetch(e.config.deleteAction,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:t})});if(a.ok)this._removeFile(),this.dispatchEvent(new CustomEvent("file:delete",{detail:{fileId:t},bubbles:!0,composed:!0}));else{const t=await a.text();e.logger&&e.logger.error("Failed to delete file:",t),this.setAttribute("error",`Delete failed: ${t||"Server error"}`),this.setAttribute("data-current-panel","error")}}catch(t){e.logger&&e.logger.error("Failed to delete file:",t),this.setAttribute("error",`Delete failed: ${t.message||"Network error"}`),this.setAttribute("data-current-panel","error")}else this._removeFile();else this._removeFile()}_removeFile(){const e=this.closest("p-uploader"),t=this.getAttribute("file-id");e&&t&&e.files.has(t)&&e.files.delete(t),this.remove(),e&&e._updateDraggableState&&e._updateDraggableState()}}class PUploaderFields extends HTMLElement{}class PUploaderField extends HTMLElement{}class PUploaderData extends HTMLElement{}customElements.get("p-uploader")||customElements.define("p-uploader",PUploader),customElements.get("p-uploader-file")||customElements.define("p-uploader-file",PUploaderFile),customElements.get("p-uploader-fields")||customElements.define("p-uploader-fields",PUploaderFields),customElements.get("p-uploader-field")||customElements.define("p-uploader-field",PUploaderField),customElements.get("p-uploader-data")||customElements.define("p-uploader-data",PUploaderData);export{PUploaderData,PUploaderField,PUploaderFields,PUploaderFile,PUploader as default};

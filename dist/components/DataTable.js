function e(e){return e.replace(/-([a-z])/g,e=>e[1].toUpperCase())}function t(e=document){return Array.from(e.querySelectorAll(["a[href]","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])",'[tabindex]:not([tabindex="-1"]):not([disabled])'].join(",")))}class BaseComponent{constructor({eventBus:e,logger:t,router:r}){this.eventBus=e,this.logger=t,this.router=r,this.elements=new WeakMap,this.states=this.elements,this._keys=null}mount(e){if(this.elements.has(e))return this.update(e);const t=this._init(e);this.elements.set(e,t)}update(e){}unmount(e){const t=this.elements.get(e);if(t)try{t.cleanup?.()}finally{this.elements.delete(e)}}destroy(){for(const e of this._elementsKeys())this.unmount(e)}_elementsKeys(){return this._keys||(this._keys=new Set),this._keys}_track(e){this._keys||(this._keys=new Set),this._keys.add(e)}_untrack(e){this._keys?.delete(e)}_init(e){const t=new AbortController;return this._track(e),{cleanup:()=>{t.abort(),this._untrack(e)},controller:t}}getState(e){return this.elements.get(e)}_getDataAttr(t,r,n){return function(t,r,n){const s=r.includes("-")?e(r):r,a=t.dataset[s];return void 0===a?n:"true"===a||"false"!==a&&(isNaN(a)||""===a?a:Number(a))}(t,r,n)}_camelCase(t){return e(t)}_debounce(e,t=300){return function(e,t=300){let r;return function(...n){clearTimeout(r),r=setTimeout(()=>{clearTimeout(r),e.apply(this,n)},t)}}(e,t)}_throttle(e,t=100){return function(e,t=100){let r;return function(...n){r||(e.apply(this,n),r=!0,setTimeout(()=>{r=!1},t))}}(e,t)}_delay(e){return function(e){return new Promise(t=>setTimeout(t,e))}(e)}_getTargetElement(e,t,r={}){const n=`${t}-view`,s=this.getAttr(e,n);if(s){const e=document.querySelector(`[data-view="${s}"]`);return!e&&r.required,e}const a=this.getAttr(e,t);if(!a)return r.required,null;const o=document.querySelector(a);return!o&&r.required,o}_getConfigFromAttrs(e,t){const r={};for(const[n,s]of Object.entries(t)){const t=this.constructor.defaults?.[n];r[n]=this.getAttr(e,s,t)}return r}_requireState(e,t="method"){return this.getState(e)}_generateId(e="elem"){return function(e="elem"){return`${e}-${Date.now()}-${Math.random().toString(36).slice(2,9)}`}(e)}async _waitForTransition(e,t=2e3){return async function(e,t=2e3){return new Promise(r=>{const n=()=>{e.removeEventListener("animationend",n),e.removeEventListener("transitionend",n),r()};e.addEventListener("animationend",n,{once:!0}),e.addEventListener("transitionend",n,{once:!0}),setTimeout(()=>{e.removeEventListener("animationend",n),e.removeEventListener("transitionend",n),r()},t)})}(e,t)}async _fadeIn(e,t=300){return async function(e,t=300){return e.style.opacity="0",e.style.transition=`opacity ${t}ms ease-in-out`,e.offsetHeight,e.style.opacity="1",new Promise(r=>{setTimeout(()=>{e.style.transition="",r()},t)})}(e,t)}async _fadeOut(e,t=300){return async function(e,t=300){return e.style.opacity="1",e.style.transition=`opacity ${t}ms ease-in-out`,e.offsetHeight,e.style.opacity="0",new Promise(r=>{setTimeout(()=>{e.style.transition="",r()},t)})}(e,t)}_getFocusableElements(e=document){return t(e)}_trapFocus(e,r){return function(e,r){const n=t(e);if(!n.length)return;const s=n[0],a=n[n.length-1],o=e.contains(document.activeElement)?document.activeElement:null;!r.shiftKey||o!==s&&o?r.shiftKey||o!==a||(s.focus(),r.preventDefault()):(a.focus(),r.preventDefault())}(e,r)}_restoreFocus(e){return function(e){e&&"function"==typeof e.focus&&requestAnimationFrame(()=>e.focus())}(e)}_createElement(e,t={},r=""){return function(e,t={},r=""){const n=document.createElement(e);for(const[e,r]of Object.entries(t))"className"===e||"class"===e?n.className=r:"style"===e&&"object"==typeof r?Object.assign(n.style,r):"dataset"===e&&"object"==typeof r?Object.assign(n.dataset,r):n.setAttribute(e,r);return"string"==typeof r?n.textContent=r:r instanceof HTMLElement&&n.appendChild(r),n}(e,t,r)}_dispatch(e,t,r){const n=new CustomEvent(t,{detail:r,bubbles:!0,cancelable:!0});return e.dispatchEvent(n),this.eventBus?.emit(t,{element:e,...r}),n}_getSelector(){if(this._selector)return this._selector;const e=this.constructor.name.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase();return this._selector=`data-${e}`,this._selector}setState(e,t){e.setAttribute(this._getSelector(),t)}getElementState(e){return e.getAttribute(this._getSelector())}setAttr(e,t,r){e.setAttribute(`${this._getSelector()}-${t}`,String(r))}getAttr(e,t,r=null){const n=e.getAttribute(`${this._getSelector()}-${t}`);return null!==n?n:r}removeAttr(e,t){e.removeAttribute(`${this._getSelector()}-${t}`)}hasAttr(e,t){return e.hasAttribute(`${this._getSelector()}-${t}`)}}const r="mounted",n="error",s="loading",a="loaded";function o(e,t={},r=""){const n=document.createElement(e);for(const[e,r]of Object.entries(t))"className"===e||"class"===e?n.className=r:"style"===e&&"object"==typeof r?Object.assign(n.style,r):"dataset"===e&&"object"==typeof r?Object.assign(n.dataset,r):n.setAttribute(e,r);return"string"==typeof r?n.textContent=r:r instanceof HTMLElement&&n.appendChild(r),n}class DataTable extends BaseComponent{_getSelector(){return"data-datatable"}static get defaults(){return{sortable:!0,filterable:!1,paginate:!1,pageSize:10,searchDelay:300,sortIcons:{unsorted:"↕",asc:"↑",desc:"↓"}}}constructor(e={}){super(e),this.searchTimeout=null}_init(e){const t=super._init(e);this.setState(e,r);const n=this._getConfiguration(e),s=Array.from(e.querySelectorAll("tbody tr"));return t.config=n,t.originalRows=s,t.filteredRows=[...s],t.currentSort={column:null,direction:null},t.currentPage=1,t.searchTerm="",t.errorMessage=null,n.sortable&&this._setupSorting(e,t),n.filterable&&this._setupFiltering(e,t),n.paginate&&this._setupPagination(e,t),this._render(e,t),this.eventBus?.emit("datatable:mounted",{element:e,config:n}),t}_getConfiguration(e){return{sortable:this.getAttr(e,"sortable",DataTable.defaults.sortable),filterable:this.getAttr(e,"filterable",DataTable.defaults.filterable),paginate:parseInt(this.getAttr(e,"paginate",DataTable.defaults.paginate))||!1,pageSize:parseInt(this.getAttr(e,"page-size",DataTable.defaults.pageSize)),searchDelay:parseInt(this.getAttr(e,"search-delay",DataTable.defaults.searchDelay))}}_setupSorting(e,t){e.querySelectorAll("th[data-sort]").forEach(r=>{r.style.cursor="pointer",r.classList.add("sortable");const n=o("span",{className:"sort-icon"},DataTable.defaults.sortIcons.unsorted);r.appendChild(n),r.addEventListener("click",()=>{this._handleSort(e,t,r)})})}_setupFiltering(e,t){const r=function(e="elem"){return`${e}-${Date.now()}-${Math.random().toString(36).slice(2,9)}`}("datatable-search"),n=o("label",{className:"form__label",htmlFor:r},"Search:"),s=o("input",{type:"text",id:r,placeholder:"Search table...",className:"form__control datatable-search"}),a=function(e,t=300){let r;return function(...n){clearTimeout(r),r=setTimeout(()=>{clearTimeout(r),e.apply(this,n)},t)}}(r=>{this._handleFilter(e,t,r)},t.config.searchDelay);s.addEventListener("input",e=>a(e.target.value));const i=o("div",{className:"form__field"});i.appendChild(s);const l=o("div",{className:"form__element form__element--sm datatable-filter"});l.appendChild(n),l.appendChild(i),e.parentNode.insertBefore(l,e)}_setupPagination(e,t){const r=document.createElement("div");r.className="datatable__pagination",e.parentNode.appendChild(r),t.paginationContainer=r}_handleSort(e,t,r){const n=r.dataset.sort,s=r.dataset.sortType||"string";let a="asc";t.currentSort.column===n&&"asc"===t.currentSort.direction&&(a="desc"),t.currentSort={column:n,direction:a},e.querySelectorAll(".sort-icon").forEach(e=>{e.textContent=DataTable.defaults.sortIcons.unsorted});r.querySelector(".sort-icon").textContent=DataTable.defaults.sortIcons[a];const o=Array.from(e.querySelectorAll("th"));t.filteredRows.sort((e,t)=>{const r=this._getCellValue(e,n,s,o),i=this._getCellValue(t,n,s,o);let l=0;return l="number"===s?parseFloat(r)-parseFloat(i):"date"===s?new Date(r)-new Date(i):r.localeCompare(i),"desc"===a?-l:l}),t.currentPage=1,this._render(e,t)}_handleFilter(e,t,r){t.searchTerm=r.toLowerCase(),t.filteredRows=r?t.originalRows.filter(e=>Array.from(e.cells).some(e=>e.textContent.toLowerCase().includes(t.searchTerm))):[...t.originalRows],t.currentPage=1,this._render(e,t)}_getCellValue(e,t,r,n=null){if(!e||!e.cells)return"";if(!n){const t=e.closest("table");if(!t)return"";n=Array.from(t.querySelectorAll("th"))}const s=n.findIndex(e=>e&&e.dataset&&e.dataset.sort===t);if(-1===s||!e.cells[s])return"";const a=e.cells[s];return a&&a.textContent?a.textContent.trim():""}_render(e,t){const r=e.querySelector("tbody");r.innerHTML="";let n=t.filteredRows;if(t.config.paginate){const e=(t.currentPage-1)*t.config.pageSize,r=e+t.config.pageSize;n=t.filteredRows.slice(e,r)}n.forEach(e=>r.appendChild(e.cloneNode(!0))),t.config.paginate&&this._renderPagination(e,t),this.eventBus?.emit("datatable:rendered",{element:e,totalRows:t.originalRows.length,filteredRows:t.filteredRows.length,displayedRows:n.length})}_renderPagination(e,t){const r=t.paginationContainer,n=Math.ceil(t.filteredRows.length/t.config.pageSize);if(r.innerHTML="",n<=1)return;const s=document.createElement("button");s.textContent="Previous",s.disabled=1===t.currentPage,s.addEventListener("click",()=>{t.currentPage>1&&(t.currentPage--,this._render(e,t))}),r.appendChild(s);for(let s=1;s<=n;s++){const n=document.createElement("button");n.textContent=s,n.classList.toggle("active",s===t.currentPage),n.addEventListener("click",()=>{t.currentPage=s,this._render(e,t)}),r.appendChild(n)}const a=document.createElement("button");a.textContent="Next",a.disabled=t.currentPage===n,a.addEventListener("click",()=>{t.currentPage<n&&(t.currentPage++,this._render(e,t))}),r.appendChild(a)}async loadData(e,t,r){const o=this.getState(e);if(o)try{this.setState(e,s),o.errorMessage=null;const n=await fetch(t);if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);const i=await n.json();if(!Array.isArray(i))throw new Error("Response data must be an array");if(0===i.length)return this.setState(e,"empty"),o.originalRows=[],o.filteredRows=[],this._render(e,o),void this._dispatch(e,"datatable:empty",{url:t});e.querySelector("tbody").innerHTML="";const l=i.map(e=>r(e));o.originalRows=l,o.filteredRows=[...l],o.currentPage=1,this.setState(e,a),this._render(e,o),this._dispatch(e,"datatable:loaded",{url:t,rowCount:i.length}),this.eventBus?.emit("datatable:loaded",{element:e,url:t,rowCount:i.length})}catch(r){this.setState(e,n),this.setAttr(e,"error-message",r.message),o.errorMessage=r.message,this._dispatch(e,"datatable:error",{error:r,url:t,message:r.message}),this.eventBus?.emit("datatable:error",{element:e,error:r,url:t,message:r.message})}}clearError(e){const t=this.getState(e);t&&(t.errorMessage=null,this.removeAttr(e,"error-message"),this.setState(e,r))}sort(e,t,r="asc"){const n=this.getState(e);if(!n)return;const s=e.querySelector(`th[data-sort="${t}"]`);s&&(n.currentSort={column:t,direction:r},this._handleSort(e,n,s))}filter(e,t){const r=this.getState(e);r&&this._handleFilter(e,r,t)}goToPage(e,t){const r=this.getState(e);if(!r||!r.config.paginate)return;const n=Math.ceil(r.filteredRows.length/r.config.pageSize);t>=1&&t<=n&&(r.currentPage=t,this._render(e,r))}static enhanceAll(e="[data-datatable]",t){const r=new DataTable(t);return document.querySelectorAll(e).forEach(e=>r.mount(e)),r}}export{DataTable,DataTable as default};

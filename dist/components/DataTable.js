function t(t){return t.replace(/-([a-z])/g,t=>t[1].toUpperCase())}function e(t=document){return Array.from(t.querySelectorAll(["a[href]","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])",'[tabindex]:not([tabindex="-1"]):not([disabled])'].join(",")))}class BaseComponent{constructor({eventBus:t,logger:e,router:r}){this.eventBus=t,this.logger=e,this.router=r,this.elements=new WeakMap,this.states=this.elements,this._keys=null}mount(t){if(this.elements.has(t))return this.update(t);const e=this._init(t);this.elements.set(t,e)}update(t){}unmount(t){const e=this.elements.get(t);if(e)try{e.cleanup?.()}finally{this.elements.delete(t)}}destroy(){for(const t of this._elementsKeys())this.unmount(t)}_elementsKeys(){return this._keys||(this._keys=new Set),this._keys}_track(t){this._keys||(this._keys=new Set),this._keys.add(t)}_untrack(t){this._keys?.delete(t)}_init(t){const e=new AbortController;return this._track(t),{cleanup:()=>{e.abort(),this._untrack(t)},controller:e}}getState(t){return this.elements.get(t)}_getDataAttr(e,r,n){return function(e,r,n){const s=r.includes("-")?t(r):r,a=e.dataset[s];return void 0===a?n:"true"===a||"false"!==a&&(isNaN(a)||""===a?a:Number(a))}(e,r,n)}_camelCase(e){return t(e)}_debounce(t,e=300){return function(t,e=300){let r;return function(...n){clearTimeout(r),r=setTimeout(()=>{clearTimeout(r),t.apply(this,n)},e)}}(t,e)}_throttle(t,e=100){return function(t,e=100){let r;return function(...n){r||(t.apply(this,n),r=!0,setTimeout(()=>{r=!1},e))}}(t,e)}_delay(t){return function(t){return new Promise(e=>setTimeout(e,t))}(t)}_getTargetElement(t,e,r={}){const n=`${e}-view`,s=this.getAttr(t,n);if(s){const t=document.querySelector(`[data-view="${s}"]`);return!t&&r.required,t}const a=this.getAttr(t,e);if(!a)return r.required,null;const o=document.querySelector(a);return!o&&r.required,o}_getConfigFromAttrs(t,e){const r={};for(const[n,s]of Object.entries(e)){const e=this.constructor.defaults?.[n];r[n]=this.getAttr(t,s,e)}return r}_requireState(t,e="method"){return this.getState(t)}_generateId(t="elem"){return function(t="elem"){return`${t}-${Date.now()}-${Math.random().toString(36).slice(2,9)}`}(t)}async _waitForTransition(t,e=2e3){return async function(t,e=2e3){return new Promise(r=>{const n=()=>{t.removeEventListener("animationend",n),t.removeEventListener("transitionend",n),r()};t.addEventListener("animationend",n,{once:!0}),t.addEventListener("transitionend",n,{once:!0}),setTimeout(()=>{t.removeEventListener("animationend",n),t.removeEventListener("transitionend",n),r()},e)})}(t,e)}async _fadeIn(t,e=300){return async function(t,e=300){return t.style.opacity="0",t.style.transition=`opacity ${e}ms ease-in-out`,t.offsetHeight,t.style.opacity="1",new Promise(r=>{setTimeout(()=>{t.style.transition="",r()},e)})}(t,e)}async _fadeOut(t,e=300){return async function(t,e=300){return t.style.opacity="1",t.style.transition=`opacity ${e}ms ease-in-out`,t.offsetHeight,t.style.opacity="0",new Promise(r=>{setTimeout(()=>{t.style.transition="",r()},e)})}(t,e)}_getFocusableElements(t=document){return e(t)}_trapFocus(t,r){return function(t,r){const n=e(t);if(!n.length)return;const s=n[0],a=n[n.length-1],o=t.contains(document.activeElement)?document.activeElement:null;!r.shiftKey||o!==s&&o?r.shiftKey||o!==a||(s.focus(),r.preventDefault()):(a.focus(),r.preventDefault())}(t,r)}_restoreFocus(t){return function(t){t&&"function"==typeof t.focus&&requestAnimationFrame(()=>t.focus())}(t)}_createElement(t,e={},r=""){return function(t,e={},r=""){const n=document.createElement(t);for(const[t,r]of Object.entries(e))"className"===t||"class"===t?n.className=r:"style"===t&&"object"==typeof r?Object.assign(n.style,r):"dataset"===t&&"object"==typeof r?Object.assign(n.dataset,r):n.setAttribute(t,r);return"string"==typeof r?n.textContent=r:r instanceof HTMLElement&&n.appendChild(r),n}(t,e,r)}_dispatch(t,e,r){const n=new CustomEvent(e,{detail:r,bubbles:!0,cancelable:!0});return t.dispatchEvent(n),n}_getSelector(){if(this._selector)return this._selector;const t=this.constructor.name.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase();return this._selector=`data-${t}`,this._selector}setState(t,e){t.setAttribute(this._getSelector(),e)}getElementState(t){return t.getAttribute(this._getSelector())}setAttr(t,e,r){t.setAttribute(`${this._getSelector()}-${e}`,String(r))}getAttr(t,e,r=null){const n=t.getAttribute(`${this._getSelector()}-${e}`);return null!==n?n:r}removeAttr(t,e){t.removeAttribute(`${this._getSelector()}-${e}`)}hasAttr(t,e){return t.hasAttribute(`${this._getSelector()}-${e}`)}}const r="mounted",n="error",s="loading",a="loaded";function o(t,e={},r=""){const n=document.createElement(t);for(const[t,r]of Object.entries(e))"className"===t||"class"===t?n.className=r:"style"===t&&"object"==typeof r?Object.assign(n.style,r):"dataset"===t&&"object"==typeof r?Object.assign(n.dataset,r):n.setAttribute(t,r);return"string"==typeof r?n.textContent=r:r instanceof HTMLElement&&n.appendChild(r),n}class DataTable extends BaseComponent{_getSelector(){return"data-datatable"}static get defaults(){return{sortable:!0,filterable:!1,paginate:!1,pageSize:10,searchDelay:300,sortIcons:{unsorted:"↕",asc:"↑",desc:"↓"}}}constructor(t={}){super(t),this.searchTimeout=null}_init(t){const e=super._init(t);this.setState(t,r);const n=this._getConfiguration(t),s=Array.from(t.querySelectorAll("tbody tr"));return e.config=n,e.originalRows=s,e.filteredRows=[...s],e.currentSort={column:null,direction:null},e.currentPage=1,e.searchTerm="",e.errorMessage=null,n.sortable&&this._setupSorting(t,e),n.filterable&&this._setupFiltering(t,e),n.paginate&&this._setupPagination(t,e),this._render(t,e),e}_getConfiguration(t){return{sortable:this.getAttr(t,"sortable",DataTable.defaults.sortable),filterable:this.getAttr(t,"filterable",DataTable.defaults.filterable),paginate:parseInt(this.getAttr(t,"paginate",DataTable.defaults.paginate))||!1,pageSize:parseInt(this.getAttr(t,"page-size",DataTable.defaults.pageSize)),searchDelay:parseInt(this.getAttr(t,"search-delay",DataTable.defaults.searchDelay))}}_setupSorting(t,e){t.querySelectorAll("th[data-sort]").forEach(r=>{r.style.cursor="pointer",r.classList.add("sortable");const n=o("span",{className:"sort-icon"},DataTable.defaults.sortIcons.unsorted);r.appendChild(n),r.addEventListener("click",()=>{this._handleSort(t,e,r)})})}_setupFiltering(t,e){const r=function(t="elem"){return`${t}-${Date.now()}-${Math.random().toString(36).slice(2,9)}`}("datatable-search"),n=o("label",{className:"form__label",htmlFor:r},"Search:"),s=o("input",{type:"text",id:r,placeholder:"Search table...",className:"form__control datatable-search"}),a=function(t,e=300){let r;return function(...n){clearTimeout(r),r=setTimeout(()=>{clearTimeout(r),t.apply(this,n)},e)}}(r=>{this._handleFilter(t,e,r)},e.config.searchDelay);s.addEventListener("input",t=>a(t.target.value));const i=o("div",{className:"form__field"});i.appendChild(s);const l=o("div",{className:"form__element form__element--sm datatable-filter"});l.appendChild(n),l.appendChild(i),t.parentNode.insertBefore(l,t)}_setupPagination(t,e){const r=document.createElement("div");r.className="datatable__pagination",t.parentNode.appendChild(r),e.paginationContainer=r}_handleSort(t,e,r){const n=r.dataset.sort,s=r.dataset.sortType||"string";let a="asc";e.currentSort.column===n&&"asc"===e.currentSort.direction&&(a="desc"),e.currentSort={column:n,direction:a},t.querySelectorAll(".sort-icon").forEach(t=>{t.textContent=DataTable.defaults.sortIcons.unsorted});r.querySelector(".sort-icon").textContent=DataTable.defaults.sortIcons[a];const o=Array.from(t.querySelectorAll("th"));e.filteredRows.sort((t,e)=>{const r=this._getCellValue(t,n,s,o),i=this._getCellValue(e,n,s,o);let l=0;return l="number"===s?parseFloat(r)-parseFloat(i):"date"===s?new Date(r)-new Date(i):r.localeCompare(i),"desc"===a?-l:l}),e.currentPage=1,this._render(t,e)}_handleFilter(t,e,r){e.searchTerm=r.toLowerCase(),e.filteredRows=r?e.originalRows.filter(t=>Array.from(t.cells).some(t=>t.textContent.toLowerCase().includes(e.searchTerm))):[...e.originalRows],e.currentPage=1,this._render(t,e)}_getCellValue(t,e,r,n=null){if(!t||!t.cells)return"";if(!n){const e=t.closest("table");if(!e)return"";n=Array.from(e.querySelectorAll("th"))}const s=n.findIndex(t=>t&&t.dataset&&t.dataset.sort===e);if(-1===s||!t.cells[s])return"";const a=t.cells[s];return a&&a.textContent?a.textContent.trim():""}_render(t,e){const r=t.querySelector("tbody");r.innerHTML="";let n=e.filteredRows;if(e.config.paginate){const t=(e.currentPage-1)*e.config.pageSize,r=t+e.config.pageSize;n=e.filteredRows.slice(t,r)}n.forEach(t=>r.appendChild(t.cloneNode(!0))),e.config.paginate&&this._renderPagination(t,e)}_renderPagination(t,e){const r=e.paginationContainer,n=Math.ceil(e.filteredRows.length/e.config.pageSize);if(r.innerHTML="",n<=1)return;const s=document.createElement("button");s.textContent="Previous",s.disabled=1===e.currentPage,s.addEventListener("click",()=>{e.currentPage>1&&(e.currentPage--,this._render(t,e))}),r.appendChild(s);for(let s=1;s<=n;s++){const n=document.createElement("button");n.textContent=s,n.classList.toggle("active",s===e.currentPage),n.addEventListener("click",()=>{e.currentPage=s,this._render(t,e)}),r.appendChild(n)}const a=document.createElement("button");a.textContent="Next",a.disabled=e.currentPage===n,a.addEventListener("click",()=>{e.currentPage<n&&(e.currentPage++,this._render(t,e))}),r.appendChild(a)}async loadData(t,e,r){const o=this.getState(t);if(o)try{this.setState(t,s),o.errorMessage=null;const n=await fetch(e);if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);const i=await n.json();if(!Array.isArray(i))throw new Error("Response data must be an array");if(0===i.length)return this.setState(t,"empty"),o.originalRows=[],o.filteredRows=[],this._render(t,o),void this._dispatch(t,"datatable:empty",{url:e});t.querySelector("tbody").innerHTML="";const l=i.map(t=>r(t));o.originalRows=l,o.filteredRows=[...l],o.currentPage=1,this.setState(t,a),this._render(t,o),this._dispatch(t,"datatable:loaded",{url:e,rowCount:i.length})}catch(r){this.setState(t,n),this.setAttr(t,"error-message",r.message),o.errorMessage=r.message,this._dispatch(t,"datatable:error",{error:r,url:e,message:r.message})}}clearError(t){const e=this.getState(t);e&&(e.errorMessage=null,this.removeAttr(t,"error-message"),this.setState(t,r))}sort(t,e,r="asc"){const n=this.getState(t);if(!n)return;const s=t.querySelector(`th[data-sort="${e}"]`);s&&(n.currentSort={column:e,direction:r},this._handleSort(t,n,s))}filter(t,e){const r=this.getState(t);r&&this._handleFilter(t,r,e)}goToPage(t,e){const r=this.getState(t);if(!r||!r.config.paginate)return;const n=Math.ceil(r.filteredRows.length/r.config.pageSize);e>=1&&e<=n&&(r.currentPage=e,this._render(t,r))}static enhanceAll(t="[data-datatable]",e){const r=new DataTable(e);return document.querySelectorAll(t).forEach(t=>r.mount(t)),r}}export{DataTable,DataTable as default};

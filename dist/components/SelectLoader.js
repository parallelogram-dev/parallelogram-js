function t(t){return t.replace(/-([a-z])/g,t=>t[1].toUpperCase())}function e(t=document){return Array.from(t.querySelectorAll(["a[href]","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])",'[tabindex]:not([tabindex="-1"]):not([disabled])'].join(",")))}class BaseComponent{constructor({eventBus:t,logger:e,router:n}){this.eventBus=t,this.logger=e,this.router=n,this.elements=new WeakMap,this.states=this.elements,this._keys=null}mount(t){if(this.elements.has(t))return this.update(t);const e=this._init(t);this.elements.set(t,e)}update(t){}unmount(t){const e=this.elements.get(t);if(e)try{e.cleanup?.()}finally{this.elements.delete(t)}}destroy(){for(const t of this._elementsKeys())this.unmount(t)}_elementsKeys(){return this._keys||(this._keys=new Set),this._keys}_track(t){this._keys||(this._keys=new Set),this._keys.add(t)}_untrack(t){this._keys?.delete(t)}_init(t){const e=new AbortController;return this._track(t),{cleanup:()=>{e.abort(),this._untrack(t)},controller:e}}getState(t){return this.elements.get(t)}_getDataAttr(e,n,s){return function(e,n,s){const r=n.includes("-")?t(n):n,i=e.dataset[r];return void 0===i?s:"true"===i||"false"!==i&&(isNaN(i)||""===i?i:Number(i))}(e,n,s)}_camelCase(e){return t(e)}_debounce(t,e=300){return function(t,e=300){let n;return function(...s){clearTimeout(n),n=setTimeout(()=>{clearTimeout(n),t.apply(this,s)},e)}}(t,e)}_throttle(t,e=100){return function(t,e=100){let n;return function(...s){n||(t.apply(this,s),n=!0,setTimeout(()=>{n=!1},e))}}(t,e)}_delay(t){return function(t){return new Promise(e=>setTimeout(e,t))}(t)}_getTargetElement(t,e,n={}){const s=`${e}-view`,r=this.getAttr(t,s);if(r){const t=document.querySelector(`[data-view="${r}"]`);return!t&&n.required,t}const i=this.getAttr(t,e);if(!i)return n.required,null;const a=document.querySelector(i);return!a&&n.required,a}_getConfigFromAttrs(t,e){const n={};for(const[s,r]of Object.entries(e)){const e=this.constructor.defaults?.[s];n[s]=this.getAttr(t,r,e)}return n}_requireState(t,e="method"){return this.getState(t)}_generateId(t="elem"){return function(t="elem"){return`${t}-${Date.now()}-${Math.random().toString(36).slice(2,9)}`}(t)}async _waitForTransition(t,e=2e3){return async function(t,e=2e3){return new Promise(n=>{const s=()=>{t.removeEventListener("animationend",s),t.removeEventListener("transitionend",s),n()};t.addEventListener("animationend",s,{once:!0}),t.addEventListener("transitionend",s,{once:!0}),setTimeout(()=>{t.removeEventListener("animationend",s),t.removeEventListener("transitionend",s),n()},e)})}(t,e)}async _fadeIn(t,e=300){return async function(t,e=300){return t.style.opacity="0",t.style.transition=`opacity ${e}ms ease-in-out`,t.offsetHeight,t.style.opacity="1",new Promise(n=>{setTimeout(()=>{t.style.transition="",n()},e)})}(t,e)}async _fadeOut(t,e=300){return async function(t,e=300){return t.style.opacity="1",t.style.transition=`opacity ${e}ms ease-in-out`,t.offsetHeight,t.style.opacity="0",new Promise(n=>{setTimeout(()=>{t.style.transition="",n()},e)})}(t,e)}_getFocusableElements(t=document){return e(t)}_trapFocus(t,n){return function(t,n){const s=e(t);if(!s.length)return;const r=s[0],i=s[s.length-1],a=t.contains(document.activeElement)?document.activeElement:null;!n.shiftKey||a!==r&&a?n.shiftKey||a!==i||(r.focus(),n.preventDefault()):(i.focus(),n.preventDefault())}(t,n)}_restoreFocus(t){return function(t){t&&"function"==typeof t.focus&&requestAnimationFrame(()=>t.focus())}(t)}_createElement(t,e={},n=""){return function(t,e={},n=""){const s=document.createElement(t);for(const[t,n]of Object.entries(e))"className"===t||"class"===t?s.className=n:"style"===t&&"object"==typeof n?Object.assign(s.style,n):"dataset"===t&&"object"==typeof n?Object.assign(s.dataset,n):s.setAttribute(t,n);return"string"==typeof n?s.textContent=n:n instanceof HTMLElement&&s.appendChild(n),s}(t,e,n)}_dispatch(t,e,n){const s=new CustomEvent(e,{detail:n,bubbles:!0,cancelable:!0});return t.dispatchEvent(s),s}_getSelector(){if(this._selector)return this._selector;const t=this.constructor.name.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase();return this._selector=`data-${t}`,this._selector}setState(t,e){t.setAttribute(this._getSelector(),e)}getElementState(t){return t.getAttribute(this._getSelector())}setAttr(t,e,n){t.setAttribute(`${this._getSelector()}-${e}`,String(n))}getAttr(t,e,n=null){const s=t.getAttribute(`${this._getSelector()}-${e}`);return null!==s?s:n}removeAttr(t,e){t.removeAttribute(`${this._getSelector()}-${e}`)}hasAttr(t,e){return t.hasAttribute(`${this._getSelector()}-${e}`)}}class SelectLoader extends BaseComponent{_getSelector(){return"data-selectloader"}static get defaults(){return{loadingClass:"loading",errorClass:"error",transition:"fade",transitionDuration:300,retainScroll:!1,emptyMessage:"Please select an option"}}_init(t){const e=super._init(t);if("SELECT"!==t.tagName)return e;const n=this._getConfigFromAttrs(t,{target:"target",loadingClass:"loading-class",errorClass:"error-class",transition:"transition",transitionDuration:"transition-duration",retainScroll:"retain-scroll",emptyMessage:"empty-message"}),s=this._getTargetElement(t,"target",{required:!0});return s?(e.config={...SelectLoader.defaults,...n},e.targetElement=s,e.isLoading=!1,e.currentUrl=null,e.scrollPosition=0,this._setupEventListeners(t,e),t.value?this._loadFragment(t,e,t.value):this._showEmptyMessage(e),e):e}_setupEventListeners(t,e){t.addEventListener("change",n=>{this._handleChange(n,t,e)},{signal:e.controller.signal});const n=t.closest("form");n&&n.addEventListener("reset",async()=>{await this._delay(10),this._showEmptyMessage(e)},{signal:e.controller.signal})}async _handleChange(t,e,n){const s=e.value;if(!this._dispatch(e,"selectloader:before-change",{value:s,previousUrl:n.currentUrl,targetElement:n.targetElement}).defaultPrevented)return s&&""!==s?void await this._loadFragment(e,n,s):(this._showEmptyMessage(n),n.currentUrl=null,void this._dispatch(e,"selectloader:cleared",{targetElement:n.targetElement}))}async _loadFragment(t,e,n){if(!e.isLoading){e.isLoading=!0,e.currentUrl=n,e.config.retainScroll&&(e.scrollPosition=e.targetElement.scrollTop),t.classList.add(e.config.loadingClass),t.disabled=!0,e.targetElement.classList.add(e.config.loadingClass),this._dispatch(t,"selectloader:loading",{url:n,targetElement:e.targetElement});try{if(!this.router)throw new Error("RouterManager not available");const s=(await this.router.get(n)).data;"none"!==e.config.transition&&await this._transitionOut(e),e.targetElement.innerHTML=s,e.config.retainScroll&&(e.targetElement.scrollTop=e.scrollPosition),"none"!==e.config.transition&&await this._transitionIn(e),this._dispatch(t,"selectloader:loaded",{url:n,targetElement:e.targetElement,html:s})}catch(s){this._showErrorMessage(e,s),this._dispatch(t,"selectloader:error",{url:n,error:s,targetElement:e.targetElement})}finally{e.isLoading=!1,t.classList.remove(e.config.loadingClass),t.disabled=!1,e.targetElement.classList.remove(e.config.loadingClass),this._dispatch(t,"selectloader:complete",{url:n,success:!e.targetElement.classList.contains(e.config.errorClass)})}}}async _transitionOut(t){const{transition:e,transitionDuration:n}=t.config;"fade"===e?await this._fadeOut(t.targetElement,n):"slide"===e&&await this._slideOut(t.targetElement,n)}async _transitionIn(t){const{transition:e,transitionDuration:n}=t.config;"fade"===e?await this._fadeIn(t.targetElement,n):"slide"===e&&await this._slideIn(t.targetElement,n)}async _slideOut(t,e){const n=t.offsetHeight;t.style.overflow="hidden",t.style.height=`${n}px`,t.offsetHeight,t.style.transition=`height ${e}ms ease-out, opacity ${e}ms ease-out`,t.style.height="0",t.style.opacity="0",await this._delay(e)}async _slideIn(t,e){const n=t.scrollHeight;t.style.height="0",t.style.overflow="hidden",t.offsetHeight,t.style.transition=`height ${e}ms ease-in, opacity ${e}ms ease-in`,t.style.height=`${n}px`,t.style.opacity="1",await this._delay(e),t.style.height="",t.style.overflow="",t.style.transition=""}_showEmptyMessage(t){const e=t.config.emptyMessage;t.targetElement.innerHTML=`\n      <div class="select-loader__empty">\n        <p>${e}</p>\n      </div>\n    `,t.targetElement.classList.remove(t.config.errorClass)}_showErrorMessage(t,e){const n=e.message||"Failed to load content",s=this._generateId("retry");t.targetElement.innerHTML=`\n      <div class="select-loader__error">\n        <p>${n}</p>\n        <button type="button" id="${s}" class="btn btn--sm">Retry</button>\n      </div>\n    `,t.targetElement.classList.add(t.config.errorClass);const r=document.getElementById(s);r&&r.addEventListener("click",()=>{const e=Array.from(document.querySelectorAll("select")).find(e=>this.getState(e)===t);e&&t.currentUrl&&this._loadFragment(e,t,t.currentUrl)},{once:!0})}reload(t){const e=this._requireState(t,"reload");e&&e.currentUrl&&this._loadFragment(t,e,e.currentUrl)}load(t,e){const n=this._requireState(t,"load");n&&(t.value=e,this._loadFragment(t,n,e))}clear(t){const e=this._requireState(t,"clear");e&&(t.value="",this._showEmptyMessage(e),e.currentUrl=null)}getLoadState(t){const e=this.getState(t);return e?{isLoading:e.isLoading,currentUrl:e.currentUrl,hasContent:e.targetElement.children.length>0,hasError:e.targetElement.classList.contains(e.config.errorClass)}:null}}export{SelectLoader as default};

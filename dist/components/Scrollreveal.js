function e(e){return e.replace(/-([a-z])/g,e=>e[1].toUpperCase())}function t(e=document){return Array.from(e.querySelectorAll(["a[href]","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])",'[tabindex]:not([tabindex="-1"]):not([disabled])'].join(",")))}class BaseComponent{constructor({eventBus:e,logger:t,router:s}){this.eventBus=e,this.logger=t,this.router=s,this.elements=new WeakMap,this.states=this.elements,this._keys=null}mount(e){if(this.elements.has(e))return this.update(e);const t=this._init(e);this.elements.set(e,t)}update(e){}unmount(e){const t=this.elements.get(e);if(t)try{t.cleanup?.()}finally{this.elements.delete(e)}}destroy(){for(const e of this._elementsKeys())this.unmount(e)}_elementsKeys(){return this._keys||(this._keys=new Set),this._keys}_track(e){this._keys||(this._keys=new Set),this._keys.add(e)}_untrack(e){this._keys?.delete(e)}_init(e){const t=new AbortController;return this._track(e),{cleanup:()=>{t.abort(),this._untrack(e)},controller:t}}getState(e){return this.elements.get(e)}_getDataAttr(t,s,r){return function(t,s,r){const n=s.includes("-")?e(s):s,i=t.dataset[n];return void 0===i?r:"true"===i||"false"!==i&&(isNaN(i)||""===i?i:Number(i))}(t,s,r)}_camelCase(t){return e(t)}_debounce(e,t=300){return function(e,t=300){let s;return function(...r){clearTimeout(s),s=setTimeout(()=>{clearTimeout(s),e.apply(this,r)},t)}}(e,t)}_throttle(e,t=100){return function(e,t=100){let s;return function(...r){s||(e.apply(this,r),s=!0,setTimeout(()=>{s=!1},t))}}(e,t)}_delay(e){return function(e){return new Promise(t=>setTimeout(t,e))}(e)}_getTargetElement(e,t,s={}){const r=`${t}-view`,n=this.getAttr(e,r);if(n){const e=document.querySelector(`[data-view="${n}"]`);return!e&&s.required,e}const i=this.getAttr(e,t);if(!i)return s.required,null;const a=document.querySelector(i);return!a&&s.required,a}_getConfigFromAttrs(e,t){const s={};for(const[r,n]of Object.entries(t)){const t=this.constructor.defaults?.[r];s[r]=this.getAttr(e,n,t)}return s}_requireState(e,t="method"){return this.getState(e)}_generateId(e="elem"){return function(e="elem"){return`${e}-${Date.now()}-${Math.random().toString(36).slice(2,9)}`}(e)}async _waitForTransition(e,t=2e3){return async function(e,t=2e3){return new Promise(s=>{const r=()=>{e.removeEventListener("animationend",r),e.removeEventListener("transitionend",r),s()};e.addEventListener("animationend",r,{once:!0}),e.addEventListener("transitionend",r,{once:!0}),setTimeout(()=>{e.removeEventListener("animationend",r),e.removeEventListener("transitionend",r),s()},t)})}(e,t)}async _fadeIn(e,t=300){return async function(e,t=300){return e.style.opacity="0",e.style.transition=`opacity ${t}ms ease-in-out`,e.offsetHeight,e.style.opacity="1",new Promise(s=>{setTimeout(()=>{e.style.transition="",s()},t)})}(e,t)}async _fadeOut(e,t=300){return async function(e,t=300){return e.style.opacity="1",e.style.transition=`opacity ${t}ms ease-in-out`,e.offsetHeight,e.style.opacity="0",new Promise(s=>{setTimeout(()=>{e.style.transition="",s()},t)})}(e,t)}_getFocusableElements(e=document){return t(e)}_trapFocus(e,s){return function(e,s){const r=t(e);if(!r.length)return;const n=r[0],i=r[r.length-1],a=e.contains(document.activeElement)?document.activeElement:null;!s.shiftKey||a!==n&&a?s.shiftKey||a!==i||(n.focus(),s.preventDefault()):(i.focus(),s.preventDefault())}(e,s)}_restoreFocus(e){return function(e){e&&"function"==typeof e.focus&&requestAnimationFrame(()=>e.focus())}(e)}_createElement(e,t={},s=""){return function(e,t={},s=""){const r=document.createElement(e);for(const[e,s]of Object.entries(t))"className"===e||"class"===e?r.className=s:"style"===e&&"object"==typeof s?Object.assign(r.style,s):"dataset"===e&&"object"==typeof s?Object.assign(r.dataset,s):r.setAttribute(e,s);return"string"==typeof s?r.textContent=s:s instanceof HTMLElement&&r.appendChild(s),r}(e,t,s)}_dispatch(e,t,s){const r=new CustomEvent(t,{detail:s,bubbles:!0,cancelable:!0});return e.dispatchEvent(r),this.eventBus?.emit(t,{element:e,...s}),r}_getSelector(){if(this._selector)return this._selector;const e=this.constructor.name.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase();return this._selector=`data-${e}`,this._selector}setState(e,t){e.setAttribute(this._getSelector(),t)}getElementState(e){return e.getAttribute(this._getSelector())}setAttr(e,t,s){e.setAttribute(`${this._getSelector()}-${t}`,String(s))}getAttr(e,t,s=null){const r=e.getAttribute(`${this._getSelector()}-${t}`);return null!==r?r:s}removeAttr(e,t){e.removeAttribute(`${this._getSelector()}-${t}`)}hasAttr(e,t){return e.hasAttribute(`${this._getSelector()}-${t}`)}}class Scrollreveal extends BaseComponent{_getSelector(){return"data-reveal"}static get defaults(){return{threshold:.1,rootMargin:"0px",once:!0,delay:0,stagger:100,initialState:"hidden"}}constructor(e={}){super(e),this.transitionManager=e.transitionManager,this.revealQueue=[],this.isProcessingQueue=!1,this._createObserver()}_createObserver(){const e={root:null,rootMargin:Scrollreveal.defaults.rootMargin,threshold:Scrollreveal.defaults.threshold};this.observer=new IntersectionObserver(this._handleIntersection.bind(this),e)}_init(e){const t=super._init(e),s=this.getAttr(e,"threshold",Scrollreveal.defaults.threshold),r=this.getAttr(e,"once",Scrollreveal.defaults.once),n=this.getAttr(e,"delay",Scrollreveal.defaults.delay),i=this.getAttr(e,"stagger",Scrollreveal.defaults.stagger),a=this.getAttr(e,"initial",Scrollreveal.defaults.initialState);t.threshold=parseFloat(s),t.once=Boolean(r),t.delay=parseInt(n,10),t.stagger=parseInt(i,10),t.initialState=a,t.hasBeenRevealed=!1,t.isRevealing=!1,t.items=[e],this._setInitialState(e,t),this.setAttr(e,"enhanced","true"),t.threshold!==Scrollreveal.defaults.threshold?(t.customObserver=new IntersectionObserver(this._handleIntersection.bind(this),{root:null,rootMargin:Scrollreveal.defaults.rootMargin,threshold:t.threshold}),t.customObserver.observe(e)):this.observer.observe(e);const o=t.cleanup;return t.cleanup=()=>{t.customObserver?(t.customObserver.unobserve(e),t.customObserver.disconnect()):this.observer.unobserve(e),this.revealQueue=this.revealQueue.filter(t=>t.element!==e),o()},this.eventBus?.emit("scrollreveal:mount",{element:e,threshold:t.threshold,stagger:t.stagger,timestamp:performance.now()}),t}_setInitialState(e,t){if("hidden"===t.initialState){if(!e.dataset.revealClass){e.style.opacity="0";const t=e.dataset.transitionY||"1rem";e.style.transform=`translateY(${t})`}this.setAttr(e,"state","hidden")}}_handleIntersection(e){e.forEach(e=>{const t=e.target,s=this.getState(t);s&&(!e.isIntersecting||s.hasBeenRevealed||s.isRevealing?e.isIntersecting||s.once||!s.hasBeenRevealed||this._hideElement(t,s):s.stagger>0?this._addToRevealQueue(t,s):this._revealElement(t,s))})}_addToRevealQueue(e,t){this.revealQueue.push({element:e,state:t,timestamp:performance.now()}),this._processRevealQueue()}_processRevealQueue(){this.isProcessingQueue||0===this.revealQueue.length||(this.isProcessingQueue=!0,requestAnimationFrame(()=>{this._processNextInQueue()}))}_processNextInQueue(){if(0===this.revealQueue.length)return void(this.isProcessingQueue=!1);const{element:e,state:t}=this.revealQueue.shift();t.isRevealing||t.hasBeenRevealed?this._scheduleNextQueueItem(0):(this._revealElement(e,t,!0).catch(e=>{}),this._scheduleNextQueueItem(t.stagger))}_scheduleNextQueueItem(e=0){e>0?setTimeout(()=>{this._processNextInQueue()},e):requestAnimationFrame(()=>{this._processNextInQueue()})}async _revealElement(e,t,s=!0){t.isRevealing=!0,this.eventBus?.emit("scrollreveal:reveal-start",{element:e,timestamp:performance.now()});try{s&&t.delay>0&&await this._delay(t.delay),await this._revealItems([e],e),t.hasBeenRevealed=!0,t.once&&(t.customObserver?t.customObserver.unobserve(e):this.observer.unobserve(e)),this.eventBus?.emit("scrollreveal:reveal-complete",{element:e,timestamp:performance.now()})}catch(t){this.eventBus?.emit("scrollreveal:reveal-error",{element:e,error:t,timestamp:performance.now()})}finally{t.isRevealing=!1}}async _hideElement(e,t){if(!t.once)try{await this._hideItems([e],e),t.hasBeenRevealed=!1,this.eventBus?.emit("scrollreveal:hide-complete",{element:e,timestamp:performance.now()})}catch(e){}}async _revealItems(e,t){const s=e.map(async e=>{this.setAttr(e,"state","revealing");try{const t=e.dataset.revealClass;t?await this._animateWithClass(e,t):this.transitionManager?await this.transitionManager.enter(e):(e.style.transition="opacity 0.6s ease, transform 0.6s ease",e.style.opacity="1",e.style.transform="translateY(0)"),this.setAttr(e,"state","visible")}catch(t){throw this.setAttr(e,"state","error"),t}});await Promise.all(s)}async _hideItems(e,t){const s=e.map(async e=>{this.setAttr(e,"state","hiding");try{const t=e.dataset.revealClass,s=e.dataset.revealExitClass;if(s)await this._animateWithClass(e,s);else if(t){const s=t.split(" ").filter(e=>e.trim());e.classList.remove(...s)}else if(this.transitionManager)await this.transitionManager.exit(e);else{const t=e.dataset.transitionY||"1rem";e.style.opacity="0",e.style.transform=`translateY(${t})`}this.setAttr(e,"state","hidden")}catch(t){throw this.setAttr(e,"state","error"),t}});await Promise.all(s)}_animateWithClass(e,t){return new Promise(s=>{const r=()=>{e.removeEventListener("animationend",r),e.removeEventListener("transitionend",r),s()};e.addEventListener("animationend",r,{once:!0}),e.addEventListener("transitionend",r,{once:!0});const n=t.split(" ").filter(e=>e.trim());e.classList.add(...n),setTimeout(()=>{e.removeEventListener("animationend",r),e.removeEventListener("transitionend",r),s()},2e3)})}_delay(e){return new Promise(t=>setTimeout(t,e))}setStagger(e){this.staggerDelay=e}clearQueue(){this.revealQueue=[],this.isProcessingQueue=!1}async reveal(e){const t=this.getState(e);!t||t.hasBeenRevealed||t.isRevealing||await this._revealElement(e,t)}async hide(e){const t=this.getState(e);t&&t.hasBeenRevealed&&await this._hideElement(e,t)}reset(e){const t=this.getState(e);t&&(t.hasBeenRevealed=!1,t.isRevealing=!1,this._setInitialState(e,t),t.once&&(t.customObserver?t.customObserver.observe(e):this.observer.observe(e)))}isRevealed(e){const t=this.getState(e);return!!t&&t.hasBeenRevealed}updateThreshold(e,t){const s=this.getState(e);s&&(s.threshold=t,s.customObserver&&s.customObserver.disconnect(),s.customObserver=new IntersectionObserver(this._handleIntersection.bind(this),{root:null,rootMargin:Scrollreveal.defaults.rootMargin,threshold:t}),s.customObserver.observe(e))}getStatus(){const e=`[${this._getSelector()}-enhanced="true"]`,t=document.querySelectorAll(e);let s=0,r=0;return t.forEach(e=>{const t=this.getState(e);t&&(t.hasBeenRevealed&&s++,t.isRevealing&&r++)}),{totalElements:t.length,revealedCount:s,revealingCount:r,queuedCount:this.revealQueue.length,observerActive:!!this.observer,defaults:Scrollreveal.defaults}}destroy(){this.observer&&(this.observer.disconnect(),this.observer=null),this.revealQueue=[],this.isProcessingQueue=!1,super.destroy()}static enhanceAll(e="[data-reveal]",t){const s=new Scrollreveal(t);return document.querySelectorAll(e).forEach(e=>{s.mount(e)}),s}}export{Scrollreveal as default};

class TransitionManager{constructor({root:e=document,defaultY:t="1rem",defaultDur:s=320,defaultEase:n="cubic-bezier(0.22,1,0.36,1)"}={}){this.root=e,this.defaults={y:t,dur:s,ease:n}}async enter(e){const t=e.dataset.transitionEnterClass;return t?this._animateWithClass(e,t):this._animateWithJS(e,!0)}async exit(e){const t=e.dataset.transitionExitClass;return t?this._animateWithClass(e,t):this._animateWithJS(e,!1)}_animateWithClass(e,t){return new Promise(s=>{const n=()=>{e.removeEventListener("animationend",n),s()};e.addEventListener("animationend",n,{once:!0}),e.classList.add(t)})}_animateWithJS(e,t){const s=e.dataset.transitionY||this.defaults.y,n=Number(e.dataset.transitionDuration||this.defaults.dur),i=e.dataset.transitionEase||this.defaults.ease;return e.style.transition=`opacity ${n}ms ${i}, transform ${n}ms ${i}`,t?(e.style.opacity=0,e.style.transform=`translateY(${s})`,e.getBoundingClientRect(),e.style.opacity=1,e.style.transform="translateY(0)"):(e.style.opacity=1,e.style.transform="translateY(0)",e.getBoundingClientRect(),e.style.opacity=0,e.style.transform=`translateY(${s})`),new Promise(t=>setTimeout(()=>{e.style.transition="",t()},n))}async swap(e,t){const s=e.firstElementChild;s&&await this.exit(s),e.innerHTML="",t&&e.appendChild(t),t&&await this.enter(t)}}class PSelect extends HTMLElement{static formAssociated=!0;constructor(){if(super(),!this.attachInternals)throw new Error("PSelect requires form-associated custom elements support");this._internals=this.attachInternals(),this.attachShadow({mode:"open"}),this.tm=new TransitionManager,this.state={options:[],filtered:[],value:"",open:!1,highlightedIndex:-1,src:null,debounce:200,min:0,openOnFocus:!0,placeholder:this.getAttribute("placeholder")||"Select…",disabled:!1,required:!1,loading:!1,error:null},this._abortController=null,this._searchTimeout=null,this._announcementRegion=null,this._render(),this._setupEventListeners(),this._initializeFromAttributes()}connectedCallback(){this._createAnnouncementRegion(),this._parseOptionsFromDOM(),this.state.src&&0===this.state.min&&this._fetchOptions("").catch(this._handleFetchError.bind(this))}disconnectedCallback(){this._cancelPendingRequest(),this._searchTimeout&&clearTimeout(this._searchTimeout),this._announcementRegion&&this._announcementRegion.remove()}static get observedAttributes(){return["value","placeholder","disabled","name","required"]}attributeChangedCallback(e,t,s){if(t!==s)switch(e){case"value":this._updateValue(s);break;case"placeholder":this.state.placeholder=s||"Select…",this._updatePlaceholder();break;case"disabled":this._updateDisabledState(null!==s);break;case"name":this.name=s||"";break;case"required":this._updateRequiredState(null!==s)}}_render(){this.shadowRoot.innerHTML='\n      <style>\n        :host {\n          display: inline-block;\n          position: relative;\n          box-sizing: border-box;\n        }\n\n        /* CSS custom properties with fallbacks to parent/theme colors */\n        :host {\n          --select-border-color: var(--border-color, var(--color-border, #e2e8f0));\n          --select-focus-color: var(--accent-color, var(--color-primary, #3b82f6));\n          --select-bg: var(--background-color, var(--color-surface, #fff));\n          --select-text: var(--text-color, var(--color-text, currentColor));\n          --select-placeholder: var(--text-muted, var(--color-text-secondary, #64748b));\n          --select-hover-bg: var(--hover-bg, var(--color-surface-hover, rgba(0,0,0,0.05)));\n          --select-selected-bg: var(--selected-bg, var(--color-surface-active, rgba(59, 130, 246, 0.1)));\n          --select-current-bg: var(--current-bg, var(--color-surface-focus, rgba(0,0,0,0.1)));\n          --select-padding: 0.45rem 0.6rem;\n          --select-border-radius: 6px;\n          --select-border: 1px solid var(--select-border-color);\n          --select-focus-shadow: 0 0 0 3px var(--focus-shadow-color, rgba(59, 130, 246, 0.1));\n        }\n\n        /* Dark mode adjustments */\n        @media (prefers-color-scheme: dark) {\n          :host {\n            --select-border-color: var(--border-color, var(--color-border, #374151));\n            --select-bg: var(--background-color, var(--color-surface, #1f2937));\n            --select-text: var(--text-color, var(--color-text, #f9fafb));\n            --select-placeholder: var(--text-muted, var(--color-text-secondary, #9ca3af));\n            --select-hover-bg: var(--hover-bg, var(--color-surface-hover, rgba(255,255,255,0.1)));\n            --select-selected-bg: var(--selected-bg, var(--color-surface-active, rgba(59, 130, 246, 0.2)));\n            --select-current-bg: var(--current-bg, var(--color-surface-focus, rgba(255,255,255,0.1)));\n          }\n        }\n\n        .root {\n          position: absolute;\n          top: 0;\n          left: 0;\n          width: 100%;\n          height: 100%;\n          box-sizing: border-box;\n          background: inherit;\n          color: inherit;\n          font-family: inherit;\n          font-size: inherit;\n          border: inherit;\n          border-radius: inherit;\n          padding: inherit;\n        }\n\n        .control {\n          position: absolute;\n          top: 0;\n          left: 0;\n          right: 0;\n          bottom: 0;\n          display: flex;\n          align-items: center;\n          gap: 0.4rem;\n          cursor: pointer;\n          transition: border-color 0.2s ease, box-shadow 0.2s ease;\n          box-sizing: border-box;\n          padding: inherit;\n        }\n\n        .input {\n          border: 0;\n          outline: 0;\n          flex: 1;\n          min-width: 2ch;\n          background: transparent;\n          color: inherit;\n          font: inherit;\n          padding: 0;\n        }\n\n        .input::placeholder {\n          color: inherit;\n          opacity: 0.6;\n        }\n\n        .arrow {\n          pointer-events: none;\n          transition: transform 0.15s ease;\n          user-select: none;\n          flex-shrink: 0;\n          margin-left: auto;\n        }\n\n        .control[aria-expanded="true"] .arrow {\n          transform: rotate(180deg);\n        }\n\n        .menu {\n          position: absolute;\n          z-index: 10;\n          left: 0;\n          right: 0;\n          top: 100%;\n          margin-top: 0.25rem;\n          background: var(--select-bg);\n          color: var(--select-text);\n          border: 1px solid var(--select-border-color);\n          border-radius: 10px;\n          max-height: 240px;\n          overflow: auto;\n          box-shadow: 0 10px 30px var(--shadow-color, rgba(0, 0, 0, 0.08));\n        }\n\n        .option {\n          padding: 0.45rem 0.6rem;\n          cursor: pointer;\n          transition: background-color 0.15s ease;\n        }\n\n        .option:hover {\n          background: var(--select-hover-bg);\n        }\n\n        .option[aria-selected="true"] {\n          background: var(--select-selected-bg);\n          font-weight: 500;\n        }\n\n        .option[aria-current="true"] {\n          background: var(--select-current-bg);\n        }\n\n        .option[aria-disabled="true"] {\n          opacity: 0.5;\n          cursor: not-allowed;\n          background: transparent !important;\n        }\n\n        .noresults {\n          padding: 0.6rem;\n          font-style: italic;\n          text-align: center;\n          opacity: 0.6;\n        }\n      </style>\n      \n      <div class="root">\n        <div \n          class="control" \n          role="combobox" \n          aria-expanded="false" \n          aria-haspopup="listbox"\n        >\n          <input \n            class="input" \n            type="text" \n            autocomplete="off"\n          />\n          <span class="arrow" aria-hidden="true">▾</span>\n        </div>\n        \n        <div class="menu" role="listbox" hidden></div>\n      </div>\n    ',this._els={control:this.shadowRoot.querySelector(".control"),input:this.shadowRoot.querySelector(".input"),menu:this.shadowRoot.querySelector(".menu"),arrow:this.shadowRoot.querySelector(".arrow")},this._updateDisplay()}_setupEventListeners(){this._els.control.addEventListener("mousedown",e=>{e.target!==this._els.input&&(e.preventDefault(),this._els.input.focus(),this.toggle())}),this._els.input.addEventListener("focus",()=>{this.state.openOnFocus&&this.open()}),this._els.input.addEventListener("input",e=>{this._handleInput(e)}),this._els.input.addEventListener("keydown",e=>{this._handleKeydown(e)}),document.addEventListener("click",e=>{this.contains(e.target)||this.shadowRoot.contains(e.target)||this.close()})}_initializeFromAttributes(){const e=this.dataset;this.state.src=e.selectSrc||null,this.state.debounce=Number(e.selectDebounce||200),this.state.min=Number(e.selectMin||0),this.state.openOnFocus="false"!==(e.selectOpenOnFocus??"true"),this.state.disabled=this.hasAttribute("disabled"),this.state.required=this.hasAttribute("required"),this.name=this.getAttribute("name")||""}_createAnnouncementRegion(){this._announcementRegion=document.createElement("div"),this._announcementRegion.setAttribute("aria-live","polite"),this._announcementRegion.style.cssText="position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0)",document.body.appendChild(this._announcementRegion)}_announce(e){this._announcementRegion&&(this._announcementRegion.textContent=e)}_parseOptionsFromDOM(){const e=[];this.querySelectorAll("option").forEach((t,s)=>{const n=t.hasAttribute("disabled"),i=t.hasAttribute("selected"),a={value:t.value||t.textContent.trim(),label:t.textContent.trim(),disabled:n,selected:i};e.push(a),a.selected&&(this.state.value=a.value),t.style.display="none"}),e.length>0&&(this.setOptions(e),this._updateDisplay())}_handleInput(e){const t=e.target.value;this.state.src&&t.length>=this.state.min?(this._cancelPendingRequest(),this._searchTimeout=setTimeout(()=>{this._fetchOptions(t).catch(this._handleFetchError.bind(this))},this.state.debounce)):this._filterLocal(t)}_handleKeydown(e){if(!this.state.open)return void("ArrowDown"!==e.key&&"Enter"!==e.key||(e.preventDefault(),this.open()));const t=this.state.filtered.length-1;switch(e.key){case"ArrowDown":e.preventDefault(),this.state.highlightedIndex=Math.min(t,this.state.highlightedIndex+1),this._renderOptions();break;case"ArrowUp":e.preventDefault(),this.state.highlightedIndex=Math.max(0,this.state.highlightedIndex-1),this._renderOptions();break;case"Enter":if(e.preventDefault(),this.state.highlightedIndex>=0&&this.state.highlightedIndex<this.state.filtered.length){const e=this.state.filtered[this.state.highlightedIndex];e&&!e.disabled&&this.select(e.value)}break;case"Escape":e.preventDefault(),this.close()}}_cancelPendingRequest(){this._abortController&&(this._abortController.abort(),this._abortController=null),this._searchTimeout&&(clearTimeout(this._searchTimeout),this._searchTimeout=null)}async _fetchOptions(e){this.state.loading=!0}_handleFetchError(e){this.state.error=e.message,this._announce(`Error: ${e.message}`)}_filterLocal(e){const t=e.trim().toLowerCase();this.state.filtered=this.state.options.filter(e=>e.label.toLowerCase().includes(t)),this.state.highlightedIndex=this.state.filtered.length>0?0:-1,this._renderOptions()}_updateDisplay(){if(this.state.value){const e=this.state.options.find(e=>e.value===this.state.value);this._els.input.value=e?e.label:""}else this._els.input.value="",this._els.input.placeholder=this.state.placeholder}_updateValue(e){this.state.value=e,this._updateDisplay()}_updatePlaceholder(){this._els.input.placeholder=this.state.placeholder}_updateDisabledState(e){this.state.disabled=e,this._els.input.disabled=e}_updateRequiredState(e){this.state.required=e,this._els.input.required=e}open(){this.state.open||this.state.disabled||(this.state.open=!0,this.state.highlightedIndex=0,this._els.control.setAttribute("aria-expanded","true"),this._els.menu.hidden=!1,this._renderOptions(),this.tm.enter(this._els.menu),this.dispatchEvent(new CustomEvent("p-select:open",{bubbles:!0})))}close(){this.state.open&&(this.state.open=!1,this._els.control.setAttribute("aria-expanded","false"),this.tm.exit(this._els.menu).then(()=>{this._els.menu.hidden=!0}),this.dispatchEvent(new CustomEvent("p-select:close",{bubbles:!0})))}toggle(){this.state.open?this.close():this.open()}select(e){const t=this.state.options.find(t=>t.value==e);t&&!t.disabled&&(this.state.value=t.value,this._setFormValue(t.value,t.label),this._els.input.value=t.label,this.dispatchEvent(new CustomEvent("p-select:change",{detail:{value:t.value,label:t.label},bubbles:!0})),this.close())}setOptions(e){this.state.options=Array.isArray(e)?e.slice():[],this.state.filtered=this.state.options.slice(),this._renderOptions()}getValue(){return this.state.value}clear(){this.state.value="",this._setFormValue("",""),this._els.input.value="",this._els.input.placeholder=this.state.placeholder}get value(){return this.state.value}set value(e){this._updateValue(e)}refreshOptions(){this._parseOptionsFromDOM()}debug(){return{options:this.state.options,filtered:this.state.filtered,value:this.state.value,domOptions:this.querySelectorAll("option").length}}_setFormValue(e,t){if(this._internals?.setFormValue){const s=new FormData;this.name&&s.set(this.name,e),this._internals.setFormValue(s,t)}}_renderOptions(){const e=this._els.menu;e.innerHTML="";const t=this.state.filtered;if(0===t.length){const t=document.createElement("div");return t.className="noresults",t.textContent="No results found",void e.appendChild(t)}t.forEach((t,s)=>{const n=document.createElement("div");n.className="option",n.setAttribute("role","option"),n.setAttribute("aria-selected",String(t.value===this.state.value)),n.textContent=t.label,t.disabled&&n.setAttribute("aria-disabled","true"),s===this.state.highlightedIndex&&n.setAttribute("aria-current","true"),t.disabled||n.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.select(t.value)}),e.appendChild(n)})}}customElements.get("p-select")||customElements.define("p-select",PSelect);export{PSelect as default};

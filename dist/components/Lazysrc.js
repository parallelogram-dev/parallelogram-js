function t(t){return t.replace(/-([a-z])/g,t=>t[1].toUpperCase())}function e(t=document){return Array.from(t.querySelectorAll(["a[href]","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])",'[tabindex]:not([tabindex="-1"]):not([disabled])'].join(",")))}class BaseComponent{constructor({eventBus:t,logger:e,router:s}){this.eventBus=t,this.logger=e,this.router=s,this.elements=new WeakMap,this.states=this.elements,this._keys=null}mount(t){if(this.elements.has(t))return this.update(t);const e=this._init(t);this.elements.set(t,e)}update(t){}unmount(t){const e=this.elements.get(t);if(e)try{e.cleanup?.()}finally{this.elements.delete(t)}}destroy(){for(const t of this._elementsKeys())this.unmount(t)}_elementsKeys(){return this._keys||(this._keys=new Set),this._keys}_track(t){this._keys||(this._keys=new Set),this._keys.add(t)}_untrack(t){this._keys?.delete(t)}_init(t){const e=new AbortController;return this._track(t),{cleanup:()=>{e.abort(),this._untrack(t)},controller:e}}getState(t){return this.elements.get(t)}_getDataAttr(e,s,r){return function(e,s,r){const n=s.includes("-")?t(s):s,o=e.dataset[n];return void 0===o?r:"true"===o||"false"!==o&&(isNaN(o)||""===o?o:Number(o))}(e,s,r)}_camelCase(e){return t(e)}_debounce(t,e=300){return function(t,e=300){let s;return function(...r){clearTimeout(s),s=setTimeout(()=>{clearTimeout(s),t.apply(this,r)},e)}}(t,e)}_throttle(t,e=100){return function(t,e=100){let s;return function(...r){s||(t.apply(this,r),s=!0,setTimeout(()=>{s=!1},e))}}(t,e)}_delay(t){return function(t){return new Promise(e=>setTimeout(e,t))}(t)}_getTargetElement(t,e,s={}){const r=`${e}-view`,n=this.getAttr(t,r);if(n){const t=document.querySelector(`[data-view="${n}"]`);return!t&&s.required,t}const o=this.getAttr(t,e);if(!o)return s.required,null;const i=document.querySelector(o);return!i&&s.required,i}_getConfigFromAttrs(t,e){const s={};for(const[r,n]of Object.entries(e)){const e=this.constructor.defaults?.[r];s[r]=this.getAttr(t,n,e)}return s}_requireState(t,e="method"){return this.getState(t)}_generateId(t="elem"){return function(t="elem"){return`${t}-${Date.now()}-${Math.random().toString(36).slice(2,9)}`}(t)}async _waitForTransition(t,e=2e3){return async function(t,e=2e3){return new Promise(s=>{const r=()=>{t.removeEventListener("animationend",r),t.removeEventListener("transitionend",r),s()};t.addEventListener("animationend",r,{once:!0}),t.addEventListener("transitionend",r,{once:!0}),setTimeout(()=>{t.removeEventListener("animationend",r),t.removeEventListener("transitionend",r),s()},e)})}(t,e)}async _fadeIn(t,e=300){return async function(t,e=300){return t.style.opacity="0",t.style.transition=`opacity ${e}ms ease-in-out`,t.offsetHeight,t.style.opacity="1",new Promise(s=>{setTimeout(()=>{t.style.transition="",s()},e)})}(t,e)}async _fadeOut(t,e=300){return async function(t,e=300){return t.style.opacity="1",t.style.transition=`opacity ${e}ms ease-in-out`,t.offsetHeight,t.style.opacity="0",new Promise(s=>{setTimeout(()=>{t.style.transition="",s()},e)})}(t,e)}_getFocusableElements(t=document){return e(t)}_trapFocus(t,s){return function(t,s){const r=e(t);if(!r.length)return;const n=r[0],o=r[r.length-1],i=t.contains(document.activeElement)?document.activeElement:null;!s.shiftKey||i!==n&&i?s.shiftKey||i!==o||(n.focus(),s.preventDefault()):(o.focus(),s.preventDefault())}(t,s)}_restoreFocus(t){return function(t){t&&"function"==typeof t.focus&&requestAnimationFrame(()=>t.focus())}(t)}_createElement(t,e={},s=""){return function(t,e={},s=""){const r=document.createElement(t);for(const[t,s]of Object.entries(e))"className"===t||"class"===t?r.className=s:"style"===t&&"object"==typeof s?Object.assign(r.style,s):"dataset"===t&&"object"==typeof s?Object.assign(r.dataset,s):r.setAttribute(t,s);return"string"==typeof s?r.textContent=s:s instanceof HTMLElement&&r.appendChild(s),r}(t,e,s)}_dispatch(t,e,s){const r=new CustomEvent(e,{detail:s,bubbles:!0,cancelable:!0});return t.dispatchEvent(r),this.eventBus?.emit(e,{element:t,...s}),r}_getSelector(){if(this._selector)return this._selector;const t=this.constructor.name.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase();return this._selector=`data-${t}`,this._selector}setState(t,e){t.setAttribute(this._getSelector(),e)}getElementState(t){return t.getAttribute(this._getSelector())}setAttr(t,e,s){t.setAttribute(`${this._getSelector()}-${e}`,String(s))}getAttr(t,e,s=null){const r=t.getAttribute(`${this._getSelector()}-${e}`);return null!==r?r:s}removeAttr(t,e){t.removeAttribute(`${this._getSelector()}-${e}`)}hasAttr(t,e){return t.hasAttribute(`${this._getSelector()}-${e}`)}}class Lazysrc extends BaseComponent{_getSelector(){return"data-lazysrc"}static get defaults(){return{threshold:.1,rootMargin:"50px",loadingClass:"loading",loadedClass:"loaded",errorClass:"error",fadeInDuration:300,retryAttempts:3,retryDelay:1e3,useNativeLoading:!1}}constructor(t={}){super(t),this._createObserver(),this.loadingAttempts=new Map}_createObserver(){const t={root:null,rootMargin:Lazysrc.defaults.rootMargin,threshold:Lazysrc.defaults.threshold};this.observer=new IntersectionObserver(this._handleIntersection.bind(this),t)}async _init(t){const e=super._init(t),s=this._getConfiguration(t);e.config=s,e.isLoaded=!1,e.isLoading=!1,e.hasError=!1,this._isImage(t)&&"PICTURE"===t.parentElement?.tagName&&(e.pictureParent=t.parentElement),(s.useNativeLoading||t.hasAttribute("loading"))&&this._supportsNativeLoading()&&this._isImage(t)?this._setupNativeLoading(t,e):this._setupIntersectionLoading(t,e);const r=async e=>{const s=this.getState(t),r=s instanceof Promise?await s:s;!r||r.isLoaded||r.isLoading||await this._loadElement(t,r)};t.addEventListener("lazysrc:forceLoad",r);const n=e.cleanup;return e.cleanup=()=>{this.observer.unobserve(t),this.loadingAttempts.delete(t),t.removeEventListener("lazysrc:forceLoad",r),n()},this._dispatch(t,"lazysrc:mounted",{element:t,config:s,timestamp:performance.now()}),e}_getConfiguration(t){const e={...Lazysrc.defaults},s=this.getAttr(t,"threshold");s&&(e.threshold=parseFloat(s));const r=this.getAttr(t,"root-margin");r&&(e.rootMargin=r);const n=this.getAttr(t,"loading-class");n&&(e.loadingClass=n);const o=this.getAttr(t,"loaded-class");o&&(e.loadedClass=o);const i=this.getAttr(t,"error-class");i&&(e.errorClass=i);const a=this.getAttr(t,"fade-duration");a&&(e.fadeInDuration=parseInt(a,10));const c=this.getAttr(t,"retry-attempts");c&&(e.retryAttempts=parseInt(c,10));const l=this.getAttr(t,"retry-delay");return l&&(e.retryDelay=parseInt(l,10)),this.hasAttr(t,"use-native")&&(e.useNativeLoading="false"!==this.getAttr(t,"use-native")),e}_supportsNativeLoading(){return"loading"in HTMLImageElement.prototype}_isImage(t){return"IMG"===t.tagName}_setupNativeLoading(t,e){this._isImage(t)&&(t.hasAttribute("loading")||(t.loading="lazy"),this._applySources(t,e),t.addEventListener("load",()=>{this._onElementLoaded(t,e)}),t.addEventListener("error",()=>{this._onElementError(t,e)}))}_setupIntersectionLoading(t,e){this._storeAndClearSources(t,e),e.config.threshold!==Lazysrc.defaults.threshold||e.config.rootMargin!==Lazysrc.defaults.rootMargin?(e.customObserver=new IntersectionObserver(this._handleIntersection.bind(this),{root:null,rootMargin:e.config.rootMargin,threshold:e.config.threshold}),e.customObserver.observe(t)):this.observer.observe(t)}_storeAndClearSources(t,e){if("IMG"===t.tagName){const s=e.pictureParent;if(s){const t=s.querySelectorAll("source");e.originalSources=[],t.forEach((t,s)=>{t.srcset&&!t.dataset.lazysrcSrcset&&(e.originalSources[s]={srcset:t.srcset,sizes:t.sizes||null},t.removeAttribute("srcset"))})}t.src&&!this.hasAttr(t,"src")&&(e.originalSrc=t.src,t.removeAttribute("src")),t.srcset&&!this.hasAttr(t,"srcset")&&(e.originalSrcset=t.srcset,t.removeAttribute("srcset")),t.sizes&&!this.hasAttr(t,"sizes")&&(e.originalSizes=t.sizes)}else if("PICTURE"===t.tagName){const s=t.querySelectorAll("source");e.originalSources=[],s.forEach((t,s)=>{t.srcset&&!t.dataset.lazysrcSrcset&&(e.originalSources[s]={srcset:t.srcset,sizes:t.sizes||null},t.removeAttribute("srcset"))});const r=t.querySelector("img");r&&(r.src&&!r.dataset.lazysrcSrc&&(e.originalSrc=r.src,r.removeAttribute("src")),r.srcset&&!r.dataset.lazysrcSrcset&&(e.originalSrcset=r.srcset,r.removeAttribute("srcset")))}}async _handleIntersection(t){for(const e of t)if(e.isIntersecting){const t=e.target,s=this.getState(t),r=s instanceof Promise?await s:s;!r||r.isLoaded||r.isLoading||await this._loadElement(t,r)}}async _loadElement(t,e){if(e&&e.config&&!e.isLoading&&!e.isLoaded){e.isLoading=!0,e.loadStartTime=performance.now(),t.classList.add(e.config.loadingClass),this._dispatch(t,"lazysrc:loading-start",{element:t,timestamp:performance.now()});try{this.hasAttr(t,"bg")?await this._loadBackgroundImage(t,e):"PICTURE"===t.tagName?await this._loadPictureElement(t,e):this._isImage(t)?await this._loadImageElement(t,e):await this._loadBackgroundImage(t,e),this._onElementLoaded(t,e)}catch(s){this._onElementError(t,e,s)}}}_loadImageElement(t,e){return new Promise((s,r)=>{if(e.pictureParent)this._applyPictureSources(e.pictureParent,e),t.onload=()=>{s()},t.onerror=()=>{r(new Error("Picture image failed to load"))};else{const n=new Image;n.onload=()=>{this._applySources(t,e),s()},n.onerror=()=>{r(new Error("Image failed to load"))};const o=this.getAttr(t,"src")||e.originalSrc,i=this.getAttr(t,"srcset")||e.originalSrcset,a=this.getAttr(t,"sizes")||e.originalSizes;if(i&&(n.srcset=i,a&&(n.sizes=a)),o)n.src=o;else if(!i)return void r(new Error("No src or srcset specified"))}})}_loadPictureElement(t,e){return new Promise((s,r)=>{const n=t.querySelector("img");n?(this._applyPictureSources(t,e),n.onload=()=>{s()},n.onerror=()=>{r(new Error("Picture failed to load"))}):r(new Error("No img element found in picture"))})}_loadBackgroundImage(t,e){return new Promise((e,s)=>{const r=this.getAttr(t,"bg");if(!r)return void s(new Error("No background image URL specified"));const n=new Image;n.onload=()=>{t.style.backgroundImage=`url("${r}")`,e()},n.onerror=()=>{s(new Error("Background image failed to load"))},n.src=r})}_applySources(t,e){const s=this.getAttr(t,"srcset");s?t.srcset=s:e.originalSrcset&&(t.srcset=e.originalSrcset);const r=this.getAttr(t,"sizes");r?t.sizes=r:e.originalSizes&&(t.sizes=e.originalSizes);const n=this.getAttr(t,"src");n?t.src=n:e.originalSrc&&(t.src=e.originalSrc)}_applyPictureSources(t,e){t.querySelectorAll("source").forEach((t,s)=>{t.dataset.lazysrcSrcset?(t.srcset=t.dataset.lazysrcSrcset,t.dataset.lazysrcSizes&&(t.sizes=t.dataset.lazysrcSizes)):e.originalSources&&e.originalSources[s]&&(t.srcset=e.originalSources[s].srcset,e.originalSources[s].sizes&&(t.sizes=e.originalSources[s].sizes))});const s=t.querySelector("img");s&&this._applySources(s,e)}_onElementLoaded(t,e){e.isLoading=!1,e.isLoaded=!0,e.hasError=!1;const s=e.loadStartTime?performance.now()-e.loadStartTime:0;t.classList.remove(e.config.loadingClass),t.classList.add(e.config.loadedClass),e.config.fadeInDuration>0&&this._applyFadeInEffect(t,e.config.fadeInDuration),this.observer.unobserve(t),e.customObserver&&e.customObserver.unobserve(t),this.loadingAttempts.delete(t),this._dispatch(t,"lazysrc:loaded",{element:t,timestamp:performance.now(),loadTime:Math.round(s)}),!1!==e.config.autoDetach&&setTimeout(()=>{this._detachElement(t,e)},100)}_onElementError(t,e,s){e.isLoading=!1,e.hasError=!0,t.classList.remove(e.config.loadingClass),t.classList.add(e.config.errorClass);const r=this.loadingAttempts.get(t)||0;if(r<e.config.retryAttempts)return this.loadingAttempts.set(t,r+1),void setTimeout(()=>{e.isLoading=!1,e.hasError=!1,t.classList.remove(e.config.errorClass),this._loadElement(t,e)},e.config.retryDelay*(r+1));this._dispatch(t,"lazysrc:error",{element:t,error:s?.message||"Load failed",timestamp:performance.now()})}_applyFadeInEffect(t,e){t.style.opacity="0",t.style.transition=`opacity ${e}ms ease-in-out`,t.offsetHeight,t.style.opacity="1",setTimeout(()=>{t.style.transition=""},e)}async loadElement(t){const e=this.getState(t),s=e instanceof Promise?await e:e;!s||s.isLoaded||s.isLoading||await this._loadElement(t,s)}async loadAll(t=document){const e=t.querySelectorAll('[data-lazysrc-enhanced="true"]');for(const t of e){const e=this.getState(t),s=e instanceof Promise?await e:e;!s||s.isLoaded||s.isLoading||await this._loadElement(t,s)}}update(t=document){t.querySelectorAll('[data-lazysrc]:not([data-lazysrc-enhanced="true"])').forEach(t=>{this.mount(t)})}async isLoaded(t){const e=this.getState(t),s=e instanceof Promise?await e:e;return!!s&&s.isLoaded}async isLoading(t){const e=this.getState(t),s=e instanceof Promise?await e:e;return!!s&&s.isLoading}async hasError(t){const e=this.getState(t),s=e instanceof Promise?await e:e;return!!s&&s.hasError}getStatus(){const t=document.querySelectorAll('[data-lazysrc-enhanced="true"]');let e=0,s=0,r=0;return t.forEach(t=>{this.isLoaded(t)&&e++,this.isLoading(t)&&s++,this.hasError(t)&&r++}),{totalElements:t.length,loadedCount:e,loadingCount:s,errorCount:r,observerActive:!!this.observer,supportsNative:this._supportsNativeLoading(),defaults:Lazysrc.defaults}}_detachElement(t,e){e.isLoaded&&(e.customObserver&&(e.customObserver.disconnect(),e.customObserver=null),this._dispatch(t,"lazysrc:detached",{element:t,timestamp:performance.now()}))}destroy(){this.observer&&(this.observer.disconnect(),this.observer=null),this.loadingAttempts.clear(),super.destroy()}static enhanceAll(t="[data-lazysrc]",e){const s=new Lazysrc(e);return document.querySelectorAll(t).forEach(t=>{s.mount(t)}),s}}export{Lazysrc as default};

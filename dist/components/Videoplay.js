function e(e){return e.replace(/-([a-z])/g,e=>e[1].toUpperCase())}function t(e=document){return Array.from(e.querySelectorAll(["a[href]","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])",'[tabindex]:not([tabindex="-1"]):not([disabled])'].join(",")))}class BaseComponent{constructor({eventBus:e,logger:t,router:n}){this.eventBus=e,this.logger=t,this.router=n,this.elements=new WeakMap,this.states=this.elements,this._keys=null}mount(e){if(this.elements.has(e))return this.update(e);const t=this._init(e);this.elements.set(e,t)}update(e){}unmount(e){const t=this.elements.get(e);if(t)try{t.cleanup?.()}finally{this.elements.delete(e)}}destroy(){for(const e of this._elementsKeys())this.unmount(e)}_elementsKeys(){return this._keys||(this._keys=new Set),this._keys}_track(e){this._keys||(this._keys=new Set),this._keys.add(e)}_untrack(e){this._keys?.delete(e)}_init(e){const t=new AbortController;return this._track(e),{cleanup:()=>{t.abort(),this._untrack(e)},controller:t}}getState(e){return this.elements.get(e)}_getDataAttr(t,n,s){return function(t,n,s){const i=n.includes("-")?e(n):n,r=t.dataset[i];return void 0===r?s:"true"===r||"false"!==r&&(isNaN(r)||""===r?r:Number(r))}(t,n,s)}_camelCase(t){return e(t)}_debounce(e,t=300){return function(e,t=300){let n;return function(...s){clearTimeout(n),n=setTimeout(()=>{clearTimeout(n),e.apply(this,s)},t)}}(e,t)}_throttle(e,t=100){return function(e,t=100){let n;return function(...s){n||(e.apply(this,s),n=!0,setTimeout(()=>{n=!1},t))}}(e,t)}_delay(e){return function(e){return new Promise(t=>setTimeout(t,e))}(e)}_getTargetElement(e,t,n={}){const s=`${t}-view`,i=this.getAttr(e,s);if(i){const e=document.querySelector(`[data-view="${i}"]`);return!e&&n.required,e}const r=this.getAttr(e,t);if(!r)return n.required,null;const a=document.querySelector(r);return!a&&n.required,a}_getConfigFromAttrs(e,t){const n={};for(const[s,i]of Object.entries(t)){const t=this.constructor.defaults?.[s];n[s]=this.getAttr(e,i,t)}return n}_requireState(e,t="method"){return this.getState(e)}_generateId(e="elem"){return function(e="elem"){return`${e}-${Date.now()}-${Math.random().toString(36).slice(2,9)}`}(e)}async _waitForTransition(e,t=2e3){return async function(e,t=2e3){return new Promise(n=>{const s=()=>{e.removeEventListener("animationend",s),e.removeEventListener("transitionend",s),n()};e.addEventListener("animationend",s,{once:!0}),e.addEventListener("transitionend",s,{once:!0}),setTimeout(()=>{e.removeEventListener("animationend",s),e.removeEventListener("transitionend",s),n()},t)})}(e,t)}async _fadeIn(e,t=300){return async function(e,t=300){return e.style.opacity="0",e.style.transition=`opacity ${t}ms ease-in-out`,e.offsetHeight,e.style.opacity="1",new Promise(n=>{setTimeout(()=>{e.style.transition="",n()},t)})}(e,t)}async _fadeOut(e,t=300){return async function(e,t=300){return e.style.opacity="1",e.style.transition=`opacity ${t}ms ease-in-out`,e.offsetHeight,e.style.opacity="0",new Promise(n=>{setTimeout(()=>{e.style.transition="",n()},t)})}(e,t)}_getFocusableElements(e=document){return t(e)}_trapFocus(e,n){return function(e,n){const s=t(e);if(!s.length)return;const i=s[0],r=s[s.length-1],a=e.contains(document.activeElement)?document.activeElement:null;!n.shiftKey||a!==i&&a?n.shiftKey||a!==r||(i.focus(),n.preventDefault()):(r.focus(),n.preventDefault())}(e,n)}_restoreFocus(e){return function(e){e&&"function"==typeof e.focus&&requestAnimationFrame(()=>e.focus())}(e)}_createElement(e,t={},n=""){return function(e,t={},n=""){const s=document.createElement(e);for(const[e,n]of Object.entries(t))"className"===e||"class"===e?s.className=n:"style"===e&&"object"==typeof n?Object.assign(s.style,n):"dataset"===e&&"object"==typeof n?Object.assign(s.dataset,n):s.setAttribute(e,n);return"string"==typeof n?s.textContent=n:n instanceof HTMLElement&&s.appendChild(n),s}(e,t,n)}_dispatch(e,t,n){const s=new CustomEvent(t,{detail:n,bubbles:!0,cancelable:!0});return e.dispatchEvent(s),s}_getSelector(){if(this._selector)return this._selector;const e=this.constructor.name.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase();return this._selector=`data-${e}`,this._selector}setState(e,t){e.setAttribute(this._getSelector(),t)}getElementState(e){return e.getAttribute(this._getSelector())}setAttr(e,t,n){e.setAttribute(`${this._getSelector()}-${t}`,String(n))}getAttr(e,t,n=null){const s=e.getAttribute(`${this._getSelector()}-${t}`);return null!==s?s:n}removeAttr(e,t){e.removeAttribute(`${this._getSelector()}-${t}`)}hasAttr(e,t){return e.hasAttribute(`${this._getSelector()}-${t}`)}}class Videoplay extends BaseComponent{_getSelector(){return"data-videoplay"}static get defaults(){return{playThreshold:.3,pauseThreshold:.1,pauseOnExit:!0,muteWhenPlaying:null,restoreVolumeOnPause:!1,rootMargin:"0px",enableInBackground:!1,preloadOnMount:!0,requireUserInteraction:!1}}constructor(e={}){super(e),this._createObserver(),this._setupVisibilityHandling()}_createObserver(){const e={root:null,rootMargin:Videoplay.defaults.rootMargin,threshold:[0,.1,.3,.5,.7,1]};this.observer=new IntersectionObserver(this._handleIntersection.bind(this),e)}_setupVisibilityHandling(){this.isPageVisible=!document.hidden;const e=()=>{this.isPageVisible=!document.hidden,this.isPageVisible?this._resumeVisibleVideos():this._pauseAllBackgroundVideos()};document.addEventListener("visibilitychange",e),this.visibilityHandler=e}_init(e){const t=super._init(e),n=this.getAttr(e,"target"),s=n?document.querySelector(n):"VIDEO"===e.tagName?e:e.querySelector("video");if(!s)return t;const i=this.getAttr(e,"threshold",Videoplay.defaults.playThreshold),r=this.getAttr(e,"pause-threshold",Videoplay.defaults.pauseThreshold),a=this.getAttr(e,"autopause",Videoplay.defaults.pauseOnExit),o=this.getAttr(e,"automute",Videoplay.defaults.muteWhenPlaying),l=this.getAttr(e,"restore-volume",Videoplay.defaults.restoreVolumeOnPause),u=this.getAttr(e,"background",Videoplay.defaults.enableInBackground),c=this.getAttr(e,"preload",Videoplay.defaults.preloadOnMount),d=this.getAttr(e,"require-interaction",Videoplay.defaults.requireUserInteraction),h=s.hasAttribute("autoplay");t.video=s,t.videoSelector=n,t.playThreshold=parseFloat(i),t.pauseThreshold=parseFloat(r),t.pauseOnExit=Boolean(a),t.muteWhenPlaying=null===o?null:Boolean(o),t.restoreVolumeOnPause=Boolean(l),t.enableInBackground=Boolean(u),t.preloadOnMount=Boolean(c),t.requireUserInteraction=Boolean(d),t.hasAutoplay=h,t.isPlaying=!1,t.isIntersecting=!1,t.intersectionRatio=0,t.originalMuted=s.muted,t.originalVolume=s.volume,t.hasUserInteracted=!1,this._setupVideo(s,t),e.setAttribute("data-videoplay-enhanced","true"),this.observer.observe(e);const y=t.cleanup;return t.cleanup=()=>{this.observer.unobserve(e),this._resetVideo(s,t),y()},t}_setupVideo(e,t){t.preloadOnMount&&!e.getAttribute("preload")&&(e.preload="metadata"),null===t.muteWhenPlaying&&t.hasAutoplay&&!e.hasAttribute("muted")&&(e.muted=!0,t.originalMuted=!1);const n=()=>{t.isPlaying=!0,this._emitVideoEvent(e,"play",{reason:"browser-play"})},s=()=>{t.isPlaying=!1,this._emitVideoEvent(e,"pause",{reason:"browser-pause"})},i=t=>{this._emitVideoEvent(e,"error",{error:t})},r=()=>{t.hasUserInteracted=!0};e.addEventListener("play",n),e.addEventListener("pause",s),e.addEventListener("error",i),e.addEventListener("click",r),e.addEventListener("play",r),t.playHandler=n,t.pauseHandler=s,t.errorHandler=i,t.userInteractionHandler=r}_handleIntersection(e){e.forEach(e=>{const t=e.target,n=this.getState(t);if(!n)return;n.isIntersecting=e.isIntersecting,n.intersectionRatio=e.intersectionRatio;const s=n.hasAutoplay&&(!n.requireUserInteraction||n.hasUserInteracted),i=e.isIntersecting&&e.intersectionRatio>=n.playThreshold&&(this.isPageVisible||n.enableInBackground)&&s,r=(!e.isIntersecting||e.intersectionRatio<n.pauseThreshold)&&n.pauseOnExit&&(!n.requireUserInteraction||n.hasUserInteracted);i&&!n.isPlaying?this._playVideo(t,n,"scroll-in"):r&&n.isPlaying&&this._pauseVideo(t,n,"scroll-out")})}async _playVideo(e,t,n="manual"){const{video:s}=t;try{!0===t.muteWhenPlaying?s.muted=!0:!1===t.muteWhenPlaying&&(s.muted=!1);const e=s.play();void 0!==e&&await e,t.isPlaying=!0,this._emitVideoEvent(s,"play",{reason:n,intersectionRatio:t.intersectionRatio,muted:s.muted})}catch(e){this._emitVideoEvent(s,"play-error",{reason:n,error:e.message})}}_pauseVideo(e,t,n="manual"){const{video:s}=t;try{s.pause(),t.isPlaying=!1,t.restoreVolumeOnPause&&!t.originalMuted&&(s.muted=!1,s.volume=t.originalVolume),this._emitVideoEvent(s,"pause",{reason:n,intersectionRatio:t.intersectionRatio})}catch(e){}}_emitVideoEvent(e,t,n){e.dispatchEvent(new CustomEvent(`videoplay:${t}`,{detail:n,bubbles:!0}))}_pauseAllBackgroundVideos(){document.querySelectorAll('[data-videoplay-enhanced="true"]').forEach(e=>{const t=this.getState(e);t&&t.isPlaying&&!t.enableInBackground&&this._pauseVideo(e,t,"page-hidden")})}_resumeVisibleVideos(){document.querySelectorAll('[data-videoplay-enhanced="true"]').forEach(e=>{const t=this.getState(e);t&&!t.isPlaying&&t.isIntersecting&&t.intersectionRatio>=t.playThreshold&&t.hasAutoplay&&this._playVideo(e,t,"page-visible")})}async play(e){const t=this.getState(e);t&&await this._playVideo(e,t,"manual")}pause(e){const t=this.getState(e);t&&this._pauseVideo(e,t,"manual")}isPlaying(e){const t=this.getState(e);return!!t&&t.isPlaying}getIntersectionRatio(e){const t=this.getState(e);return t?t.intersectionRatio:0}updatePlayThreshold(e,t){const n=this.getState(e);n&&(n.playThreshold=Math.max(0,Math.min(1,t)))}_resetVideo(e,t){try{t.playHandler&&e.removeEventListener("play",t.playHandler),t.pauseHandler&&e.removeEventListener("pause",t.pauseHandler),t.errorHandler&&e.removeEventListener("error",t.errorHandler),t.userInteractionHandler&&(e.removeEventListener("click",t.userInteractionHandler),e.removeEventListener("play",t.userInteractionHandler)),e.muted=t.originalMuted,e.volume=t.originalVolume}catch(e){}}getStatus(){const e=document.querySelectorAll('[data-videoplay-enhanced="true"]');let t=0,n=0,s=0,i=0;return e.forEach(e=>{const r=this.getState(e);r&&(i++,r.isPlaying&&t++,r.isIntersecting&&n++,r.hasAutoplay&&s++)}),{totalVideos:i,playingCount:t,intersectingCount:n,autoplayCount:s,pageVisible:this.isPageVisible,observerActive:!!this.observer,defaults:Videoplay.defaults}}destroy(){this.observer&&(this.observer.disconnect(),this.observer=null),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),super.destroy()}static enhanceAll(e="[data-videoplay]",t){const n=new Videoplay(t);return document.querySelectorAll(e).forEach(e=>{n.mount(e)}),n}}export{Videoplay as default};

class ComponentRegistry{constructor(t={}){this.basePath=t.basePath||"../components/",this.defaultPriority=t.defaultPriority||"normal",this.fileExtension=t.fileExtension||".js",this.useMinified=t.useMinified||!1,this.registry=[]}component(t,e,n={}){if(!n.loader)throw new Error(`Component '${t}' must provide a loader function`);const r={name:t,selector:e,priority:n.priority||this.defaultPriority,dependsOn:n.dependsOn,loader:n.loader};return this.registry.push(r),this}toPascalCase(t){return t.split(/[-_\s]+/).map(t=>t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()).join("")}build(){return[...this.registry]}clear(){return this.registry=[],this}getStats(){const t=this.registry.reduce((t,e)=>(t[e.priority]=(t[e.priority]||0)+1,t),{}),e=this.registry.filter(t=>t.dependsOn?.length>0).length;return{totalComponents:this.registry.length,priorities:t,withDependencies:e,basePath:this.basePath}}validate(){const t=new Set(this.registry.map(t=>t.name)),e=[],n=[];this.registry.forEach(n=>{n.dependsOn&&n.dependsOn.forEach(r=>{t.has(r)||e.push(`Component '${n.name}' depends on '${r}' which is not in the registry`)})});const r=this.detectCycles();r.length>0&&e.push(`Circular dependencies detected: ${r.join(", ")}`);const o=new Map;return this.registry.forEach(t=>{o.has(t.selector)?n.push(`Duplicate selector '${t.selector}' used by '${t.name}' and '${o.get(t.selector)}'`):o.set(t.selector,t.name)}),{valid:0===e.length,errors:e,warnings:n}}detectCycles(){const t=new Set,e=new Set,n=[],r=(o,s=[])=>{if(e.has(o)){const t=s.indexOf(o);return void n.push(s.slice(t).concat(o).join(" -> "))}if(t.has(o))return;t.add(o),e.add(o);const i=this.registry.find(t=>t.name===o);i?.dependsOn&&i.dependsOn.forEach(t=>{r(t,[...s,o])}),e.delete(o)};return this.registry.forEach(e=>{t.has(e.name)||r(e.name)}),n}fork(t={}){return new ComponentRegistry({basePath:this.basePath,defaultPriority:this.defaultPriority,fileExtension:this.fileExtension,useMinified:this.useMinified,...t})}static create(t="dev",e={}){const n={...{dev:{basePath:"/dist/esm/components/",useMinified:!1,fileExtension:".js"},production:{basePath:"/dist/esm/components/",useMinified:!0,fileExtension:".js"},custom:{}}[t],...e};return new ComponentRegistry(n)}}class DevLogger{constructor(t,e=!1){this.namespace=t,this.enabled=e}setEnabled(t){this.enabled=Boolean(t)}_getPrefix(t){return`${(new Date).toISOString()} [${this.namespace}] ${t}:`}debug(...t){this.enabled&&console.debug(this._getPrefix("DEBUG"),...t)}log(...t){this.enabled&&console.log(this._getPrefix("LOG"),...t)}info(...t){this.enabled&&console.info(this._getPrefix("INFO"),...t)}warn(...t){this.enabled&&console.warn(this._getPrefix("WARN"),...t)}error(...t){console.error(this._getPrefix("ERROR"),...t)}child(t){return new DevLogger(`${this.namespace}:${t}`,this.enabled)}group(t,e){this.enabled&&console.groupCollapsed&&(console.groupCollapsed(`[${this.namespace}] ${t}`),e&&"object"==typeof e&&console.log("Details:",e))}groupEnd(){this.enabled&&console.groupEnd&&console.groupEnd()}}class WebComponentLoader{constructor(t={},e={}){this.componentMap=t,this.options={eager:e.eager??!0,observeDOM:e.observeDOM??!1,rootElement:e.rootElement??document.documentElement,onLoad:e.onLoad??null,onError:e.onError??null},this.loadedComponents=new Set,this.loadingComponents=new Map,this.observer=null}init(){this.options.eager&&this.scanAndLoad(),this.options.observeDOM&&this.startObserving()}scanAndLoad(t=this.options.rootElement){Object.keys(this.componentMap).forEach(e=>{if(!this.loadedComponents.has(e)){t.querySelectorAll(e).length>0&&this.loadComponent(e)}})}async loadComponent(t){if(this.loadedComponents.has(t))return;if(this.loadingComponents.has(t))return this.loadingComponents.get(t);if(!this.componentMap[t])return void console.warn(`[WebComponentLoader] No loader defined for component: ${t}`);const e=this.componentMap[t]().then(()=>{this.loadedComponents.add(t),this.loadingComponents.delete(t),this.options.onLoad&&this.options.onLoad(t)}).catch(e=>{this.loadingComponents.delete(t),this.options.onError?this.options.onError(t,e):console.error(`[WebComponentLoader] Failed to load component: ${t}`,e)});return this.loadingComponents.set(t,e),e}startObserving(){this.observer||(this.observer=new MutationObserver(t=>{const e=new Set;t.forEach(t=>{t.addedNodes.forEach(t=>{t.nodeType===Node.ELEMENT_NODE&&e.add(t)})}),e.forEach(t=>{Object.keys(this.componentMap).forEach(e=>{this.loadedComponents.has(e)||(t.tagName?.toLowerCase()===e||t.querySelector&&t.querySelector(e))&&this.loadComponent(e)})})}),this.observer.observe(this.options.rootElement,{childList:!0,subtree:!0}))}stopObserving(){this.observer&&(this.observer.disconnect(),this.observer=null)}register(t,e){this.componentMap[t]=e}unregister(t){delete this.componentMap[t]}isLoaded(t){return this.loadedComponents.has(t)}isLoading(t){return this.loadingComponents.has(t)}destroy(){this.stopObserving(),this.loadedComponents.clear(),this.loadingComponents.clear()}}class EventManager{constructor(){this.listeners=new Map}on(t,e){this.listeners.has(t)||this.listeners.set(t,new Set);return this.listeners.get(t).add(e),()=>this.off(t,e)}once(t,e){const n=this.on(t,t=>{n(),e(t)});return n}off(t,e){const n=this.listeners.get(t);n&&(n.delete(e),0===n.size&&this.listeners.delete(t))}emit(t,e){const n=this.listeners.get(t);if(!n)return;const r=[...n];for(const n of r)try{n(e)}catch(e){console.error(`[EventManager] Error in listener for "${t}":`,e)}}clear(t){t?this.listeners.delete(t):this.listeners.clear()}}class RouterManager{constructor({eventBus:t,logger:e,options:n={}}){this.eventBus=t,this.logger=e,this.options={baseUrl:"",timeout:1e4,retryAttempts:0,fragmentSelector:"[data-router-fragment]",loadingClass:"router-loading",errorClass:"router-error",scrollDuration:800,scrollEasing:"ease-in-out",...n},this.controller=null,this.currentUrl=new URL(location.href),this.isNavigating=!1,this.scrollAnimationFrame=null,this.boundPopState=this._onPopState.bind(this),this.boundLinkClick=this._onLinkClick.bind(this),this._initialize()}_initialize(){window.addEventListener("popstate",this.boundPopState),window.addEventListener("pageshow",t=>{t.persisted&&this.eventBus.emit("router:bfcache-restore",{url:this.currentUrl})}),window.addEventListener("pagehide",()=>{this.eventBus.emit("router:bfcache-store",{url:this.currentUrl})}),this._enhanceLinks(),this.eventBus.on("dom:content-loaded",()=>{this._enhanceLinks()}),this.eventBus.emit("router:initialized",{currentUrl:this.currentUrl})}_enhanceLinks(){document.querySelectorAll("a[href]:not([data-router-enhanced])").forEach(t=>{if(this._shouldEnhanceLink(t))t.addEventListener("click",this.boundLinkClick),t.setAttribute("data-router-enhanced","true");else{const e=t.getAttribute("href");e&&e.startsWith("#")&&(t.addEventListener("click",this._onAnchorClick.bind(this)),t.setAttribute("data-router-enhanced","anchor"))}})}_shouldEnhanceLink(t){const e=t.getAttribute("href");if(!e||e.startsWith("mailto:")||e.startsWith("tel:")||e.startsWith("javascript:"))return!1;if(e.startsWith("#"))return!1;if(t.hasAttribute("data-router-skip"))return!1;try{if(new URL(e,location.href).origin!==location.origin&&!t.hasAttribute("data-router-enhance"))return!1}catch{return!1}return!0}_smoothScrollTo(t){t.scrollIntoView({behavior:"smooth",block:"start"})}_onAnchorClick(t){if(t.ctrlKey||t.metaKey||t.shiftKey||t.altKey)return;if(2===t.which)return;const e=t.currentTarget,n=e.getAttribute("href");if(!n||!n.startsWith("#"))return;const r=n.substring(1),o=r?document.getElementById(r):null;o&&(t.preventDefault(),this._smoothScrollTo(o),r&&history.replaceState(null,"",n),this.eventBus.emit("router:anchor-scroll",{target:o,hash:n,trigger:"anchor-click",element:e}))}_onLinkClick(t){if(t.ctrlKey||t.metaKey||t.shiftKey||t.altKey)return;if(2===t.which)return;const e=t.currentTarget,n=e.getAttribute("href"),r=e.getAttribute("data-view-target")||"main",o=e.closest("[data-router-immutable-url]"),s=e.hasAttribute("data-router-immutable-url")?"false"!==e.getAttribute("data-router-immutable-url"):!!o&&"false"!==o.getAttribute("data-router-immutable-url");try{const o=new URL(n,location.href);if(o.pathname===location.pathname&&o.hash)return;t.preventDefault(),this.navigate(o,{viewTarget:r,replace:e.hasAttribute("data-router-replace"),immutableUrl:s,trigger:"link-click",element:e})}catch(t){}}_onPopState(t){const e=new URL(location.href);this.currentUrl=e,this.eventBus.emit("router:popstate",{url:e,state:t.state,trigger:"popstate"})}async get(t,e={}){const n="string"==typeof t?t:t.toString();this._abortInFlight();const r=new AbortController;this.controller=r;const o=setTimeout(()=>{r.abort()},this.options.timeout);try{const t=await fetch(n,{method:"GET",signal:r.signal,credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest",Accept:"text/html,application/json,*/*",...e.headers},...e});if(clearTimeout(o),!t.ok)throw this._createHttpError(t);let s;return s=(t.headers.get("content-type")||"").includes("application/json")?await t.json():await t.text(),{response:t,data:s}}catch(t){if(clearTimeout(o),"AbortError"===t.name)throw t;throw t}finally{this.controller=null}}async navigate(t,e={}){const{replace:n=!1,trigger:r="programmatic",element:o=null,force:s=!1,immutableUrl:i=!1}=e,a="string"==typeof t?new URL(t,location.href):t,c=a.toString();if((s||c!==this.currentUrl.toString())&&!this.isNavigating){this.isNavigating=!0,this.currentUrl=a,this.eventBus.emit("router:navigate-start",{url:a,trigger:r,element:o,replace:n}),o&&o.classList.add(this.options.loadingClass),document.body.classList.add(this.options.loadingClass);try{const{data:t}=await this.get(c);if("string"!=typeof t)throw new Error("Expected HTML string response for navigation");if(!i){const t={timestamp:Date.now(),trigger:r};n?history.replaceState(t,"",c):history.pushState(t,"",c)}return this.eventBus.emit("router:navigate-success",{url:a,html:t,trigger:r,element:o,replace:n,viewTarget:e.viewTarget,immutableUrl:i}),t}catch(t){throw o&&o.classList.add(this.options.errorClass),document.body.classList.add(this.options.errorClass),this.eventBus.emit("router:navigate-error",{url:a,error:t,trigger:r,element:o}),t}finally{o&&o.classList.remove(this.options.loadingClass,this.options.errorClass),document.body.classList.remove(this.options.loadingClass,this.options.errorClass),this.isNavigating=!1,this.eventBus.emit("router:navigate-end",{url:a,trigger:r})}}}back(){history.back()}forward(){history.forward()}getCurrentUrl(){return this.currentUrl}isNavigating(){return this.isNavigating}_abortInFlight(){this.controller&&(this.controller.abort(),this.controller=null)}_createHttpError(t){const e=new Error(`HTTP ${t.status} ${t.statusText}`);return e.name="HttpError",e.status=t.status,e.statusText=t.statusText,e.response=t,e.url=t.url,e}destroy(){window.removeEventListener("popstate",this.boundPopState),document.querySelectorAll('a[data-router-enhanced="true"]').forEach(t=>{t.removeEventListener("click",this.boundLinkClick),t.removeAttribute("data-router-enhanced")}),document.querySelectorAll('a[data-router-enhanced="anchor"]').forEach(t=>{t.removeEventListener("click",this._onAnchorClick),t.removeAttribute("data-router-enhanced")}),this.scrollAnimationFrame&&(cancelAnimationFrame(this.scrollAnimationFrame),this.scrollAnimationFrame=null),this._abortInFlight(),this.eventBus.off("dom:content-loaded"),this.eventBus.emit("router:destroyed",{})}}function t(t){return t.replace(/-([a-z])/g,t=>t[1].toUpperCase())}function e(t=document){return Array.from(t.querySelectorAll(["a[href]","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])",'[tabindex]:not([tabindex="-1"]):not([disabled])'].join(",")))}class BaseComponent{constructor({eventBus:t,logger:e,router:n}){this.eventBus=t,this.logger=e,this.router=n,this.elements=new WeakMap,this.states=this.elements,this._keys=null}mount(t){if(this.elements.has(t))return this.update(t);const e=this._init(t);this.elements.set(t,e)}update(t){}unmount(t){const e=this.elements.get(t);if(e)try{e.cleanup?.()}finally{this.elements.delete(t)}}destroy(){for(const t of this._elementsKeys())this.unmount(t)}_elementsKeys(){return this._keys||(this._keys=new Set),this._keys}_track(t){this._keys||(this._keys=new Set),this._keys.add(t)}_untrack(t){this._keys?.delete(t)}_init(t){const e=new AbortController;return this._track(t),{cleanup:()=>{e.abort(),this._untrack(t)},controller:e}}getState(t){return this.elements.get(t)}_getDataAttr(e,n,r){return function(e,n,r){const o=n.includes("-")?t(n):n,s=e.dataset[o];return void 0===s?r:"true"===s||"false"!==s&&(isNaN(s)||""===s?s:Number(s))}(e,n,r)}_camelCase(e){return t(e)}_debounce(t,e=300){return function(t,e=300){let n;return function(...r){clearTimeout(n),n=setTimeout(()=>{clearTimeout(n),t.apply(this,r)},e)}}(t,e)}_throttle(t,e=100){return function(t,e=100){let n;return function(...r){n||(t.apply(this,r),n=!0,setTimeout(()=>{n=!1},e))}}(t,e)}_delay(t){return function(t){return new Promise(e=>setTimeout(e,t))}(t)}_getTargetElement(t,e,n={}){const r=`${e}-view`,o=this.getAttr(t,r);if(o){const t=document.querySelector(`[data-view="${o}"]`);return!t&&n.required,t}const s=this.getAttr(t,e);if(!s)return n.required,null;const i=document.querySelector(s);return!i&&n.required,i}_getConfigFromAttrs(t,e){const n={};for(const[r,o]of Object.entries(e)){const e=this.constructor.defaults?.[r];n[r]=this.getAttr(t,o,e)}return n}_requireState(t,e="method"){return this.getState(t)}_generateId(t="elem"){return function(t="elem"){return`${t}-${Date.now()}-${Math.random().toString(36).slice(2,9)}`}(t)}async _waitForTransition(t,e=2e3){return async function(t,e=2e3){return new Promise(n=>{const r=()=>{t.removeEventListener("animationend",r),t.removeEventListener("transitionend",r),n()};t.addEventListener("animationend",r,{once:!0}),t.addEventListener("transitionend",r,{once:!0}),setTimeout(()=>{t.removeEventListener("animationend",r),t.removeEventListener("transitionend",r),n()},e)})}(t,e)}async _fadeIn(t,e=300){return async function(t,e=300){return t.style.opacity="0",t.style.transition=`opacity ${e}ms ease-in-out`,t.offsetHeight,t.style.opacity="1",new Promise(n=>{setTimeout(()=>{t.style.transition="",n()},e)})}(t,e)}async _fadeOut(t,e=300){return async function(t,e=300){return t.style.opacity="1",t.style.transition=`opacity ${e}ms ease-in-out`,t.offsetHeight,t.style.opacity="0",new Promise(n=>{setTimeout(()=>{t.style.transition="",n()},e)})}(t,e)}_getFocusableElements(t=document){return e(t)}_trapFocus(t,n){return function(t,n){const r=e(t);if(!r.length)return;const o=r[0],s=r[r.length-1],i=t.contains(document.activeElement)?document.activeElement:null;!n.shiftKey||i!==o&&i?n.shiftKey||i!==s||(o.focus(),n.preventDefault()):(s.focus(),n.preventDefault())}(t,n)}_restoreFocus(t){return function(t){t&&"function"==typeof t.focus&&requestAnimationFrame(()=>t.focus())}(t)}_createElement(t,e={},n=""){return function(t,e={},n=""){const r=document.createElement(t);for(const[t,n]of Object.entries(e))"className"===t||"class"===t?r.className=n:"style"===t&&"object"==typeof n?Object.assign(r.style,n):"dataset"===t&&"object"==typeof n?Object.assign(r.dataset,n):r.setAttribute(t,n);return"string"==typeof n?r.textContent=n:n instanceof HTMLElement&&r.appendChild(n),r}(t,e,n)}_dispatch(t,e,n){const r=new CustomEvent(e,{detail:n,bubbles:!0,cancelable:!0});return t.dispatchEvent(r),this.eventBus?.emit(e,{element:t,...n}),r}_getSelector(){if(this._selector)return this._selector;const t=this.constructor.name.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase();return this._selector=`data-${t}`,this._selector}setState(t,e){t.setAttribute(this._getSelector(),e)}getElementState(t){return t.getAttribute(this._getSelector())}setAttr(t,e,n){t.setAttribute(`${this._getSelector()}-${e}`,String(n))}getAttr(t,e,n=null){const r=t.getAttribute(`${this._getSelector()}-${e}`);return null!==r?r:n}removeAttr(t,e){t.removeAttribute(`${this._getSelector()}-${e}`)}hasAttr(t,e){return t.hasAttribute(`${this._getSelector()}-${e}`)}}class QueuedComponentProxy extends BaseComponent{constructor(t,e){super({eventBus:{on(){},emit(){}},logger:{info(){},error(){},enabled:!1},router:null}),this._onMount=t,this._onUnmount=e}mount(t){this._onMount(t)}unmount(t){this._onUnmount(t)}}class PageManager{constructor({containerSelector:t,registry:e,eventBus:n,logger:r,router:o,options:s={}}){this.eventBus=n,this.logger=r,this.router=o,this.containerSelector=t,this.registry=e,this.options={mountDelay:1200,scrollRestoration:!0,scrollPosition:"top",scrollElement:null,lazyLoadThreshold:"100px",retryFailedLoads:!0,maxRetryAttempts:3,batchUpdates:!0,updateThrottleMs:16,trackPerformance:!1,targetGroups:{main:["main","menubar","breadcrumb"],panel:["panel"],sidebar:["sidebar","toolbar"],modal:["modal"]},...s},this.instances=new Map,this.observer=null,this.loadingPromises=new Map,this.retryCount=new Map,this.performanceMetrics={fragmentReplacements:0,componentMounts:0,componentUnmounts:0,totalMountTime:0,averageMountTime:0},this.sessionTracking={componentsLoaded:new Set,loadHistory:[],mountCount:new Map,lastMountTime:new Map},this.throttledUpdate=this._createThrottledFunction(this._processBatchedUpdates.bind(this),this.options.updateThrottleMs),this.pendingUpdates=[],this._initialize()}_initialize(){this.eventBus.on("router:navigate-success",({html:t,url:e,trigger:n,viewTarget:r,viewTargets:o})=>{const s=this._resolveTargetGroups(o||[r||"main"]);this.replaceFragments(t,{fromNavigation:!0,url:e,trigger:n,viewTargets:s,preserveScroll:"popstate"===n&&"preserve"===this.options.scrollPosition})}),this.eventBus.on("router:popstate",async({url:t})=>{try{const{data:e}=await this.router.get(t.toString());if("string"==typeof e){const n=this._resolveTargetGroups(["main"]);this.replaceFragments(e,{fromPopstate:!0,url:t,viewTargets:n,preserveScroll:"preserve"===this.options.scrollPosition})}}catch(e){this.eventBus.emit("page:popstate-error",{url:t,error:e})}}),this.eventBus.on("component:lazy-load",({element:t,componentName:e})=>{this._handleLazyLoad(t,e)}),this._initialMount(),this.eventBus.emit("page-manager:initialized",{containerSelector:this.containerSelector,options:this.options})}get container(){const t=document.querySelector(this.containerSelector);if(!t){throw new Error(`Container not found: ${this.containerSelector}`)}return t}_resolveTargetGroups(t){const e=new Set;for(const n of t)if(this.options.targetGroups[n])for(const t of this.options.targetGroups[n])e.add(t);else e.add(n);return Array.from(e)}async replaceFragments(t,e={}){const{fromNavigation:n=!1,fromPopstate:r=!1,preserveScroll:o=!1,url:s=null,trigger:i="unknown",viewTargets:a=["main"]}=e,c=this.options.trackPerformance?performance.now():0;try{let n=null;o&&(n={x:window.scrollX,y:window.scrollY});const r=(new DOMParser).parseFromString(t,"text/html"),s=[];let i=!1;for(const n of a)try{const o=await this._processSingleFragment(r,n,t,e);s.push(o),"main"===n&&(i=!0)}catch(t){s.push({viewTarget:n,success:!1,error:t.message})}i&&(this._handleScrollRestoration(n,e),this._updateDocumentHead(t));const l=s.filter(t=>t.success);for(const t of l)this.mountAllWithin(t.targetFragment,{priority:"critical",fragmentTarget:t.viewTarget}),this.eventBus.emit("dom:content-loaded",{fragment:t.targetFragment,viewTarget:t.viewTarget,trigger:"fragment-replacement"}),this.options.mountDelay>0?setTimeout(()=>{this.mountAllWithin(t.targetFragment,{priority:"normal",fragmentTarget:t.viewTarget})},this.options.mountDelay):this.mountAllWithin(t.targetFragment,{priority:"normal",fragmentTarget:t.viewTarget});if(this.options.trackPerformance){performance.now();this.performanceMetrics.fragmentReplacements++}this.eventBus.emit("page:fragments-replaced",{results:s,viewTargets:a,duration:this.options.trackPerformance?performance.now()-c:null,options:e})}catch(t){throw this.eventBus.emit("page:fragments-replace-error",{viewTargets:a,error:t,options:e}),t}}async _processSingleFragment(t,e,n,r){const{sourceFragment:o,targetFragment:s}=this._extractTargetFragmentFromDoc(t,e);if(!o)throw new Error(`Source fragment with data-view="${e}" not found in fetched HTML`);if(!s)throw new Error(`Target fragment with data-view="${e}" not found in current document`);const i=this.options.targetGroupTransitions?.[e];this.eventBus.emit("page:fragment-will-replace",{sourceFragment:o,targetFragment:s,viewTarget:e,html:n,options:r,transitionConfig:i});try{i?.out&&await this._performFragmentTransition(s,"out",i),"main"!==e||r.preserveScroll||"top"!==this.options.scrollPosition||r.fromPopstate||(await new Promise(t=>requestAnimationFrame(t)),window.scrollTo({top:0,left:0,behavior:"instant"})),this.unmountAllWithin(s),i?.in?await this._replaceContentWithTransition(s,o,i):(s.innerHTML=o.innerHTML,this._copyFragmentAttributes(o,s)),this.eventBus.emit("page:fragment-did-replace",{targetFragment:s,viewTarget:e,options:r,transitionConfig:i})}catch(t){this.unmountAllWithin(s),s.innerHTML=o.innerHTML,this._copyFragmentAttributes(o,s)}return{viewTarget:e,success:!0,sourceFragment:o,targetFragment:s,transitionConfig:i}}async _replaceContentWithTransition(t,e,n){return new Promise(r=>{requestAnimationFrame(()=>{t.innerHTML=e.innerHTML,this._copyFragmentAttributes(e,t),this._performFragmentTransition(t,"in",n).then(r)})})}async _performFragmentTransition(t,e,n){const r=n[e],o=n.duration||300;n.easing;try{if("string"!=typeof r||r.includes("("))await this._performJSTransition(t,e,n);else{const s="in"===e?n.out:null;await this._performCSSTransition(t,r,o,e,s)}this.eventBus.emit(`page:fragment-transition-${e}`,{fragment:t,viewTarget:t.dataset.view,transitionType:r,duration:o})}catch(t){throw t}}_performCSSTransition(t,e,n,r="in",o=null){return new Promise(n=>{const s=o=>{o&&o.target!==t||(t.removeEventListener("animationend",s),t.removeEventListener("transitionend",s),"in"===r&&t.classList.remove(e),n())};t.addEventListener("animationend",s),t.addEventListener("transitionend",s),requestAnimationFrame(()=>{t.classList.add(e),"in"===r&&o&&requestAnimationFrame(()=>{t.classList.remove(o)})})})}async _performJSTransition(t,e,n){const r=n.duration||300,o=n.easing||"ease";t.style.transition=`opacity ${r}ms ${o}, transform ${r}ms ${o}`,"out"===e?(t.style.opacity="0",t.style.transform="translateX(-20px)"):(t.style.opacity="0",t.style.transform="translateX(20px)",t.getBoundingClientRect(),t.style.opacity="1",t.style.transform="translateX(0)"),await new Promise(n=>{setTimeout(()=>{t.style.transition="","in"===e&&(t.style.opacity="",t.style.transform=""),n()},r)})}_extractTargetFragmentFromDoc(t,e){let n=null,r=null;return n=t.querySelector(`[data-view="${e}"]`),n||(n=t.querySelector(`#${e}`),n||"main"!==e||(n=t.querySelector("main")||t.querySelector('[role="main"]')||t.querySelector("#app")||t.querySelector(".main-content")),n||(n=t.querySelector(`.${e}`))),r=document.querySelector(`[data-view="${e}"]`),r||(r=document.querySelector(`#${e}`),r||"main"!==e||(r=document.querySelector("main")||document.querySelector('[role="main"]')||document.querySelector("#app")||document.querySelector(".main-content")),r||(r=document.querySelector(`.${e}`))),{sourceFragment:n,targetFragment:r}}replaceFragment(t,e={}){const{fromNavigation:n=!1,fromPopstate:r=!1,preserveScroll:o=!1,url:s=null,trigger:i="unknown",viewTarget:a="main"}=e;return this.replaceFragments(t,{fromNavigation:n,fromPopstate:r,preserveScroll:o,url:s,trigger:i,viewTargets:[a]})}_updateDocumentHead(t){try{const e=new DOMParser,n=e.parseFromString(t,"text/html").querySelector("head");if(!n)return;const r=["title",'meta[name="description"]','meta[name="keywords"]','meta[name="robots"]','meta[name="author"]','meta[property^="og:"]','meta[name^="twitter:"]','meta[property^="article:"]','link[rel="canonical"]','link[rel="alternate"]','meta[name="theme-color"]'];let o=0;for(const t of r){const e=n.querySelectorAll(t);if(0!==e.length){if("title"===t){const t=e[0];t&&t.textContent.trim()&&(document.title=t.textContent.trim(),o++);continue}if('link[rel="canonical"]'===t){document.querySelectorAll('link[rel="canonical"]').forEach(t=>t.remove());const t=e[0];if(t&&t.href){const e=document.createElement("link");e.rel="canonical",e.href=t.href,document.head.appendChild(e),o++}continue}for(const t of e)"meta"===t.tagName.toLowerCase()?(this._updateMetaTag(t),o++):"link"===t.tagName.toLowerCase()&&(this._updateLinkTag(t),o++)}}this.eventBus.emit("page:head-updated",{updatedElements:o,newTitle:document.title})}catch(t){this.eventBus.emit("page:head-update-error",{error:t})}}_updateMetaTag(t){const e=t.getAttribute("name"),n=t.getAttribute("property"),r=t.getAttribute("content");if(!r)return;let o;if(e)o=`meta[name="${e}"]`;else{if(!n)return;o=`meta[property="${n}"]`}document.querySelectorAll(o).forEach(t=>t.remove());const s=document.createElement("meta");e&&s.setAttribute("name",e),n&&s.setAttribute("property",n),s.setAttribute("content",r),["charset","http-equiv","scheme"].forEach(e=>{t.hasAttribute(e)&&s.setAttribute(e,t.getAttribute(e))}),document.head.appendChild(s)}_updateLinkTag(t){const e=t.getAttribute("rel"),n=t.getAttribute("href");if(!e||!n)return;if(["stylesheet","icon","manifest","preload","prefetch"].includes(e))return;const r=`link[rel="${e}"]`,o=t.getAttribute("hreflang"),s=o?`link[rel="${e}"][hreflang="${o}"]`:r;document.querySelectorAll(s).forEach(t=>t.remove());const i=document.createElement("link");i.setAttribute("rel",e),i.setAttribute("href",n),["hreflang","type","media","sizes"].forEach(e=>{t.hasAttribute(e)&&i.setAttribute(e,t.getAttribute(e))}),document.head.appendChild(i)}_copyFragmentAttributes(t,e){if(["data-state","data-loading","data-error","data-version","aria-live","aria-label","aria-describedby"].forEach(n=>{t.hasAttribute(n)?e.setAttribute(n,t.getAttribute(n)):e.removeAttribute(n)}),t.className){const n=Array.from(e.classList).filter(t=>t.startsWith("component-")||t.startsWith("router-")||t.startsWith("page-"));e.className=t.className,n.forEach(t=>e.classList.add(t))}}_handleScrollRestoration(t,e){if(e.preserveScroll&&t)window.scrollTo({top:t.y,left:t.x,behavior:"instant"});else switch(this.options.scrollPosition){case"top":e.fromPopstate&&window.scrollTo({top:0,left:0,behavior:"instant"});break;case"element":if(this.options.scrollElement){const t=document.querySelector(this.options.scrollElement);t&&t.scrollIntoView({behavior:"smooth"})}}}_startObserver(t){"MutationObserver"in window&&(this.observer=new MutationObserver(t=>{this.options.batchUpdates?(this.pendingUpdates.push(...t),this.throttledUpdate()):this._processMutations(t)}),this.observer.observe(t,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["data-component","data-lazy-component"]}))}_processBatchedUpdates(){if(0===this.pendingUpdates.length)return;const t=[...this.pendingUpdates];this.pendingUpdates=[],this._processMutations(t)}_processMutations(t){const e=new Set,n=new Set;for(const r of t){if(r.addedNodes)for(const t of r.addedNodes)t.nodeType===Node.ELEMENT_NODE&&(e.add(t),t.querySelectorAll("[data-component], [data-lazy-component]").forEach(t=>e.add(t)));if(r.removedNodes)for(const t of r.removedNodes)t.nodeType===Node.ELEMENT_NODE&&n.add(t)}e.size>0&&this.mountAllWithin(this.container,{addedNodes:Array.from(e),trigger:"mutation"}),n.size>0&&this.unmountRemoved(Array.from(n))}mountAllWithin(t,e={}){const{addedNodes:n=null,priority:r="normal",trigger:o="initial",fragmentTarget:s=null}=e,i=this.options.trackPerformance?performance.now():0;try{const e=this.registry.filter(t=>"critical"===r?"critical"===t.priority||!0===t.critical:"normal"!==r||"critical"!==t.priority);for(const r of e)try{this._mountComponentConfig(r,t,n,s)}catch(t){this.eventBus.emit("page:component-mount-error",{componentName:r.name,error:t,config:r,fragmentTarget:s})}if(this.options.trackPerformance){const t=performance.now()-i;this.performanceMetrics.totalMountTime+=t,this.performanceMetrics.averageMountTime=this.performanceMetrics.totalMountTime/Math.max(1,this.performanceMetrics.fragmentReplacements)}}finally{}}_mountComponentConfig(t,e,n,r){const o=(n||[e]).flatMap(e=>{const n=[];return e.matches&&e.matches(t.selector)&&n.push(e),n.push(...e.querySelectorAll(t.selector)),n});if(0===o.length)return;const s=this._ensureInstance(t);let i=0;for(const e of o)try{if(e.hasAttribute("data-component-mounted"))continue;s.mount(e),e.setAttribute("data-component-mounted",t.name),r&&e.setAttribute("data-fragment-target",r),i++,this.eventBus.emit("page:component-mounted",{componentName:t.name,element:e,instance:s,fragmentTarget:r})}catch(t){}i>0&&(this.performanceMetrics.componentMounts+=i)}unmountAllWithin(t){try{let e=0;for(const[n,r]of this.instances)if(r._elementsKeys)for(const o of r._elementsKeys())if(t.contains(o))try{r.unmount(o),o.removeAttribute("data-component-mounted"),o.removeAttribute("data-fragment-target"),e++,this.eventBus.emit("page:component-unmounted",{componentName:n,element:o,instance:r})}catch(t){}this.performanceMetrics.componentUnmounts+=e}finally{}}unmountRemoved(t){for(const[t,e]of this.instances)if(e._elementsKeys)for(const n of e._elementsKeys())if(!document.documentElement.contains(n))try{e.unmount(n),this.eventBus.emit("page:component-unmounted",{componentName:t,element:n,instance:e,reason:"removed"})}catch(t){}}_ensureInstance(t){const e=this.instances.get(t.name);if(e)return e;if(t.dependsOn?.length)for(const e of t.dependsOn){const t=this.registry.find(t=>t.name===e);t&&this._ensureInstance(t)}const n=t.loader();if(!(n instanceof Promise)){const e=this._createInstance(n.default,t);return this.instances.set(t.name,e),this._trackComponentLoad(t.name),e}return this._handleAsyncLoading(t,n)}_handleAsyncLoading(t,e){const n=[],r=new QueuedComponentProxy(t=>n.push(["mount",t]),t=>n.push(["unmount",t]));return this.instances.set(t.name,r),this.loadingPromises.set(t.name,e),e.then(e=>{const r=this._createInstance(e.default,t);for(const[e,o]of n)try{r[e](o),"mount"===e&&(o.setAttribute("data-component-mounted",t.name),o.classList.remove("component-loading"),o.removeAttribute("data-component-state"))}catch(t){"mount"===e&&(o.classList.remove("component-loading"),o.classList.add("component-error"),o.setAttribute("data-component-state","error"))}this.instances.set(t.name,r),this._trackComponentLoad(t.name),this.loadingPromises.delete(t.name),this.retryCount.delete(t.name),this.eventBus.emit("page:component-loaded",{componentName:t.name,instance:r,queueSize:n.length})}).catch(e=>{for(const[t,e]of n)"mount"===t&&(e.classList.remove("component-loading"),e.classList.add("component-error"),e.setAttribute("data-component-state","error"));if(this.options.retryFailedLoads){const e=this.retryCount.get(t.name)||0;if(e<this.options.maxRetryAttempts)return this.retryCount.set(t.name,e+1),void setTimeout(()=>{this._handleAsyncLoading(t,t.loader())},1e3*Math.pow(2,e))}this.instances.delete(t.name),this.loadingPromises.delete(t.name),this.eventBus.emit("page:component-load-error",{componentName:t.name,error:e,retries:this.retryCount.get(t.name)||0})}),r}_createInstance(t,e){let n;if("function"==typeof t)n=t;else if(t&&"function"==typeof t.default)n=t.default;else if(t&&"function"==typeof t[e.name])n=t[e.name];else{if(n=Object.values(t||{}).find(t=>"function"==typeof t),!n)throw new Error(`No valid constructor found in module for component ${e.name}. Available exports: ${Object.keys(t||{}).join(", ")}`)}try{return new n({eventBus:this.eventBus,logger:this.logger,router:this.router,config:e})}catch(t){try{const t=new n;return"function"==typeof t.setEventBus&&t.setEventBus(this.eventBus),"function"==typeof t.setLogger&&t.setLogger(this.logger),"function"==typeof t.setRouter&&t.setRouter(this.router),t}catch(n){throw new Error(`Cannot instantiate component ${e.name}: ${t.message}`)}}}_handleLazyLoad(t,e){const n=this.registry.find(t=>t.name===e);if(!n)return;this._ensureInstance(n).mount(t)}_initialMount(){try{const t=this.container;this.mountAllWithin(t,{trigger:"initial"}),this._startObserver(t)}catch(t){}}_createThrottledFunction(t,e){let n=null,r=0;return function(...o){const s=Date.now();s-r>e?(t.apply(this,o),r=s):(clearTimeout(n),n=setTimeout(()=>{t.apply(this,o),r=Date.now()},e-(s-r)))}}getPerformanceMetrics(){return{...this.performanceMetrics}}getInstances(){return new Map(this.instances)}getLoadingStatus(){return{loading:Array.from(this.loadingPromises.keys()),retries:Object.fromEntries(this.retryCount)}}getComponentRegistry(){return this.registry||[]}getComponentStates(){const t={},e=this.getLoadingStatus();return this.registry.forEach(n=>{const r=this.instances.get(n.name),o=e.loading.includes(n.name);e.retries[n.name];const s=document.querySelectorAll(n.selector).length;let i="not-loaded";o?i="loading":r?i="loaded":s>0&&(i="available"),t[n.name]={status:i,hasInstance:!!r,instanceType:r?r.constructor.name:null,elementsFound:s,isLoading:o,retryCount:e.retries[n.name]||0,selector:n.selector}}),t}getMetrics(){return{componentMounts:this.performanceMetrics?.componentMounts||0,componentUnmounts:this.performanceMetrics?.componentUnmounts||0,averageMountTime:this.performanceMetrics?.averageMountTime||0,fragmentReplacements:this.performanceMetrics?.fragmentReplacements||0,totalMountTime:this.performanceMetrics?.totalMountTime||0}}_trackComponentLoad(t){const e=Date.now();this.sessionTracking.componentsLoaded.add(t),this.sessionTracking.loadHistory.push({component:t,timestamp:e,page:window.location.pathname});const n=this.sessionTracking.mountCount.get(t)||0;this.sessionTracking.mountCount.set(t,n+1),this.sessionTracking.lastMountTime.set(t,e),this.sessionTracking.loadHistory.length>100&&this.sessionTracking.loadHistory.shift()}getSessionTracking(){return{totalComponentsLoaded:this.sessionTracking.componentsLoaded.size,componentsLoadedThisSession:Array.from(this.sessionTracking.componentsLoaded),loadHistory:[...this.sessionTracking.loadHistory],mountCounts:Object.fromEntries(this.sessionTracking.mountCount),lastMountTimes:Object.fromEntries(this.sessionTracking.lastMountTime)}}destroy(){if(this.observer&&(this.observer.disconnect(),this.observer=null),this._lazyObserver&&(this._lazyObserver.disconnect(),this._lazyObserver=null),this._cleanupInterval&&(clearInterval(this._cleanupInterval),this._cleanupInterval=null),this.unmountAllWithin(this.container),this._componentPool){for(const[t,e]of this._componentPool)for(const t of e)if("function"==typeof t.destroy)try{t.destroy()}catch(t){}this._componentPool.clear()}this.instances.clear(),this.loadingPromises.clear(),this.retryCount.clear(),this._mountedElements&&this._mountedElements.clear(),this._errorCounts&&this._errorCounts.clear(),this._circuitBreakers&&this._circuitBreakers.clear(),this.eventBus.off("router:navigate-success"),this.eventBus.off("router:popstate"),this.eventBus.off("component:lazy-load"),this.eventBus.emit("page-manager:destroyed",{})}}class Parallelogram{static create(t={}){return new Parallelogram(t)}constructor(t={}){this.config={mode:t.mode||"production",debug:t.debug||!1,router:t.router||null,pageManager:t.pageManager||{}},this.logger=null,this.eventBus=null,this.router=null,this.pageManager=null,this.componentRegistry=null,this.webComponentLoader=null,this.components=new ComponentRegistrationHelper(this),this._initialized=!1}run(){return"complete"===document.readyState||"interactive"===document.readyState?(this.init(),Promise.resolve(this)):new Promise(t=>{document.addEventListener("DOMContentLoaded",()=>{this.init(),t(this)})})}init(){if(this._initialized)return console.warn("[Parallelogram] Already initialized"),this;this.logger=new DevLogger({},this.config.debug),this.eventBus=new EventManager;const t=ComponentRegistry.create(this.config.mode);this.components._configs.enhancementComponents.forEach(({name:e,selector:n,options:r})=>{t.component(e,n,r)}),this.componentRegistry=t.build(),this.config.router&&(this.router=new RouterManager({eventBus:this.eventBus,logger:this.logger,options:this.config.router}));const e={containerSelector:this.config.pageManager.containerSelector||"body",registry:this.componentRegistry,eventBus:this.eventBus,logger:this.logger,router:this.router,options:this.config.pageManager};this.pageManager=new PageManager(e);const n={};return this.components._configs.webComponents.forEach(({name:t,loader:e})=>{n[t]=e}),this.webComponentLoader=new WebComponentLoader(n,{observeDOM:!0,onLoad:t=>{},onError:(t,e)=>{}}),this.webComponentLoader.init(),this.pageManager.mountAllWithin(document.body,{trigger:"initial-global"}),this._initialized=!0,this}destroy(){this._initialized&&(this.webComponentLoader&&this.webComponentLoader.destroy(),this.pageManager&&this.pageManager.destroy?.(),this.router&&this.router.destroy?.(),this.eventBus&&this.eventBus.clear(),this._initialized=!1)}get isInitialized(){return this._initialized}}class ComponentRegistrationHelper{constructor(t){this.parallelogram=t,this._configs={webComponents:[],enhancementComponents:[]}}add(t,e,n={}){if(this._detectWebComponent(t))this._configs.webComponents.push({name:t,loader:e});else{const r="function"==typeof e?e:e.loader,o="function"==typeof e?n:{...e,...n};this._configs.enhancementComponents.push({name:this._generateComponentName(t),selector:t,options:{...o,loader:r}})}return this}_detectWebComponent(t){return!/[\[\.\#\:\s]/.test(t)}_generateComponentName(t){const e=t.match(/data-([a-z-]+)|[\.\#]([a-z-]+)/i);return e?e[1]||e[2]:t.replace(/[^a-z0-9-]/gi,"")}}export{Parallelogram,Parallelogram as default};

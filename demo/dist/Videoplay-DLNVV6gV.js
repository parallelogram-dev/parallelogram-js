import{B as e}from"./index.esm-DNh4gpcb.js";class t extends e{_getSelector(){return"data-videoplay"}static get defaults(){return{playThreshold:.3,pauseThreshold:.1,pauseOnExit:!0,muteWhenPlaying:null,restoreVolumeOnPause:!1,rootMargin:"0px",enableInBackground:!1,preloadOnMount:!0,requireUserInteraction:!1}}constructor(e={}){super(e),this._createObserver(),this._setupVisibilityHandling()}_createObserver(){const e={root:null,rootMargin:t.defaults.rootMargin,threshold:[0,.1,.3,.5,.7,1]};this.observer=new IntersectionObserver(this._handleIntersection.bind(this),e),this.logger?.info("Videoplay intersection observer created",e)}_setupVisibilityHandling(){this.isPageVisible=!document.hidden;const e=()=>{this.isPageVisible=!document.hidden,this.isPageVisible?this._resumeVisibleVideos():this._pauseAllBackgroundVideos()};document.addEventListener("visibilitychange",e),this.visibilityHandler=e}_init(e){const i=super._init(e),r=this.getAttr(e,"target"),s=r?document.querySelector(r):"VIDEO"===e.tagName?e:e.querySelector("video");if(!s)return this.logger?.warn("Videoplay: No video element found",{element:e,selector:r}),i;const a=this.getAttr(e,"threshold",t.defaults.playThreshold),o=this.getAttr(e,"pause-threshold",t.defaults.pauseThreshold),n=this.getAttr(e,"autopause",t.defaults.pauseOnExit),l=this.getAttr(e,"automute",t.defaults.muteWhenPlaying),d=this.getAttr(e,"restore-volume",t.defaults.restoreVolumeOnPause),u=this.getAttr(e,"background",t.defaults.enableInBackground),h=this.getAttr(e,"preload",t.defaults.preloadOnMount),c=this.getAttr(e,"require-interaction",t.defaults.requireUserInteraction),p=s.hasAttribute("autoplay");i.video=s,i.videoSelector=r,i.playThreshold=parseFloat(a),i.pauseThreshold=parseFloat(o),i.pauseOnExit=Boolean(n),i.muteWhenPlaying=null===l?null:Boolean(l),i.restoreVolumeOnPause=Boolean(d),i.enableInBackground=Boolean(u),i.preloadOnMount=Boolean(h),i.requireUserInteraction=Boolean(c),i.hasAutoplay=p,i.isPlaying=!1,i.isIntersecting=!1,i.intersectionRatio=0,i.originalMuted=s.muted,i.originalVolume=s.volume,i.hasUserInteracted=!1,this._setupVideo(s,i),e.setAttribute("data-videoplay-enhanced","true"),this.observer.observe(e);const g=i.cleanup;return i.cleanup=()=>{this.observer.unobserve(e),this._resetVideo(s,i),g()},this.eventBus?.emit("videoplay:mount",{element:e,video:s,hasAutoplay:i.hasAutoplay,playThreshold:i.playThreshold,timestamp:performance.now()}),this.logger?.info("Videoplay initialized",{element:e,video:r||"self",hasAutoplay:i.hasAutoplay,playThreshold:i.playThreshold,pauseOnExit:i.pauseOnExit}),i}_setupVideo(e,t){t.preloadOnMount&&!e.getAttribute("preload")&&(e.preload="metadata"),null===t.muteWhenPlaying&&t.hasAutoplay&&!e.hasAttribute("muted")&&(e.muted=!0,t.originalMuted=!1);const i=()=>{t.isPlaying=!0,this._emitVideoEvent(e,"play",{reason:"browser-play"})},r=()=>{t.isPlaying=!1,this._emitVideoEvent(e,"pause",{reason:"browser-pause"})},s=t=>{this.logger?.error("Video playback error",{video:e,error:t}),this._emitVideoEvent(e,"error",{error:t})},a=()=>{t.hasUserInteracted=!0,this.logger?.debug("User interacted with video",{video:e})};e.addEventListener("play",i),e.addEventListener("pause",r),e.addEventListener("error",s),e.addEventListener("click",a),e.addEventListener("play",a),t.playHandler=i,t.pauseHandler=r,t.errorHandler=s,t.userInteractionHandler=a}_handleIntersection(e){e.forEach(e=>{const t=e.target,i=this.getState(t);if(!i)return;i.isIntersecting=e.isIntersecting,i.intersectionRatio=e.intersectionRatio;const r=i.hasAutoplay&&(!i.requireUserInteraction||i.hasUserInteracted),s=e.isIntersecting&&e.intersectionRatio>=i.playThreshold&&(this.isPageVisible||i.enableInBackground)&&r,a=(!e.isIntersecting||e.intersectionRatio<i.pauseThreshold)&&i.pauseOnExit&&(!i.requireUserInteraction||i.hasUserInteracted);s&&!i.isPlaying?this._playVideo(t,i,"scroll-in"):a&&i.isPlaying&&this._pauseVideo(t,i,"scroll-out")})}async _playVideo(e,t,i="manual"){const{video:r}=t;try{!0===t.muteWhenPlaying?r.muted=!0:!1===t.muteWhenPlaying&&(r.muted=!1);const e=r.play();void 0!==e&&await e,t.isPlaying=!0,this._emitVideoEvent(r,"play",{reason:i,intersectionRatio:t.intersectionRatio,muted:r.muted}),this.logger?.debug("Video playing",{video:t.videoSelector||"self",reason:i,intersectionRatio:t.intersectionRatio})}catch(e){this.logger?.warn("Failed to play video",{video:t.videoSelector||"self",error:e.message,reason:i}),this._emitVideoEvent(r,"play-error",{reason:i,error:e.message})}}_pauseVideo(e,t,i="manual"){const{video:r}=t;try{r.pause(),t.isPlaying=!1,t.restoreVolumeOnPause&&!t.originalMuted&&(r.muted=!1,r.volume=t.originalVolume),this._emitVideoEvent(r,"pause",{reason:i,intersectionRatio:t.intersectionRatio}),this.logger?.debug("Video paused",{video:t.videoSelector||"self",reason:i,intersectionRatio:t.intersectionRatio})}catch(e){this.logger?.warn("Failed to pause video",{video:t.videoSelector||"self",error:e.message})}}_emitVideoEvent(e,t,i){e.dispatchEvent(new CustomEvent(`videoplay:${t}`,{detail:i,bubbles:!0})),this.eventBus?.emit(`videoplay:${t}`,{video:e,timestamp:performance.now(),...i})}_pauseAllBackgroundVideos(){document.querySelectorAll('[data-videoplay-enhanced="true"]').forEach(e=>{const t=this.getState(e);t&&t.isPlaying&&!t.enableInBackground&&this._pauseVideo(e,t,"page-hidden")})}_resumeVisibleVideos(){document.querySelectorAll('[data-videoplay-enhanced="true"]').forEach(e=>{const t=this.getState(e);t&&!t.isPlaying&&t.isIntersecting&&t.intersectionRatio>=t.playThreshold&&t.hasAutoplay&&this._playVideo(e,t,"page-visible")})}async play(e){const t=this.getState(e);t&&await this._playVideo(e,t,"manual")}pause(e){const t=this.getState(e);t&&this._pauseVideo(e,t,"manual")}isPlaying(e){const t=this.getState(e);return!!t&&t.isPlaying}getIntersectionRatio(e){const t=this.getState(e);return t?t.intersectionRatio:0}updatePlayThreshold(e,t){const i=this.getState(e);i&&(i.playThreshold=Math.max(0,Math.min(1,t)),this.logger?.info("Videoplay threshold updated",{element:e,newThreshold:i.playThreshold}))}_resetVideo(e,t){try{t.playHandler&&e.removeEventListener("play",t.playHandler),t.pauseHandler&&e.removeEventListener("pause",t.pauseHandler),t.errorHandler&&e.removeEventListener("error",t.errorHandler),t.userInteractionHandler&&(e.removeEventListener("click",t.userInteractionHandler),e.removeEventListener("play",t.userInteractionHandler)),e.muted=t.originalMuted,e.volume=t.originalVolume}catch(t){this.logger?.warn("Error resetting video",{video:e,error:t})}}getStatus(){const e=document.querySelectorAll('[data-videoplay-enhanced="true"]');let i=0,r=0,s=0,a=0;return e.forEach(e=>{const t=this.getState(e);t&&(a++,t.isPlaying&&i++,t.isIntersecting&&r++,t.hasAutoplay&&s++)}),{totalVideos:a,playingCount:i,intersectingCount:r,autoplayCount:s,pageVisible:this.isPageVisible,observerActive:!!this.observer,defaults:t.defaults}}destroy(){this.observer&&(this.observer.disconnect(),this.observer=null),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),super.destroy(),this.logger?.info("Videoplay destroyed")}static enhanceAll(e="[data-videoplay]",i){const r=new t(i);return document.querySelectorAll(e).forEach(e=>{r.mount(e)}),r}}export{t as default};

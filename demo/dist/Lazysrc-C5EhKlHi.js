import{B as e}from"./index.esm-DNh4gpcb.js";class t extends e{_getSelector(){return"data-lazysrc"}static get defaults(){return{threshold:.1,rootMargin:"50px",loadingClass:"loading",loadedClass:"loaded",errorClass:"error",fadeInDuration:300,retryAttempts:3,retryDelay:1e3,useNativeLoading:!1}}constructor(e={}){super(e),this._createObserver(),this.loadingAttempts=new Map}_createObserver(){const e={root:null,rootMargin:t.defaults.rootMargin,threshold:t.defaults.threshold};this.observer=new IntersectionObserver(this._handleIntersection.bind(this),e),this.logger?.info("Lazysrc intersection observer created",e)}async _init(e){const t=super._init(e),s=this._getConfiguration(e);t.config=s,t.isLoaded=!1,t.isLoading=!1,t.hasError=!1,this._isImage(e)&&"PICTURE"===e.parentElement?.tagName&&(t.pictureParent=e.parentElement),(s.useNativeLoading||e.hasAttribute("loading"))&&this._supportsNativeLoading()&&this._isImage(e)?this._setupNativeLoading(e,t):this._setupIntersectionLoading(e,t);const r=async t=>{const s=this.getState(e),r=s instanceof Promise?await s:s;!r||r.isLoaded||r.isLoading||await this._loadElement(e,r)};e.addEventListener("lazysrc:forceLoad",r);const o=t.cleanup;return t.cleanup=()=>{this.observer.unobserve(e),this.loadingAttempts.delete(e),e.removeEventListener("lazysrc:forceLoad",r),o()},this._dispatch(e,"lazysrc:mounted",{element:e,config:s,timestamp:performance.now()}),this.logger?.info("Lazysrc initialized",{element:e,threshold:s.threshold,useNative:s.useNativeLoading}),t}_getConfiguration(e){const s={...t.defaults},r=this.getAttr(e,"threshold");r&&(s.threshold=parseFloat(r));const o=this.getAttr(e,"root-margin");o&&(s.rootMargin=o);const i=this.getAttr(e,"loading-class");i&&(s.loadingClass=i);const a=this.getAttr(e,"loaded-class");a&&(s.loadedClass=a);const n=this.getAttr(e,"error-class");n&&(s.errorClass=n);const l=this.getAttr(e,"fade-duration");l&&(s.fadeInDuration=parseInt(l,10));const c=this.getAttr(e,"retry-attempts");c&&(s.retryAttempts=parseInt(c,10));const d=this.getAttr(e,"retry-delay");return d&&(s.retryDelay=parseInt(d,10)),this.hasAttr(e,"use-native")&&(s.useNativeLoading="false"!==this.getAttr(e,"use-native")),s}_supportsNativeLoading(){return"loading"in HTMLImageElement.prototype}_isImage(e){return"IMG"===e.tagName}_setupNativeLoading(e,t){this._isImage(e)&&(e.hasAttribute("loading")||(e.loading="lazy"),this._applySources(e,t),e.addEventListener("load",()=>{this._onElementLoaded(e,t)}),e.addEventListener("error",()=>{this._onElementError(e,t)}))}_setupIntersectionLoading(e,s){this.logger?.info("Setting up intersection loading for element",{element:e,state:s}),this._storeAndClearSources(e,s),s.config.threshold!==t.defaults.threshold||s.config.rootMargin!==t.defaults.rootMargin?(this.logger?.info("Creating custom observer for element",{threshold:s.config.threshold,rootMargin:s.config.rootMargin}),s.customObserver=new IntersectionObserver(this._handleIntersection.bind(this),{root:null,rootMargin:s.config.rootMargin,threshold:s.config.threshold}),s.customObserver.observe(e),this.logger?.info("Element added to custom observer",{element:e})):(this.logger?.info("Adding element to default observer",{element:e}),this.observer.observe(e),this.logger?.info("Element added to default observer",{element:e}))}_storeAndClearSources(e,t){if("IMG"===e.tagName){const s=t.pictureParent;if(s){const e=s.querySelectorAll("source");t.originalSources=[],e.forEach((e,s)=>{e.srcset&&!e.dataset.lazysrcSrcset&&(t.originalSources[s]={srcset:e.srcset,sizes:e.sizes||null},e.removeAttribute("srcset"))})}e.src&&!this.hasAttr(e,"src")&&(t.originalSrc=e.src,e.removeAttribute("src")),e.srcset&&!this.hasAttr(e,"srcset")&&(t.originalSrcset=e.srcset,e.removeAttribute("srcset")),e.sizes&&!this.hasAttr(e,"sizes")&&(t.originalSizes=e.sizes)}else if("PICTURE"===e.tagName){const s=e.querySelectorAll("source");t.originalSources=[],s.forEach((e,s)=>{e.srcset&&!e.dataset.lazysrcSrcset&&(t.originalSources[s]={srcset:e.srcset,sizes:e.sizes||null},e.removeAttribute("srcset"))});const r=e.querySelector("img");r&&(r.src&&!r.dataset.lazysrcSrc&&(t.originalSrc=r.src,r.removeAttribute("src")),r.srcset&&!r.dataset.lazysrcSrcset&&(t.originalSrcset=r.srcset,r.removeAttribute("srcset")))}}async _handleIntersection(e){this.logger?.info("Intersection handler called",{entriesCount:e.length});for(const t of e)if(this.logger?.info("Processing intersection entry",{isIntersecting:t.isIntersecting,element:t.target,intersectionRatio:t.intersectionRatio}),t.isIntersecting){const e=t.target,s=this.getState(e),r=s instanceof Promise?await s:s;this.logger?.debug("State structure debug:",{wasPromise:s instanceof Promise,hasState:!!r,stateKeys:r?Object.keys(r):null,hasConfig:!!r?.config,fullState:r}),this.logger?.info("Resolved state for intersecting element",{hasState:!!r,isLoaded:r?.isLoaded,isLoading:r?.isLoading}),!r||r.isLoaded||r.isLoading||(this.logger?.info("Calling _loadElement for element",{element:e}),await this._loadElement(e,r))}}async _loadElement(e,t){if(this.logger?.debug("_loadElement called with:",{element:e,componentState:t,componentStateKeys:t?Object.keys(t):null,hasConfig:!(!t||!t.config),configKeys:t?.config?Object.keys(t.config):null}),t)if(t.config){if(!t.isLoading&&!t.isLoaded){t.isLoading=!0,t.loadStartTime=performance.now(),e.classList.add(t.config.loadingClass),this._dispatch(e,"lazysrc:loading-start",{element:e,timestamp:performance.now()});try{this.hasAttr(e,"bg")?await this._loadBackgroundImage(e,t):"PICTURE"===e.tagName?await this._loadPictureElement(e,t):this._isImage(e)?await this._loadImageElement(e,t):await this._loadBackgroundImage(e,t),this._onElementLoaded(e,t)}catch(s){this._onElementError(e,t,s)}}}else this.logger?.error("Missing config for element",{element:e,componentState:t,componentStateKeys:Object.keys(t)});else this.logger?.error("Invalid state for element",{element:e,componentState:t})}_loadImageElement(e,t){return new Promise((s,r)=>{if(t.pictureParent)this._applyPictureSources(t.pictureParent,t),e.onload=()=>{s()},e.onerror=()=>{r(new Error("Picture image failed to load"))};else{const o=new Image;o.onload=()=>{this._applySources(e,t),s()},o.onerror=()=>{r(new Error("Image failed to load"))};const i=this.getAttr(e,"src")||t.originalSrc,a=this.getAttr(e,"srcset")||t.originalSrcset,n=this.getAttr(e,"sizes")||t.originalSizes;if(a&&(o.srcset=a,n&&(o.sizes=n)),i)o.src=i;else if(!a)return void r(new Error("No src or srcset specified"))}})}_loadPictureElement(e,t){return new Promise((s,r)=>{const o=e.querySelector("img");o?(this._applyPictureSources(e,t),o.onload=()=>{s()},o.onerror=()=>{r(new Error("Picture failed to load"))}):r(new Error("No img element found in picture"))})}_loadBackgroundImage(e,t){return new Promise((t,s)=>{const r=this.getAttr(e,"bg");if(!r)return void s(new Error("No background image URL specified"));const o=new Image;o.onload=()=>{e.style.backgroundImage=`url("${r}")`,t()},o.onerror=()=>{s(new Error("Background image failed to load"))},o.src=r})}_applySources(e,t){const s=this.getAttr(e,"srcset");s?e.srcset=s:t.originalSrcset&&(e.srcset=t.originalSrcset);const r=this.getAttr(e,"sizes");r?e.sizes=r:t.originalSizes&&(e.sizes=t.originalSizes);const o=this.getAttr(e,"src");o?e.src=o:t.originalSrc&&(e.src=t.originalSrc)}_applyPictureSources(e,t){e.querySelectorAll("source").forEach((e,s)=>{e.dataset.lazysrcSrcset?(e.srcset=e.dataset.lazysrcSrcset,e.dataset.lazysrcSizes&&(e.sizes=e.dataset.lazysrcSizes)):t.originalSources&&t.originalSources[s]&&(e.srcset=t.originalSources[s].srcset,t.originalSources[s].sizes&&(e.sizes=t.originalSources[s].sizes))});const s=e.querySelector("img");s&&this._applySources(s,t)}_onElementLoaded(e,t){t.isLoading=!1,t.isLoaded=!0,t.hasError=!1;const s=t.loadStartTime?performance.now()-t.loadStartTime:0;e.classList.remove(t.config.loadingClass),e.classList.add(t.config.loadedClass),t.config.fadeInDuration>0&&this._applyFadeInEffect(e,t.config.fadeInDuration),this.observer.unobserve(e),t.customObserver&&t.customObserver.unobserve(e),this.loadingAttempts.delete(e),this._dispatch(e,"lazysrc:loaded",{element:e,timestamp:performance.now(),loadTime:Math.round(s)}),this.logger?.debug("Element loaded successfully",{element:e,loadTime:s}),!1!==t.config.autoDetach&&setTimeout(()=>{this._detachElement(e,t)},100)}_onElementError(e,t,s){t.isLoading=!1,t.hasError=!0,e.classList.remove(t.config.loadingClass),e.classList.add(t.config.errorClass);const r=this.loadingAttempts.get(e)||0;if(r<t.config.retryAttempts)return this.loadingAttempts.set(e,r+1),setTimeout(()=>{t.isLoading=!1,t.hasError=!1,e.classList.remove(t.config.errorClass),this._loadElement(e,t)},t.config.retryDelay*(r+1)),void this.logger?.info(`Retrying load for element (attempt ${r+1}/${t.config.retryAttempts})`,{element:e});this._dispatch(e,"lazysrc:error",{element:e,error:s?.message||"Load failed",timestamp:performance.now()}),this.logger?.warn("Element failed to load after retries",{element:e,error:s})}_applyFadeInEffect(e,t){e.style.opacity="0",e.style.transition=`opacity ${t}ms ease-in-out`,e.offsetHeight,e.style.opacity="1",setTimeout(()=>{e.style.transition=""},t)}async loadElement(e){const t=this.getState(e),s=t instanceof Promise?await t:t;!s||s.isLoaded||s.isLoading||await this._loadElement(e,s)}async loadAll(e=document){const t=e.querySelectorAll('[data-lazysrc-enhanced="true"]');for(const e of t){const t=this.getState(e),s=t instanceof Promise?await t:t;!s||s.isLoaded||s.isLoading||await this._loadElement(e,s)}}update(e=document){e.querySelectorAll('[data-lazysrc]:not([data-lazysrc-enhanced="true"])').forEach(e=>{this.mount(e)})}async isLoaded(e){const t=this.getState(e),s=t instanceof Promise?await t:t;return!!s&&s.isLoaded}async isLoading(e){const t=this.getState(e),s=t instanceof Promise?await t:t;return!!s&&s.isLoading}async hasError(e){const t=this.getState(e),s=t instanceof Promise?await t:t;return!!s&&s.hasError}getStatus(){const e=document.querySelectorAll('[data-lazysrc-enhanced="true"]');let s=0,r=0,o=0;return e.forEach(e=>{this.isLoaded(e)&&s++,this.isLoading(e)&&r++,this.hasError(e)&&o++}),{totalElements:e.length,loadedCount:s,loadingCount:r,errorCount:o,observerActive:!!this.observer,supportsNative:this._supportsNativeLoading(),defaults:t.defaults}}_detachElement(e,t){t.isLoaded&&(t.customObserver&&(t.customObserver.disconnect(),t.customObserver=null),this._dispatch(e,"lazysrc:detached",{element:e,timestamp:performance.now()}),this.logger?.debug("Element detached after loading",{element:e}))}destroy(){this.observer&&(this.observer.disconnect(),this.observer=null),this.loadingAttempts.clear(),super.destroy(),this.logger?.info("Lazysrc destroyed")}static enhanceAll(e="[data-lazysrc]",s){const r=new t(s);return document.querySelectorAll(e).forEach(e=>{r.mount(e)}),r}}export{t as default};

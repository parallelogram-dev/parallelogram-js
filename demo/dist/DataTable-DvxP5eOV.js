import{B as e}from"./index.esm-DtjwdHIr.js";import{C as t,E as r}from"./ComponentStates-CcJglg_C.js";import{c as a,a as s,d as n}from"./parallelogram-demo.min.js";class o extends e{_getSelector(){return"data-datatable"}static get defaults(){return{sortable:!0,filterable:!1,paginate:!1,pageSize:10,searchDelay:300,sortIcons:{unsorted:"↕",asc:"↑",desc:"↓"}}}constructor(e={}){super(e),this.searchTimeout=null}_init(e){const r=super._init(e);this.setState(e,t.MOUNTED);const a=this._getConfiguration(e),s=Array.from(e.querySelectorAll("tbody tr"));return r.config=a,r.originalRows=s,r.filteredRows=[...s],r.currentSort={column:null,direction:null},r.currentPage=1,r.searchTerm="",r.errorMessage=null,a.sortable&&this._setupSorting(e,r),a.filterable&&this._setupFiltering(e,r),a.paginate&&this._setupPagination(e,r),this._render(e,r),this.eventBus?.emit("datatable:mounted",{element:e,config:a}),r}_getConfiguration(e){return{sortable:this.getAttr(e,"sortable",o.defaults.sortable),filterable:this.getAttr(e,"filterable",o.defaults.filterable),paginate:parseInt(this.getAttr(e,"paginate",o.defaults.paginate))||!1,pageSize:parseInt(this.getAttr(e,"page-size",o.defaults.pageSize)),searchDelay:parseInt(this.getAttr(e,"search-delay",o.defaults.searchDelay))}}_setupSorting(e,t){e.querySelectorAll("th[data-sort]").forEach(r=>{r.style.cursor="pointer",r.classList.add("sortable");const s=a("span",{className:"sort-icon"},o.defaults.sortIcons.unsorted);r.appendChild(s),r.addEventListener("click",()=>{this._handleSort(e,t,r)})})}_setupFiltering(e,t){const r=s("datatable-search"),o=a("label",{className:"form__label",htmlFor:r},"Search:"),i=a("input",{type:"text",id:r,placeholder:"Search table...",className:"form__control datatable-search"}),l=n(r=>{this._handleFilter(e,t,r)},t.config.searchDelay);i.addEventListener("input",e=>l(e.target.value));const c=a("div",{className:"form__field"});c.appendChild(i);const d=a("div",{className:"form__element form__element--sm datatable-filter"});d.appendChild(o),d.appendChild(c),e.parentNode.insertBefore(d,e)}_setupPagination(e,t){const r=document.createElement("div");r.className="datatable__pagination",e.parentNode.appendChild(r),t.paginationContainer=r}_handleSort(e,t,r){const a=r.dataset.sort,s=r.dataset.sortType||"string";let n="asc";t.currentSort.column===a&&"asc"===t.currentSort.direction&&(n="desc"),t.currentSort={column:a,direction:n},e.querySelectorAll(".sort-icon").forEach(e=>{e.textContent=o.defaults.sortIcons.unsorted});r.querySelector(".sort-icon").textContent=o.defaults.sortIcons[n];const i=Array.from(e.querySelectorAll("th"));t.filteredRows.sort((e,t)=>{const r=this._getCellValue(e,a,s,i),o=this._getCellValue(t,a,s,i);let l=0;return l="number"===s?parseFloat(r)-parseFloat(o):"date"===s?new Date(r)-new Date(o):r.localeCompare(o),"desc"===n?-l:l}),t.currentPage=1,this._render(e,t)}_handleFilter(e,t,r){t.searchTerm=r.toLowerCase(),t.filteredRows=r?t.originalRows.filter(e=>Array.from(e.cells).some(e=>e.textContent.toLowerCase().includes(t.searchTerm))):[...t.originalRows],t.currentPage=1,this._render(e,t)}_getCellValue(e,t,r,a=null){if(!e||!e.cells)return"";if(!a){const t=e.closest("table");if(!t)return"";a=Array.from(t.querySelectorAll("th"))}const s=a.findIndex(e=>e&&e.dataset&&e.dataset.sort===t);if(-1===s||!e.cells[s])return"";const n=e.cells[s];return n&&n.textContent?n.textContent.trim():""}_render(e,t){const r=e.querySelector("tbody");r.innerHTML="";let a=t.filteredRows;if(t.config.paginate){const e=(t.currentPage-1)*t.config.pageSize,r=e+t.config.pageSize;a=t.filteredRows.slice(e,r)}a.forEach(e=>r.appendChild(e.cloneNode(!0))),t.config.paginate&&this._renderPagination(e,t),this.eventBus?.emit("datatable:rendered",{element:e,totalRows:t.originalRows.length,filteredRows:t.filteredRows.length,displayedRows:a.length})}_renderPagination(e,t){const r=t.paginationContainer,a=Math.ceil(t.filteredRows.length/t.config.pageSize);if(r.innerHTML="",a<=1)return;const s=document.createElement("button");s.textContent="Previous",s.disabled=1===t.currentPage,s.addEventListener("click",()=>{t.currentPage>1&&(t.currentPage--,this._render(e,t))}),r.appendChild(s);for(let s=1;s<=a;s++){const a=document.createElement("button");a.textContent=s,a.classList.toggle("active",s===t.currentPage),a.addEventListener("click",()=>{t.currentPage=s,this._render(e,t)}),r.appendChild(a)}const n=document.createElement("button");n.textContent="Next",n.disabled=t.currentPage===a,n.addEventListener("click",()=>{t.currentPage<a&&(t.currentPage++,this._render(e,t))}),r.appendChild(n)}async loadData(e,a,s){const n=this.getState(e);if(n)try{this.setState(e,r.LOADING),n.errorMessage=null;const t=await fetch(a);if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const o=await t.json();if(!Array.isArray(o))throw new Error("Response data must be an array");if(0===o.length)return this.setState(e,"empty"),n.originalRows=[],n.filteredRows=[],this._render(e,n),void this._dispatch(e,"datatable:empty",{url:a});e.querySelector("tbody").innerHTML="";const i=o.map(e=>s(e));n.originalRows=i,n.filteredRows=[...i],n.currentPage=1,this.setState(e,r.LOADED),this._render(e,n),this._dispatch(e,"datatable:loaded",{url:a,rowCount:o.length}),this.eventBus?.emit("datatable:loaded",{element:e,url:a,rowCount:o.length})}catch(r){this.setState(e,t.ERROR),this.setAttr(e,"error-message",r.message),n.errorMessage=r.message,this._dispatch(e,"datatable:error",{error:r,url:a,message:r.message}),this.eventBus?.emit("datatable:error",{element:e,error:r,url:a,message:r.message}),this.logger?.error("DataTable: Failed to load data",{error:r,url:a})}}clearError(e){const r=this.getState(e);r&&(r.errorMessage=null,this.removeAttr(e,"error-message"),this.setState(e,t.MOUNTED))}sort(e,t,r="asc"){const a=this.getState(e);if(!a)return;const s=e.querySelector(`th[data-sort="${t}"]`);s&&(a.currentSort={column:t,direction:r},this._handleSort(e,a,s))}filter(e,t){const r=this.getState(e);r&&this._handleFilter(e,r,t)}goToPage(e,t){const r=this.getState(e);if(!r||!r.config.paginate)return;const a=Math.ceil(r.filteredRows.length/r.config.pageSize);t>=1&&t<=a&&(r.currentPage=t,this._render(e,r))}static enhanceAll(e="[data-datatable]",t){const r=new o(t);return document.querySelectorAll(e).forEach(e=>r.mount(e)),r}}export{o as DataTable,o as default};

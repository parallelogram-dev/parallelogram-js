import{B as e}from"./index.esm-BW_QP_AR.js";class t extends e{static get defaults(){return{playThreshold:.3,pauseThreshold:.1,pauseOnExit:!0,muteWhenPlaying:null,restoreVolumeOnPause:!1,rootMargin:"0px",enableInBackground:!1,preloadOnMount:!0,requireUserInteraction:!1}}constructor(e={}){super(e),this._createObserver(),this._setupVisibilityHandling()}_createObserver(){const e={root:null,rootMargin:t.defaults.rootMargin,threshold:[0,.1,.3,.5,.7,1]};this.observer=new IntersectionObserver(this._handleIntersection.bind(this),e),this.logger?.info("Videoplay intersection observer created",e)}_setupVisibilityHandling(){this.isPageVisible=!document.hidden;const e=()=>{this.isPageVisible=!document.hidden,this.isPageVisible?this._resumeVisibleVideos():this._pauseAllBackgroundVideos()};document.addEventListener("visibilitychange",e),this.visibilityHandler=e}_init(e){const i=super._init(e),a=this._getDataAttr(e,"video-target"),r=a?document.querySelector(a):"VIDEO"===e.tagName?e:e.querySelector("video");if(!r)return this.logger?.warn("Videoplay: No video element found",{element:e,selector:a}),i;const s=this._getDataAttr(e,"videoplay-threshold",t.defaults.playThreshold),o=this._getDataAttr(e,"videoplay-pause-threshold",t.defaults.pauseThreshold),n=this._getDataAttr(e,"videoplay-autopause",t.defaults.pauseOnExit),l=this._getDataAttr(e,"videoplay-automute",t.defaults.muteWhenPlaying),d=this._getDataAttr(e,"videoplay-restore-volume",t.defaults.restoreVolumeOnPause),u=this._getDataAttr(e,"videoplay-background",t.defaults.enableInBackground),h=this._getDataAttr(e,"videoplay-preload",t.defaults.preloadOnMount),c=this._getDataAttr(e,"videoplay-require-interaction",t.defaults.requireUserInteraction),p=r.hasAttribute("autoplay");i.video=r,i.videoSelector=a,i.playThreshold=parseFloat(s),i.pauseThreshold=parseFloat(o),i.pauseOnExit=Boolean(n),i.muteWhenPlaying=null===l?null:Boolean(l),i.restoreVolumeOnPause=Boolean(d),i.enableInBackground=Boolean(u),i.preloadOnMount=Boolean(h),i.requireUserInteraction=Boolean(c),i.hasAutoplay=p,i.isPlaying=!1,i.isIntersecting=!1,i.intersectionRatio=0,i.originalMuted=r.muted,i.originalVolume=r.volume,i.hasUserInteracted=!1,this._setupVideo(r,i),e.setAttribute("data-videoplay-enhanced","true"),this.observer.observe(e);const g=i.cleanup;return i.cleanup=()=>{this.observer.unobserve(e),this._resetVideo(r,i),g()},this.eventBus?.emit("videoplay:mount",{element:e,video:r,hasAutoplay:i.hasAutoplay,playThreshold:i.playThreshold,timestamp:performance.now()}),this.logger?.info("Videoplay initialized",{element:e,video:a||"self",hasAutoplay:i.hasAutoplay,playThreshold:i.playThreshold,pauseOnExit:i.pauseOnExit}),i}_setupVideo(e,t){t.preloadOnMount&&!e.getAttribute("preload")&&(e.preload="metadata"),null===t.muteWhenPlaying&&t.hasAutoplay&&!e.hasAttribute("muted")&&(e.muted=!0,t.originalMuted=!1);const i=()=>{t.isPlaying=!0,this._emitVideoEvent(e,"play",{reason:"browser-play"})},a=()=>{t.isPlaying=!1,this._emitVideoEvent(e,"pause",{reason:"browser-pause"})},r=t=>{this.logger?.error("Video playback error",{video:e,error:t}),this._emitVideoEvent(e,"error",{error:t})},s=()=>{t.hasUserInteracted=!0,this.logger?.debug("User interacted with video",{video:e})};e.addEventListener("play",i),e.addEventListener("pause",a),e.addEventListener("error",r),e.addEventListener("click",s),e.addEventListener("play",s),t.playHandler=i,t.pauseHandler=a,t.errorHandler=r,t.userInteractionHandler=s}_handleIntersection(e){e.forEach(e=>{const t=e.target,i=this.getState(t);if(!i)return;i.isIntersecting=e.isIntersecting,i.intersectionRatio=e.intersectionRatio;const a=i.hasAutoplay&&(!i.requireUserInteraction||i.hasUserInteracted),r=e.isIntersecting&&e.intersectionRatio>=i.playThreshold&&(this.isPageVisible||i.enableInBackground)&&a,s=(!e.isIntersecting||e.intersectionRatio<i.pauseThreshold)&&i.pauseOnExit&&(!i.requireUserInteraction||i.hasUserInteracted);r&&!i.isPlaying?this._playVideo(t,i,"scroll-in"):s&&i.isPlaying&&this._pauseVideo(t,i,"scroll-out")})}async _playVideo(e,t,i="manual"){const{video:a}=t;try{!0===t.muteWhenPlaying?a.muted=!0:!1===t.muteWhenPlaying&&(a.muted=!1);const e=a.play();void 0!==e&&await e,t.isPlaying=!0,this._emitVideoEvent(a,"play",{reason:i,intersectionRatio:t.intersectionRatio,muted:a.muted}),this.logger?.debug("Video playing",{video:t.videoSelector||"self",reason:i,intersectionRatio:t.intersectionRatio})}catch(e){this.logger?.warn("Failed to play video",{video:t.videoSelector||"self",error:e.message,reason:i}),this._emitVideoEvent(a,"play-error",{reason:i,error:e.message})}}_pauseVideo(e,t,i="manual"){const{video:a}=t;try{a.pause(),t.isPlaying=!1,t.restoreVolumeOnPause&&!t.originalMuted&&(a.muted=!1,a.volume=t.originalVolume),this._emitVideoEvent(a,"pause",{reason:i,intersectionRatio:t.intersectionRatio}),this.logger?.debug("Video paused",{video:t.videoSelector||"self",reason:i,intersectionRatio:t.intersectionRatio})}catch(e){this.logger?.warn("Failed to pause video",{video:t.videoSelector||"self",error:e.message})}}_emitVideoEvent(e,t,i){e.dispatchEvent(new CustomEvent(`videoplay:${t}`,{detail:i,bubbles:!0})),this.eventBus?.emit(`videoplay:${t}`,{video:e,timestamp:performance.now(),...i})}_pauseAllBackgroundVideos(){document.querySelectorAll('[data-videoplay-enhanced="true"]').forEach(e=>{const t=this.getState(e);t&&t.isPlaying&&!t.enableInBackground&&this._pauseVideo(e,t,"page-hidden")})}_resumeVisibleVideos(){document.querySelectorAll('[data-videoplay-enhanced="true"]').forEach(e=>{const t=this.getState(e);t&&!t.isPlaying&&t.isIntersecting&&t.intersectionRatio>=t.playThreshold&&t.hasAutoplay&&this._playVideo(e,t,"page-visible")})}async play(e){const t=this.getState(e);t&&await this._playVideo(e,t,"manual")}pause(e){const t=this.getState(e);t&&this._pauseVideo(e,t,"manual")}isPlaying(e){const t=this.getState(e);return!!t&&t.isPlaying}getIntersectionRatio(e){const t=this.getState(e);return t?t.intersectionRatio:0}updatePlayThreshold(e,t){const i=this.getState(e);i&&(i.playThreshold=Math.max(0,Math.min(1,t)),this.logger?.info("Videoplay threshold updated",{element:e,newThreshold:i.playThreshold}))}_resetVideo(e,t){try{t.playHandler&&e.removeEventListener("play",t.playHandler),t.pauseHandler&&e.removeEventListener("pause",t.pauseHandler),t.errorHandler&&e.removeEventListener("error",t.errorHandler),t.userInteractionHandler&&(e.removeEventListener("click",t.userInteractionHandler),e.removeEventListener("play",t.userInteractionHandler)),e.muted=t.originalMuted,e.volume=t.originalVolume}catch(t){this.logger?.warn("Error resetting video",{video:e,error:t})}}getStatus(){const e=document.querySelectorAll('[data-videoplay-enhanced="true"]');let i=0,a=0,r=0,s=0;return e.forEach(e=>{const t=this.getState(e);t&&(s++,t.isPlaying&&i++,t.isIntersecting&&a++,t.hasAutoplay&&r++)}),{totalVideos:s,playingCount:i,intersectingCount:a,autoplayCount:r,pageVisible:this.isPageVisible,observerActive:!!this.observer,defaults:t.defaults}}destroy(){this.observer&&(this.observer.disconnect(),this.observer=null),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),super.destroy(),this.logger?.info("Videoplay destroyed")}static enhanceAll(e="[data-videoplay]",i){const a=new t(i);return document.querySelectorAll(e).forEach(e=>{a.mount(e)}),a}}export{t as default};

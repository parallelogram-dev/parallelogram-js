<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Uploader (New Field System) - Enhancement Framework</title>
    <link rel="stylesheet" href="dist/parallelogram-demo.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  </head>
  <body>
    <nav data-view="navbar">
      <div class="nav__container">
        <h1>Enhancement Framework</h1>
        <ul class="nav__list">
          <li><a href="/" class="nav__link">Home</a></li>
          <li><a href="/uploader" class="nav__link">Uploader (Old)</a></li>
          <li><a href="/uploader-new" class="nav__link" aria-current="page">Uploader (New)</a></li>
        </ul>
      </div>
    </nav>

    <main data-view="main" data-demo="uploader" class="page__content">
      <header class="page__header">
        <h1>Uploader Component - Field-Based System</h1>
        <p>
          New implementation with configurable fields defined at the parent level.
          Each field gets its own inline edit button.
        </p>
      </header>

      <section class="demo__section" data-demo-section>
        <h2>File Uploader with Custom Fields</h2>
        <p>Define fields once, use them across all files with individual edit buttons:</p>

        <div class="demo__container">
          <p-uploader
            max-files="3"
            upload-url="/mock/upload"
            update-url="/mock/update"
            delete-url="/mock/delete"
            sequence-url="/mock/sequence"
            accept-types="image/*"
            max-file-size="5242880"
            allow-edit="true"
            allow-sort="true"
            input-name="images">

            <!-- Field definitions for ALL files -->
            <p-uploader-fields slot="field-definitions">
              <p-uploader-field key="title" label="Title" type="text" required maxlength="100"></p-uploader-field>
              <p-uploader-field key="caption" label="Caption" type="textarea" maxlength="500"></p-uploader-field>
              <p-uploader-field key="link" label="Link" type="url"></p-uploader-field>
            </p-uploader-fields>

            <!-- Individual files with their data -->
            <p-uploader-file
              file-id="demo1"
              filename="sample1.jpg"
              preview="https://picsum.photos/200/200?random=1"
              state="uploaded">
              <p-uploader-data key="title">Beautiful Landscape</p-uploader-data>
              <p-uploader-data key="caption">A stunning view captured at sunset in the mountains</p-uploader-data>
              <p-uploader-data key="link">https://example.com/photo1</p-uploader-data>
            </p-uploader-file>

            <p-uploader-file
              file-id="demo2"
              filename="sample2.jpg"
              preview="https://picsum.photos/200/200?random=2"
              state="uploaded">
              <p-uploader-data key="title">Urban Architecture</p-uploader-data>
              <p-uploader-data key="caption">Modern building design</p-uploader-data>
            </p-uploader-file>
          </p-uploader>
        </div>

        <div class="features__details">
          <h3>Key Features</h3>
          <ul>
            <li><strong>Field Definitions:</strong> Define fields once at parent level with type, validation, etc.</li>
            <li><strong>Inline Edit Buttons:</strong> Each field has its own small edit icon button</li>
            <li><strong>Type Validation:</strong> Supports text, textarea, url, email, etc.</li>
            <li><strong>Required Fields:</strong> Mark fields as required with validation</li>
            <li><strong>Max Length:</strong> Set character limits on fields</li>
            <li><strong>Clean HTML:</strong> No duplication of field structure in each file</li>
          </ul>
        </div>
      </section>

      <section class="demo__section" data-demo-section>
        <h2>Validation Examples</h2>
        <p>The component validates field definitions and data:</p>

        <div class="code__block">
          <pre>// Console warnings for:
- Unknown field keys
- Required fields that are empty
- Values exceeding maxlength
- Invalid URLs in url-type fields
- Missing required fields</pre>
        </div>
      </section>

      <section class="demo__section" data-demo-section>
        <h2>Field Definition Reference</h2>
        <div class="api__documentation">
          <h3>Field Attributes</h3>
          <ul>
            <li><code>key</code> (required): Unique identifier for the field</li>
            <li><code>label</code> (required): Display label for the field</li>
            <li><code>type</code>: Input type (text, textarea, url, email, etc.)</li>
            <li><code>required</code>: Boolean attribute for required validation</li>
            <li><code>maxlength</code>: Maximum character length</li>
          </ul>
        </div>
      </section>

      <section class="demo__section" data-demo-section>
        <h2>Testing Error Handling & Revert</h2>
        <p>This demo includes mock API endpoints. To test the revert functionality when server operations fail:</p>

        <div class="features__details">
          <h3>Success Mode (Current)</h3>
          <p>Currently using <code>/mock/</code> URLs which simulate successful responses:</p>
          <ul>
            <li>‚úÖ Updates will succeed and persist</li>
            <li>‚úÖ Deletes will succeed and remove files</li>
            <li>‚úÖ Sequence changes will succeed and stay reordered</li>
          </ul>

          <h3>Failure Mode</h3>
          <p>Change the URLs to <code>/mock-fail/</code> pattern to test error handling:</p>
          <div class="code__block">
            <pre><!-- Example: Test failed updates -->
&lt;p-uploader
  update-url="/mock-fail/update"
  delete-url="/mock-fail/delete"
  sequence-url="/mock-fail/sequence"
  ...&gt;</pre>
          </div>
          <p>With failure URLs:</p>
          <ul>
            <li>‚ùå Updates will revert to original values</li>
            <li>‚ùå Deletes will show error and keep the file</li>
            <li>‚ùå Sequence changes will revert to original order</li>
          </ul>
        </div>
      </section>
    </main>

    <!-- Toast container -->
    <p-toasts placement="top-right"></p-toasts>

    <!-- Mock fetch API for demo -->
    <script>
      /* Mock fetch to simulate server responses
       * Use URL pattern /mock-fail/endpoint to simulate failures
       * Use URL pattern /mock/endpoint for successful responses
       */
      const originalFetch = window.fetch;
      window.fetch = async (url, options) => {
        console.log('üîµ Mock fetch called:', url, options);

        /* Check if this is a mock request */
        const isMock = url.includes('/mock/') || url.includes('/mock-fail/');
        if (!isMock) {
          return originalFetch(url, options);
        }

        /* Simulate network delay */
        await new Promise(resolve => setTimeout(resolve, 500));

        /* Parse request body if present */
        const body = options?.body ? JSON.parse(options.body) : null;

        /* Check for failure mode */
        const shouldFail = url.includes('/mock-fail/');

        /* Mock update endpoint */
        if (url.includes('/update')) {
          console.log('üìù Update request:', body);
          if (shouldFail) {
            return new Response('Update failed: Server error', { status: 400 });
          }
          return new Response(JSON.stringify({ success: true }), {
            status: 200,
            headers: { 'Content-Type': 'application/json' }
          });
        }

        /* Mock delete endpoint */
        if (url.includes('/delete')) {
          console.log('üóëÔ∏è Delete request:', body);
          if (shouldFail) {
            return new Response('Delete not allowed', { status: 403 });
          }
          return new Response(JSON.stringify({ success: true }), {
            status: 200,
            headers: { 'Content-Type': 'application/json' }
          });
        }

        /* Mock sequence endpoint */
        if (url.includes('/sequence')) {
          console.log('üîÑ Sequence update:', body);
          if (shouldFail) {
            return new Response('Sequence update failed', { status: 500 });
          }
          return new Response(JSON.stringify({ success: true }), {
            status: 200,
            headers: { 'Content-Type': 'application/json' }
          });
        }

        /* Mock upload endpoint */
        if (url.includes('/upload')) {
          console.log('üì§ Upload request');
          if (shouldFail) {
            return new Response('Upload failed: Invalid file', { status: 400 });
          }
          return new Response(JSON.stringify({
            id: 'file_' + Date.now(),
            preview: 'https://picsum.photos/200/200?random=' + Date.now(),
            success: true
          }), {
            status: 200,
            headers: { 'Content-Type': 'application/json' }
          });
        }

        /* Default: use original fetch */
        return originalFetch(url, options);
      };
    </script>

    <!-- Load the NEW implementation -->
    <script type="module">
      import PUploader from '../src/components/PUploader.js';

      /* Wait for custom elements to be defined */
      await Promise.all([
        customElements.whenDefined('p-uploader'),
        customElements.whenDefined('p-uploader-file'),
        customElements.whenDefined('p-uploader-field'),
        customElements.whenDefined('p-uploader-data')
      ]);

      console.log('‚úÖ All uploader components loaded');
    </script>
  </body>
</html>